<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>基于springcloud框架的项目 - Daniel1n - Welcome to My Blog</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="Daniel1n" /><meta name="description" content="一、关于分布式和集群 1.1 项目结构 单体结构 一个系统业务量很小的时候所有的代码都放在一个项目中，然后部署在一台服务器上。整个项目所有的服务都由这台" /><meta name="keywords" content="Hugo, theme, even" />






<meta name="generator" content="Hugo 0.69.2 with theme even" />


<link rel="canonical" href="https://daniel1n.github.io/post/17.springcloud/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<link href="/sass/main.min.8c3cbcb0324c2bb4875ceccba4007cbad4b4ac8377f33af9953c3e7684534a50.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="基于springcloud框架的项目" />
<meta property="og:description" content="一、关于分布式和集群 1.1 项目结构 单体结构 一个系统业务量很小的时候所有的代码都放在一个项目中，然后部署在一台服务器上。整个项目所有的服务都由这台" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://daniel1n.github.io/post/17.springcloud/" />
<meta property="article:published_time" content="2020-06-16T22:33:59+08:00" />
<meta property="article:modified_time" content="2020-06-16T22:33:59+08:00" />
<meta itemprop="name" content="基于springcloud框架的项目">
<meta itemprop="description" content="一、关于分布式和集群 1.1 项目结构 单体结构 一个系统业务量很小的时候所有的代码都放在一个项目中，然后部署在一台服务器上。整个项目所有的服务都由这台">
<meta itemprop="datePublished" content="2020-06-16T22:33:59&#43;08:00" />
<meta itemprop="dateModified" content="2020-06-16T22:33:59&#43;08:00" />
<meta itemprop="wordCount" content="22088">



<meta itemprop="keywords" content="Spring Framework,SpringMVC,springboot,springcloud," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="基于springcloud框架的项目"/>
<meta name="twitter:description" content="一、关于分布式和集群 1.1 项目结构 单体结构 一个系统业务量很小的时候所有的代码都放在一个项目中，然后部署在一台服务器上。整个项目所有的服务都由这台"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Daniel1n</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">主页</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">归档</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">标签</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">分类</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Daniel1n</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">主页</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">归档</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">标签</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">分类</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">基于springcloud框架的项目</h1>

      <div class="post-meta">
        <span class="post-time"> 2020-06-16 </span>
        <div class="post-category">
            <a href="/categories/springcloud/"> springcloud </a>
            </div>
          <span class="more-meta"> 22088 words </span>
          <span class="more-meta"> 45 mins read </span>
        <span id="busuanzi_container_page_pv" class="more-meta"> <span id="busuanzi_value_page_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> times read </span>
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#11-项目结构">1.1 项目结构</a>
      <ul>
        <li><a href="#单体结构">单体结构</a></li>
        <li><a href="#集群结构">集群结构</a></li>
        <li><a href="#分布式结构">分布式结构</a></li>
      </ul>
    </li>
    <li><a href="#1-2-微服务">1. 2 微服务</a>
      <ul>
        <li><a href="#服务注册">服务注册</a></li>
        <li><a href="#服务访问">服务访问</a></li>
        <li><a href="#负载均衡服务器">负载均衡服务器</a></li>
        <li><a href="#分布式和集群周边服务">分布式和集群周边服务</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#21-在idea新建相关项目">2.1 在idea新建相关项目</a></li>
    <li><a href="#22-服务注册中心">2.2 服务注册中心</a>
      <ul>
        <li><a href="#module">module</a></li>
        <li><a href="#eurekaserverapplicationjava">EurekaServerApplication.java</a></li>
        <li><a href="#applicationyml">application.yml</a></li>
      </ul>
    </li>
    <li><a href="#23-第三方数据服务">2.3 第三方数据服务</a>
      <ul>
        <li><a href="#module-1">module</a></li>
        <li><a href="#thirdpartindexdataapplicationjava">ThirdPartIndexDataApplication.java</a></li>
        <li><a href="#applicationyml-1">application.yml</a></li>
        <li><a href="#staticindexes">static.indexes</a></li>
      </ul>
    </li>
    <li><a href="#24-采集和存储微服务">2.4 采集和存储微服务</a>
      <ul>
        <li><a href="#module-2">module</a></li>
        <li><a href="#indexgatherstoreapplicationjava">IndexGatherStoreApplication.java</a></li>
        <li><a href="#applicationyml-2">application.yml</a></li>
        <li><a href="#config">config</a></li>
        <li><a href="#job">job</a></li>
        <li><a href="#pojo">pojo</a></li>
        <li><a href="#service">service</a></li>
        <li><a href="#util">util</a></li>
        <li><a href="#web">web</a></li>
      </ul>
    </li>
    <li><a href="#25-指数代码微服务">2.5 指数代码微服务</a>
      <ul>
        <li><a href="#module-3">module</a></li>
        <li><a href="#indexcodesapplicationjava">IndexCodesApplication.java</a></li>
        <li><a href="#applicationyml-3">application.yml</a></li>
        <li><a href="#config-1">config</a></li>
        <li><a href="#pojo-1">pojo</a></li>
        <li><a href="#service-1">service</a></li>
        <li><a href="#web-1">web</a></li>
      </ul>
    </li>
    <li><a href="#26-指数数据微服务">2.6 指数数据微服务</a>
      <ul>
        <li><a href="#module-4">module</a></li>
        <li><a href="#indexdataapplicationjava">IndexDataApplication.java</a></li>
        <li><a href="#applicationyml-4">application.yml</a></li>
        <li><a href="#config-2">config</a></li>
        <li><a href="#pojo-2">pojo</a></li>
        <li><a href="#service-2">service</a></li>
        <li><a href="#web-2">web</a></li>
      </ul>
    </li>
    <li><a href="#27-网关">2.7 网关</a>
      <ul>
        <li><a href="#module-5">module</a></li>
        <li><a href="#indexzuulserviceapplicationjava">IndexZuulServiceApplication.java</a></li>
        <li><a href="#applicationyml-5">application.yml</a></li>
      </ul>
    </li>
    <li><a href="#28-模拟回测微服务">2.8 模拟回测微服务</a>
      <ul>
        <li><a href="#module-6">module</a></li>
        <li><a href="#trendtradingbacktestserviceapplication">TrendTradingBackTestServiceApplication</a></li>
        <li><a href="#applicationyml-6">application.yml</a></li>
        <li><a href="#client">client</a></li>
        <li><a href="#pojo-3">pojo</a></li>
        <li><a href="#service-3">service</a></li>
        <li><a href="#util-1">util</a></li>
        <li><a href="#web-3">web</a></li>
      </ul>
    </li>
    <li><a href="#29-模拟回测视图微服务">2.9 模拟回测视图微服务</a>
      <ul>
        <li><a href="#module-7">module</a></li>
        <li><a href="#trendtradingbacktestviewapplication">TrendTradingBackTestViewApplication</a></li>
        <li><a href="#bootstrapyml">bootstrap.yml</a></li>
        <li><a href="#applicationyml-7">application.yml</a></li>
        <li><a href="#static">static</a></li>
        <li><a href="#templates">templates</a></li>
        <li><a href="#util-2">util</a></li>
        <li><a href="#web-4">web</a></li>
      </ul>
    </li>
    <li><a href="#210-配置服务器">2.10 配置服务器</a>
      <ul>
        <li><a href="#module-8">module</a></li>
        <li><a href="#indexconfigserverapplication">IndexConfigServerApplication</a></li>
        <li><a href="#applicationyml-8">application.yml</a></li>
      </ul>
    </li>
    <li><a href="#211-断路器监控">2.11 断路器监控</a>
      <ul>
        <li><a href="#module-9">module</a></li>
        <li><a href="#indexhystrixdashboardapplication">IndexHystrixDashboardApplication</a></li>
        <li><a href="#applicationyml-9">application.yml</a></li>
      </ul>
    </li>
    <li><a href="#212-断路器聚合监控">2.12 断路器聚合监控</a>
      <ul>
        <li><a href="#module-10">module</a></li>
        <li><a href="#indexturbineapplication">IndexTurbineApplication</a></li>
        <li><a href="#applicationyml-10">application.yml</a></li>
      </ul>
    </li>
    <li><a href="#213-运行整个项目">2.13 运行整个项目</a></li>
  </ul>

  <ul>
    <li><a href="#分布式和集群的优缺点">分布式和集群的优缺点</a></li>
    <li><a href="#微服务的端口">微服务的端口</a></li>
    <li><a href="#技术总结">技术总结</a></li>
    <li><a href="#个人总结">个人总结</a></li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h1 id="一关于分布式和集群">一、关于分布式和集群</h1>
<h2 id="11-项目结构">1.1 项目结构</h2>
<h3 id="单体结构">单体结构</h3>
<p>一个系统业务量很小的时候所有的代码都放在一个项目中，然后部署在一台服务器上。整个项目所有的服务都由这台服务器提供。这就是单机结构。</p>
<p>缺点：</p>
<blockquote>
<ol>
<li>如果要修改数据部分的代码， 那么必须把整个项目重新编译打包部署。 虽然展示部分，什么都没变但是也会因为重新部署而暂时不能使用，要部署完了，才能使用。</li>
<li>如果提供数据部分出现了问题，比如有的开发人员改错了，抛出了异常，会导致整个项目不能使用，展示数据部分也因此受到影响。</li>
<li>性能瓶颈难以突破</li>
</ol>
</blockquote>
<h3 id="集群结构">集群结构</h3>
<p>单机处理到达瓶颈的时候，就把单机复制几份，这样就构成了一个“集群”。集群中每台服务器就叫做这个集群的一个“节点”，所有节点构成了一个集群。每个节点都提供相同的服务，那么这样系统的处理能力就相当于提升了好几倍（有几个节点就相当于提升了这么多倍）。</p>
<p>但问题是用户的请求究竟由哪个节点来处理呢？最好能够让此时此刻负载较小的节点来处理，这样使得每个节点的压力都比较平均。要实现这个功能，就需要在所有节点之前增加一个“调度者”的角色，用户的所有请求都先交给它，然后它根据当前所有节点的负载情况，决定将这个请求交给哪个节点处理。这个“调度者”有个牛逼了名字——<code>负载均衡服务器</code>。</p>
<p>集群结构的好处就是系统扩展非常容易。如果随着你们系统业务的发展，当前的系统又支撑不住了，那么给这个集群再增加节点就行了。但是，当业务发展到一定程度的时候，会发现一个问题——无论怎么增加节点，貌似整个集群性能的提升效果并不明显了。这时候，你就需要使用<code>微服务结构</code>了。</p>
<h3 id="分布式结构">分布式结构</h3>
<p>从单机结构到集群结构，代码基本无需要作任何修改，要做的仅仅是多部署几台服务器，每台服务器上运行相同的代码就行了。但是，当要从集群结构演进到微服务结构的时候，之前的那套代码就需要发生较大的改动了。所以对于新系统建议，系统设计之初就采用微服务架构，这样后期运维的成本更低。但如果一套老系统需要升级成微服务结构的话，那就得对代码大动干戈了。</p>
<p>分布式结构就是将一个完整的系统，按照业务功能，拆分成一个个独立的子系统，在分布式结构中，每个子系统就被称为“服务”。这些子系统能够独立运行在web容器中，它们之间通过<code>RPC方式</code>通信。</p>
<p>举个例子，假设需要开发一个在线商城。按照微服务的思想，我们需要按照功能模块拆分成多个独立的服务，如：用户服务、产品服务、订单服务、后台管理服务、数据分析服务等等。这一个个服务都是一个个独立的项目，可以独立运行。如果服务之间有依赖关系，那么通过RPC方式调用。</p>
<p>好处：</p>
<blockquote>
<ol>
<li>低耦合。系统之间的耦合度大大降低，可以独立开发、独立部署、独立测试，系统与系统之间的边界非常明确，排错也变得相当容易，开发效率大大提升。</li>
<li>高内聚。系统之间的耦合度降低，从而系统更易于扩展。我们可以针对性地扩展某些服务。假设这个商城要搞一次大促，下单量可能会大大提升，因此我们可以针对性地提升订单系统、产品系统的节点数量，而对于后台管理系统、数据分析系统而言，节点数量维持原有水平即可。</li>
<li>高可用。服务的复用性更高。比如，当我们将用户系统作为单独的服务后，该公司所有的产品都可以使用该系统作为用户系统，无需重复开发。</li>
</ol>
</blockquote>
<p>作者：大闲人柴毛毛
链接：https://www.zhihu.com/question/20004877/answer/282033178
来源：知乎</p>
<h2 id="1-2-微服务">1. 2 微服务</h2>
<p>微服务简单说，一个 springboot 就是一个 微服务，并且这个 springboot 做的事情很单纯。 比如 product-service 这个项目，就可以拆成两个微服务，分别是 数据微服务，和视图微服务，其实就是俩 springboot, 只是各自做的事情都更单纯。</p>
<h3 id="服务注册">服务注册</h3>
<p>那么有了微服务，就存在如何管理这个微服务，以及这两个微服务之间如何通信的问题，所以就要引入一个 微服务注册中心概念，这个微服务注册中心在 springcloud 里就叫做 eureka server, 通过它把就可以把微服务注册起来，以供将来调用。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-xml" data-lang="xml"><span class="nt">&lt;dependencies&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;/dependencies&gt;</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="服务访问">服务访问</h3>
<p>在业务逻辑上， 视图微服务 需要 数据微服务 的数据，所以就存在一个微服务访问另一个微服务的需要。
而这俩微服务已经被注册中心管理起来了，所以  视图微服务 就可以通过 注册中心定位并访问 数据微服务了。</p>
<h3 id="负载均衡服务器">负载均衡服务器</h3>
<p>springcloud 提供了两种方式，一种是 Ribbon，一种是 Feign。</p>
<blockquote>
<p>Ribbon 是使用 restTemplate 进行调用，并进行客户端负载均衡。Ribbon 会从注册中心获知这个信息，然后由 Ribbon 这个客户端自己决定是调用哪个，这个就叫做客户端负载均衡。</p>
<p>Feign 是对 Ribbon的封装</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-xml" data-lang="xml"><span class="nt">&lt;dependencies&gt;</span>		
	<span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-openfeign<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;/dependencies&gt;</span>    
</code></pre></td></tr></table>
</div>
</div><h3 id="分布式和集群周边服务">分布式和集群周边服务</h3>
<ol>
<li>哪些微服务是如何彼此调用的？ <code>zipkin</code> 服务链路追踪服务器</li>
<li>如何在微服务间共享配置信息？配置服务 <code>Config Server</code></li>
<li>如何让配置信息在多个微服务之间自动刷新？ <code>RabbitMQ</code> 总线 Bus</li>
<li>如果数据微服务集群都不能使用了， 视图微服务如何去处理? 断路器 <code>Hystrix</code></li>
<li>视图微服务的断路器什么时候开启了？什么时候关闭了？ 断路器监控 <code>Hystrix Dashboard</code></li>
<li>如果视图微服务本身是个集群，那么如何进行对他们进行聚合监控？ 断路器聚合监控 <code>Turbine Hystrix Dashboard</code></li>
<li>如何不暴露微服务名称，并提供服务？ <code>Zuul</code> 网关</li>
</ol>
<h1 id="二-趋势投资项目">二 、趋势投资项目</h1>
<p><img src="https://stepimagewm.how2j.cn/9883.png" alt="拓扑图点亮    "></p>
<p><img src="/media/20200616232738.png" alt="20200616232738"></p>
<h2 id="21-在idea新建相关项目">2.1 在idea新建相关项目</h2>
<ul>
<li>maven一个项目</li>
</ul>
<p><img src="/media/20200616230759.png" alt="20200616230759"></p>
<p><img src="/media/20200616231037.png" alt="20200616231037"></p>
<ul>
<li>然后删除src文件，只保留pom.xml</li>
</ul>
<p><img src="/media/20200616231232.png" alt="20200616231232"></p>
<ul>
<li>修改pom.xml文件，关键是把packaging方式，改为pom打包</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-xml" data-lang="xml"><span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>

<span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0&#34;</span> <span class="na">xmlns:xsi=</span><span class="s">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
         <span class="na">xsi:schemaLocation=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&#34;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>

    <span class="nt">&lt;groupId&gt;</span>cn.qqlin.trend<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>trendParentProject<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
    
    <span class="c">&lt;!--微服务架构下的子项目--&gt;</span>
    <span class="nt">&lt;modules&gt;</span>
        <span class="nt">&lt;module&gt;</span>eureka-server<span class="nt">&lt;/module&gt;</span>
        <span class="nt">&lt;module&gt;</span>third-part-index-data-project<span class="nt">&lt;/module&gt;</span>
        <span class="nt">&lt;module&gt;</span>index-gather-store-service<span class="nt">&lt;/module&gt;</span>
        <span class="nt">&lt;module&gt;</span>index-codes-service<span class="nt">&lt;/module&gt;</span>
        <span class="nt">&lt;module&gt;</span>index-data-service<span class="nt">&lt;/module&gt;</span>
        <span class="nt">&lt;module&gt;</span>index-zuul-service<span class="nt">&lt;/module&gt;</span>
        <span class="nt">&lt;module&gt;</span>trend-trading-backtest-service<span class="nt">&lt;/module&gt;</span>
        <span class="nt">&lt;module&gt;</span>trend-trading-backtest-view<span class="nt">&lt;/module&gt;</span>
        <span class="nt">&lt;module&gt;</span>index-config-server<span class="nt">&lt;/module&gt;</span>
        <span class="nt">&lt;module&gt;</span>index-hystrix-dashboard<span class="nt">&lt;/module&gt;</span>
        <span class="nt">&lt;module&gt;</span>index-turbine<span class="nt">&lt;/module&gt;</span>
    <span class="nt">&lt;/modules&gt;</span>

    <span class="nt">&lt;packaging&gt;</span>pom<span class="nt">&lt;/packaging&gt;</span>

    <span class="nt">&lt;parent&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-parent<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>2.0.3.RELEASE<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;relativePath/&gt;</span>
    <span class="nt">&lt;/parent&gt;</span>

    <span class="nt">&lt;properties&gt;</span>
        <span class="nt">&lt;project.build.sourceEncoding&gt;</span>UTF-8<span class="nt">&lt;/project.build.sourceEncoding&gt;</span>
        <span class="nt">&lt;project.reporting.outputEncoding&gt;</span>UTF-8<span class="nt">&lt;/project.reporting.outputEncoding&gt;</span>
        <span class="nt">&lt;java.version&gt;</span>1.8<span class="nt">&lt;/java.version&gt;</span>
        <span class="nt">&lt;spring-cloud.version&gt;</span>Finchley.RELEASE<span class="nt">&lt;/spring-cloud.version&gt;</span>
    <span class="nt">&lt;/properties&gt;</span>

    <span class="nt">&lt;dependencies&gt;</span>
        
        <span class="c">&lt;!--springboot--&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-test<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!--Hutool是一个Java基础工具类，对文件、流、加密解密、转码、正则、线程、XML等JDK方法进行封装，组成各种Util工具类--&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>cn.hutool<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>hutool-all<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>4.3.1<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!-- 引入配置文件--&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-configuration-processor<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;optional&gt;</span>true<span class="nt">&lt;/optional&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        
    <span class="nt">&lt;/dependencies&gt;</span>

    <span class="nt">&lt;dependencyManagement&gt;</span>
        <span class="nt">&lt;dependencies&gt;</span>
            <span class="nt">&lt;dependency&gt;</span>
                <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
                <span class="nt">&lt;artifactId&gt;</span>spring-cloud-dependencies<span class="nt">&lt;/artifactId&gt;</span>
                <span class="nt">&lt;version&gt;</span>${spring-cloud.version}<span class="nt">&lt;/version&gt;</span>
                <span class="nt">&lt;type&gt;</span>pom<span class="nt">&lt;/type&gt;</span>
                <span class="nt">&lt;scope&gt;</span>import<span class="nt">&lt;/scope&gt;</span>
            <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;/dependencies&gt;</span>
    <span class="nt">&lt;/dependencyManagement&gt;</span>

<span class="nt">&lt;/project&gt;</span>

</code></pre></td></tr></table>
</div>
</div><h2 id="22-服务注册中心">2.2 服务注册中心</h2>
<h3 id="module">module</h3>
<p>新建一个module，命名为eureka-server，修改pom.xml为</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-xml" data-lang="xml"><span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>

<span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0&#34;</span> <span class="na">xmlns:xsi=</span><span class="s">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
         <span class="na">xsi:schemaLocation=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&#34;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;parent&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>trendParentProject<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>cn.qqlin.trend<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/parent&gt;</span>
    <span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>

    <span class="nt">&lt;artifactId&gt;</span>eureka-server<span class="nt">&lt;/artifactId&gt;</span>

    <span class="nt">&lt;dependencies&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;/dependencies&gt;</span>

<span class="nt">&lt;/project&gt;</span>

</code></pre></td></tr></table>
</div>
</div><h3 id="eurekaserverapplicationjava">EurekaServerApplication.java</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">cn.qqlin.trend</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">cn.hutool.core.util.NetUtil</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.autoconfigure.SpringBootApplication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.builder.SpringApplicationBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cloud.netflix.eureka.server.EnableEurekaServer</span><span class="o">;</span>

<span class="cm">/**
</span><span class="cm"> * @author qqlin
</span><span class="cm"> * @date 2020-6-13 10:16
</span><span class="cm"> */</span>
<span class="nd">@SpringBootApplication</span>
<span class="nd">@EnableEurekaServer</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EurekaServerApplication</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 8761 这个端口是默认的，后面的子项目，都会访问这个端口
</span><span class="c1"></span>        <span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="n">8761</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">NetUtil</span><span class="o">.</span><span class="na">isUsableLocalPort</span><span class="o">(</span><span class="n">port</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">&#34;端口%d被占用，无法启动%n&#34;</span><span class="o">,</span> <span class="n">port</span><span class="o">);</span>
            <span class="n">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">new</span> <span class="n">SpringApplicationBuilder</span><span class="o">(</span><span class="n">EurekaServerApplication</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                <span class="o">.</span><span class="na">properties</span><span class="o">(</span><span class="s">&#34;server.port=&#34;</span> <span class="o">+</span> <span class="n">port</span><span class="o">)</span>
                <span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><h3 id="applicationyml">application.yml</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yml" data-lang="yml"><span class="k">spring</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">application</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="c"># 表示这个微服务本身的名称</span><span class="w">
</span><span class="w">    </span><span class="k">name</span><span class="p">:</span><span class="w"> </span>eureka-server<span class="w">
</span><span class="w">
</span><span class="w"></span><span class="k">eureka</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">instance</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="c"># 表示主机名称。</span><span class="w">
</span><span class="w">    </span><span class="k">hostname</span><span class="p">:</span><span class="w"> </span>localhost<span class="w">
</span><span class="w">  </span><span class="k">client</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="c"># 表示是否注册到服务器。 因为它本身就是服务器，所以就无需把自己注册到服务器了。</span><span class="w">
</span><span class="w">    </span><span class="k">register-with-eureka</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span><span class="w">    </span><span class="c"># 表示是否获取服务器的注册信息，和上面同理，这里也设置为 false。</span><span class="w">
</span><span class="w">    </span><span class="k">fetch-registry</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span><span class="w">    </span><span class="c"># 自己作为服务器，公布出来的地址。</span><span class="w">
</span><span class="w">    </span><span class="c"># 比如后续某个微服务要把自己注册到 eureka server, 那么就要使用这个地址： http://localhost:8761/eureka/</span><span class="w">
</span><span class="w">    </span><span class="k">service-url</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="k">defaultZone</span><span class="p">:</span><span class="w"> </span>http<span class="p">:</span>//${eureka.instance.hostname}<span class="p">:</span>${server.port}/eureka/<span class="w">
</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>运行 EurekaServerApplication，并访问：
http://127.0.0.1:8761/</p>
<p>这就是注册中心的管理界面，主要看 ：Instances currently registered with Eureka</p>
<h2 id="23-第三方数据服务">2.3 第三方数据服务</h2>
<h3 id="module-1">module</h3>
<p>新建一个module，命名为third-part-index-data-project，修改pom.xml为</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-xml" data-lang="xml"><span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>

<span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0&#34;</span> <span class="na">xmlns:xsi=</span><span class="s">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
         <span class="na">xsi:schemaLocation=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&#34;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;parent&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>trendParentProject<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>cn.qqlin.trend<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/parent&gt;</span>
    <span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>

    <span class="nt">&lt;artifactId&gt;</span>third-part-index-data-project<span class="nt">&lt;/artifactId&gt;</span>

    <span class="nt">&lt;dependencies&gt;</span>
        <span class="c">&lt;!--spring mvc--&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-web<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!-- eureka-client --&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;/dependencies&gt;</span>
<span class="nt">&lt;/project&gt;</span>

</code></pre></td></tr></table>
</div>
</div><h3 id="thirdpartindexdataapplicationjava">ThirdPartIndexDataApplication.java</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">cn.qqlin.trend</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">cn.hutool.core.convert.Convert</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">cn.hutool.core.util.NetUtil</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">cn.hutool.core.util.NumberUtil</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">cn.hutool.core.util.StrUtil</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.autoconfigure.SpringBootApplication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.builder.SpringApplicationBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cloud.netflix.eureka.EnableEurekaClient</span><span class="o">;</span>

<span class="cm">/**
</span><span class="cm"> * @author qqlin
</span><span class="cm"> * @date 2020-6-13 10:31
</span><span class="cm"> */</span>
<span class="nd">@SpringBootApplication</span>
<span class="nd">@EnableEurekaClient</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ThirdPartIndexDataApplication</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="n">8090</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">eurekaServerPort</span> <span class="o">=</span> <span class="n">8761</span><span class="o">;</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">NetUtil</span><span class="o">.</span><span class="na">isUsableLocalPort</span><span class="o">(</span><span class="n">eurekaServerPort</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">&#34;检查到端口%d 未启用，判断eureka服务器没有启动，本地服务无法使用，故退出%n&#34;</span><span class="o">,</span> <span class="n">eurekaServerPort</span><span class="o">);</span>
            <span class="n">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="cm">/**
</span><span class="cm">         * 这一段就表示启动的时候如果带了参数，
</span><span class="cm">         * 如： port=8099, 那么程序就会使用 8099 作为端口号了。
</span><span class="cm">         * 这样做的好处是，什么代码都不用改，只需要在启动的时候带不同的参数，就可以启动不同的端口了。
</span><span class="cm">         */</span>
        <span class="k">if</span> <span class="o">(</span><span class="kc">null</span> <span class="o">!=</span> <span class="n">args</span> <span class="o">&amp;&amp;</span> <span class="n">0</span> <span class="o">!=</span> <span class="n">args</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">arg</span> <span class="o">:</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">arg</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">&#34;port=&#34;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">String</span> <span class="n">strPort</span> <span class="o">=</span> <span class="n">StrUtil</span><span class="o">.</span><span class="na">subAfter</span><span class="o">(</span><span class="n">arg</span><span class="o">,</span> <span class="s">&#34;port=&#34;</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">NumberUtil</span><span class="o">.</span><span class="na">isNumber</span><span class="o">(</span><span class="n">strPort</span><span class="o">))</span> <span class="o">{</span>
                        <span class="n">port</span> <span class="o">=</span> <span class="n">Convert</span><span class="o">.</span><span class="na">toInt</span><span class="o">(</span><span class="n">strPort</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(!</span><span class="n">NetUtil</span><span class="o">.</span><span class="na">isUsableLocalPort</span><span class="o">(</span><span class="n">port</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">&#34;端口%d被占用了，无法启动%n&#34;</span><span class="o">,</span> <span class="n">port</span><span class="o">);</span>
            <span class="n">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">new</span> <span class="n">SpringApplicationBuilder</span><span class="o">(</span><span class="n">ThirdPartIndexDataApplication</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                <span class="o">.</span><span class="na">properties</span><span class="o">(</span><span class="s">&#34;server.port=&#34;</span> <span class="o">+</span> <span class="n">port</span><span class="o">)</span>
                <span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><h3 id="applicationyml-1">application.yml</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yml" data-lang="yml"><span class="k">spring</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">application</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">name</span><span class="p">:</span><span class="w"> </span>third-part-index-data-project<span class="w">
</span><span class="w">
</span><span class="w"></span><span class="k">eureka</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">client</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">service-url</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="k">defaultZone</span><span class="p">:</span><span class="w"> </span>http<span class="p">:</span>//localhost<span class="p">:</span><span class="m">8761</span>/eureka/<span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h3 id="staticindexes">static.indexes</h3>
<p>存放需要的第三方的json数据，将其采集到服务器，然后在服务器的redis中保存</p>
<p>最后，运行启动类：ThirdPartIndexDataApplication
访问如下地址：</p>
<p>http://127.0.0.1:8090/indexes/codes.json</p>
<h2 id="24-采集和存储微服务">2.4 采集和存储微服务</h2>
<h3 id="module-2">module</h3>
<p>新建一个module，命名为index-gather-store-service，修改pom.xml为</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-xml" data-lang="xml"><span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>

<span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0&#34;</span> <span class="na">xmlns:xsi=</span><span class="s">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
         <span class="na">xsi:schemaLocation=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&#34;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>

    <span class="nt">&lt;parent&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>trendParentProject<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>cn.qqlin.trend<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/parent&gt;</span>

    <span class="nt">&lt;artifactId&gt;</span>index-gather-store-service<span class="nt">&lt;/artifactId&gt;</span>

    <span class="nt">&lt;dependencies&gt;</span>
        <span class="c">&lt;!-- springboot web --&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-web<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!-- eureka-client --&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!-- 断路器 --&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-hystrix<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!-- redis --&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-data-redis<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!-- 定时器 --&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-quartz<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;/dependencies&gt;</span>

    <span class="nt">&lt;build&gt;</span>
        <span class="nt">&lt;plugins&gt;</span>
            <span class="nt">&lt;plugin&gt;</span>
                <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
                <span class="nt">&lt;artifactId&gt;</span>spring-boot-maven-plugin<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;/plugin&gt;</span>
        <span class="nt">&lt;/plugins&gt;</span>
    <span class="nt">&lt;/build&gt;</span>

<span class="nt">&lt;/project&gt;</span>

</code></pre></td></tr></table>
</div>
</div><h3 id="indexgatherstoreapplicationjava">IndexGatherStoreApplication.java</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">cn.qqlin.trend</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">cn.hutool.core.convert.Convert</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">cn.hutool.core.util.NetUtil</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">cn.hutool.core.util.NumberUtil</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">cn.hutool.core.util.StrUtil</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.autoconfigure.SpringBootApplication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.builder.SpringApplicationBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cache.annotation.EnableCaching</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cloud.netflix.eureka.EnableEurekaClient</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cloud.netflix.hystrix.EnableHystrix</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.client.RestTemplate</span><span class="o">;</span>

<span class="cm">/**
</span><span class="cm"> * @author qqlin
</span><span class="cm"> * @date 2020-6-13 11:08
</span><span class="cm"> */</span>
<span class="nd">@SpringBootApplication</span>
<span class="nd">@EnableEurekaClient</span>
<span class="nd">@EnableHystrix</span>
<span class="nd">@EnableCaching</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">IndexGatherStoreApplication</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">defaultPort</span> <span class="o">=</span> <span class="n">8001</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">eurekaServerPort</span> <span class="o">=</span> <span class="n">8761</span><span class="o">;</span>
        <span class="n">port</span> <span class="o">=</span> <span class="n">defaultPort</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">redisPort</span> <span class="o">=</span> <span class="n">6379</span><span class="o">;</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">NetUtil</span><span class="o">.</span><span class="na">isUsableLocalPort</span><span class="o">(</span><span class="n">eurekaServerPort</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">&#34;检查到端口%d 未启用，判断 eureka 服务器没有启动，故退出%n&#34;</span><span class="o">,</span> <span class="n">eurekaServerPort</span><span class="o">);</span>
            <span class="n">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">NetUtil</span><span class="o">.</span><span class="na">isUsableLocalPort</span><span class="o">(</span><span class="n">redisPort</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">&#34;检查到端口%d 未启用，判断 redis 服务器没有启动，故退出%n&#34;</span><span class="o">,</span> <span class="n">redisPort</span><span class="o">);</span>
            <span class="n">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="kc">null</span> <span class="o">!=</span> <span class="n">args</span> <span class="o">&amp;&amp;</span> <span class="n">0</span> <span class="o">!=</span> <span class="n">args</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">arg</span> <span class="o">:</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">arg</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">&#34;port=&#34;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">String</span> <span class="n">strPort</span> <span class="o">=</span> <span class="n">StrUtil</span><span class="o">.</span><span class="na">subAfter</span><span class="o">(</span><span class="n">arg</span><span class="o">,</span> <span class="s">&#34;port=&#34;</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">NumberUtil</span><span class="o">.</span><span class="na">isNumber</span><span class="o">(</span><span class="n">strPort</span><span class="o">))</span> <span class="o">{</span>
                        <span class="n">port</span> <span class="o">=</span> <span class="n">Convert</span><span class="o">.</span><span class="na">toInt</span><span class="o">(</span><span class="n">strPort</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(!</span><span class="n">NetUtil</span><span class="o">.</span><span class="na">isUsableLocalPort</span><span class="o">(</span><span class="n">port</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">&#34;端口%d被占用了，无法启动%n&#34;</span><span class="o">,</span> <span class="n">port</span><span class="o">);</span>
            <span class="n">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">new</span> <span class="n">SpringApplicationBuilder</span><span class="o">(</span><span class="n">IndexGatherStoreApplication</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                <span class="o">.</span><span class="na">properties</span><span class="o">(</span><span class="s">&#34;server.port=&#34;</span> <span class="o">+</span> <span class="n">port</span><span class="o">)</span>
                <span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="n">RestTemplate</span> <span class="nf">restTemplate</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">RestTemplate</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><h3 id="applicationyml-2">application.yml</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yml" data-lang="yml"><span class="k">spring</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">application</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">name</span><span class="p">:</span><span class="w"> </span>index-gather-store-service<span class="w">
</span><span class="w">
</span><span class="w"></span><span class="k">eureka</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">client</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">service-url</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="k">defaultZone</span><span class="p">:</span><span class="w"> </span>http<span class="p">:</span>//localhost<span class="p">:</span><span class="m">8761</span>/eureka/<span class="w">
</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h3 id="config">config</h3>
<p>定时设置QuartzConfiguration.java</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">cn.qqlin.trend.config</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">cn.qqlin.trend.job.IndexDataSyncJob</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.quartz.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>

<span class="cm">/**
</span><span class="cm"> * 定时器设置
</span><span class="cm"> *
</span><span class="cm"> * @author qqlin
</span><span class="cm"> * @date 2020-6-13 22:08
</span><span class="cm"> */</span>
<span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">QuartzConfiguration</span> <span class="o">{</span>

    <span class="cm">/**
</span><span class="cm">     * 设置为1分钟
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">interval</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="n">JobDetail</span> <span class="nf">weatherDataSyncJobDetail</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">JobBuilder</span><span class="o">.</span><span class="na">newJob</span><span class="o">(</span><span class="n">IndexDataSyncJob</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                <span class="o">.</span><span class="na">withIdentity</span><span class="o">(</span><span class="s">&#34;indexDataSyncJob&#34;</span><span class="o">)</span>
                <span class="o">.</span><span class="na">storeDurably</span><span class="o">()</span>
                <span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="n">Trigger</span> <span class="nf">weatherDataSyncTrigger</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">SimpleScheduleBuilder</span> <span class="n">scheduleBuilder</span> <span class="o">=</span> <span class="n">SimpleScheduleBuilder</span>
                <span class="o">.</span><span class="na">simpleSchedule</span><span class="o">()</span>
                <span class="o">.</span><span class="na">withIntervalInMinutes</span><span class="o">(</span><span class="n">interval</span><span class="o">)</span>
                <span class="o">.</span><span class="na">repeatForever</span><span class="o">();</span>

        <span class="k">return</span> <span class="n">TriggerBuilder</span><span class="o">.</span><span class="na">newTrigger</span><span class="o">().</span><span class="na">forJob</span><span class="o">(</span><span class="n">weatherDataSyncJobDetail</span><span class="o">())</span>
                <span class="o">.</span><span class="na">withIdentity</span><span class="o">(</span><span class="s">&#34;indexDataSyncTrigger&#34;</span><span class="o">)</span>
                <span class="o">.</span><span class="na">withSchedule</span><span class="o">(</span><span class="n">scheduleBuilder</span><span class="o">)</span>
                <span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><p>redis设置RedisCacheConfig.java</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">cn.qqlin.trend.config</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.fasterxml.jackson.annotation.JsonAutoDetect</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.fasterxml.jackson.annotation.PropertyAccessor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.fasterxml.jackson.databind.ObjectMapper</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.context.properties.ConfigurationProperties</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cache.CacheManager</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.redis.cache.RedisCacheConfiguration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.redis.cache.RedisCacheManager</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.redis.connection.RedisConnectionFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.redis.serializer.Jackson2JsonRedisSerializer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.redis.serializer.RedisSerializationContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.redis.serializer.RedisSerializer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.redis.serializer.StringRedisSerializer</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.time.Duration</span><span class="o">;</span>

<span class="cm">/**
</span><span class="cm"> * redis缓存设置
</span><span class="cm"> *
</span><span class="cm"> * @author qqlin
</span><span class="cm"> * @date 2020-6-13 15:27
</span><span class="cm"> */</span>
<span class="nd">@Configuration</span>
<span class="nd">@ConfigurationProperties</span><span class="o">(</span><span class="n">prefix</span> <span class="o">=</span> <span class="s">&#34;spring.cache.redis&#34;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RedisCacheConfig</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="n">Duration</span> <span class="n">timeToLive</span> <span class="o">=</span> <span class="n">Duration</span><span class="o">.</span><span class="na">ZERO</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTimeToLive</span><span class="o">(</span><span class="n">Duration</span> <span class="n">timeToLive</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">timeToLive</span> <span class="o">=</span> <span class="n">timeToLive</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="n">CacheManager</span> <span class="nf">cacheManager</span><span class="o">(</span><span class="n">RedisConnectionFactory</span> <span class="n">factory</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">RedisSerializer</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">redisSerializer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringRedisSerializer</span><span class="o">();</span>

        <span class="n">Jackson2JsonRedisSerializer</span> <span class="n">jackson2JsonRedisSerializer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Jackson2JsonRedisSerializer</span><span class="o">(</span><span class="n">Object</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

        <span class="c1">// 解决查询缓存转换异常的问题
</span><span class="c1"></span>        <span class="n">ObjectMapper</span> <span class="n">objectMapper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectMapper</span><span class="o">();</span>
        <span class="n">objectMapper</span><span class="o">.</span><span class="na">setVisibility</span><span class="o">(</span><span class="n">PropertyAccessor</span><span class="o">.</span><span class="na">ALL</span><span class="o">,</span> <span class="n">JsonAutoDetect</span><span class="o">.</span><span class="na">Visibility</span><span class="o">.</span><span class="na">PUBLIC_ONLY</span><span class="o">);</span>
        <span class="n">objectMapper</span><span class="o">.</span><span class="na">enableDefaultTyping</span><span class="o">(</span><span class="n">ObjectMapper</span><span class="o">.</span><span class="na">DefaultTyping</span><span class="o">.</span><span class="na">NON_FINAL</span><span class="o">);</span>
        <span class="n">jackson2JsonRedisSerializer</span><span class="o">.</span><span class="na">setObjectMapper</span><span class="o">(</span><span class="n">objectMapper</span><span class="o">);</span>

        <span class="c1">// 配置序列化（解决乱码的问题）
</span><span class="c1"></span>        <span class="n">RedisCacheConfiguration</span> <span class="n">configuration</span> <span class="o">=</span> <span class="n">RedisCacheConfiguration</span><span class="o">.</span><span class="na">defaultCacheConfig</span><span class="o">()</span>
                <span class="o">.</span><span class="na">entryTtl</span><span class="o">(</span><span class="n">timeToLive</span><span class="o">)</span>
                <span class="o">.</span><span class="na">serializeKeysWith</span><span class="o">(</span><span class="n">RedisSerializationContext</span><span class="o">.</span><span class="na">SerializationPair</span><span class="o">.</span><span class="na">fromSerializer</span><span class="o">(</span><span class="n">redisSerializer</span><span class="o">))</span>
                <span class="o">.</span><span class="na">serializeValuesWith</span><span class="o">(</span><span class="n">RedisSerializationContext</span><span class="o">.</span><span class="na">SerializationPair</span><span class="o">.</span><span class="na">fromSerializer</span><span class="o">(</span><span class="n">jackson2JsonRedisSerializer</span><span class="o">))</span>
                <span class="o">.</span><span class="na">disableCachingNullValues</span><span class="o">();</span>

        <span class="n">RedisCacheManager</span> <span class="n">redisCacheManager</span> <span class="o">=</span> <span class="n">RedisCacheManager</span><span class="o">.</span><span class="na">builder</span><span class="o">(</span><span class="n">factory</span><span class="o">)</span>
                <span class="o">.</span><span class="na">cacheDefaults</span><span class="o">(</span><span class="n">configuration</span><span class="o">)</span>
                <span class="o">.</span><span class="na">build</span><span class="o">();</span>

        <span class="k">return</span> <span class="n">redisCacheManager</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><h3 id="job">job</h3>
<p>定时器IndexDataSyncJob.java</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">cn.qqlin.trend.job</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">cn.qqlin.trend.pojo.Index</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">cn.qqlin.trend.service.IndexDataService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">cn.qqlin.trend.service.IndexService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">cn.hutool.core.date.DateUtil</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.quartz.JobExecutionContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.quartz.JobExecutionException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.scheduling.quartz.QuartzJobBean</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="cm">/**
</span><span class="cm"> * 定时器
</span><span class="cm"> *
</span><span class="cm"> * @author qqlin
</span><span class="cm"> * @date 2020-6-13 22:04
</span><span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">IndexDataSyncJob</span> <span class="kd">extends</span> <span class="n">QuartzJobBean</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">IndexService</span> <span class="n">indexService</span><span class="o">;</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">IndexDataService</span> <span class="n">indexDataService</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">executeInternal</span><span class="o">(</span><span class="n">JobExecutionContext</span> <span class="n">jobExecutionContext</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">JobExecutionException</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;定时启动：&#34;</span> <span class="o">+</span> <span class="n">DateUtil</span><span class="o">.</span><span class="na">now</span><span class="o">());</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Index</span><span class="o">&gt;</span> <span class="n">indexes</span> <span class="o">=</span> <span class="n">indexService</span><span class="o">.</span><span class="na">fresh</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">Index</span> <span class="n">index</span> <span class="o">:</span> <span class="n">indexes</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">indexDataService</span><span class="o">.</span><span class="na">fresh</span><span class="o">(</span><span class="n">index</span><span class="o">.</span><span class="na">getCode</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;定期结束：&#34;</span> <span class="o">+</span> <span class="n">DateUtil</span><span class="o">.</span><span class="na">now</span><span class="o">());</span>

    <span class="o">}</span>
<span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><h3 id="pojo">pojo</h3>
<p>Index.java</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">cn.qqlin.trend.pojo</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>

<span class="cm">/**
</span><span class="cm"> * @author qqlin
</span><span class="cm"> * @date 2020-6-13 10:52
</span><span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Index</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="n">3826678036589053087L</span><span class="o">;</span>

    <span class="cm">/**
</span><span class="cm">     * 证券的代码
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">code</span><span class="o">;</span>

    <span class="cm">/**
</span><span class="cm">     * 证券的名称
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getCode</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">code</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setCode</span><span class="o">(</span><span class="n">String</span> <span class="n">code</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">code</span> <span class="o">=</span> <span class="n">code</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">name</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setName</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><p>IndexData.java</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">cn.qqlin.trend.pojo</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>

<span class="cm">/**
</span><span class="cm"> * @author qqlin
</span><span class="cm"> * @date 2020-6-13 16:35
</span><span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">IndexData</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="o">-</span><span class="n">9511000068712106L</span><span class="o">;</span>

    <span class="cm">/**
</span><span class="cm">     * 数据的日期
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">date</span><span class="o">;</span>

    <span class="cm">/**
</span><span class="cm">     * 收盘点
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kt">float</span> <span class="n">closePoint</span><span class="o">;</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getDate</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">date</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setDate</span><span class="o">(</span><span class="n">String</span> <span class="n">date</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">date</span> <span class="o">=</span> <span class="n">date</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">float</span> <span class="nf">getClosePoint</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">closePoint</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setClosePoint</span><span class="o">(</span><span class="kt">float</span> <span class="n">closePoint</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">closePoint</span> <span class="o">=</span> <span class="n">closePoint</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><h3 id="service">service</h3>
<p>IndexService.java</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">cn.qqlin.trend.service</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">cn.qqlin.trend.pojo.Index</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="cm">/**
</span><span class="cm"> * 指数代码的采集和存储
</span><span class="cm"> *
</span><span class="cm"> * @author qqlin
</span><span class="cm"> * @date 2020-6-13 10:59
</span><span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">IndexService</span> <span class="o">{</span>

    <span class="cm">/**
</span><span class="cm">     * 刷新数据。 刷新的思路就是：
</span><span class="cm">     * 先运行 fetch_indexes_from_third_part 来获取数据
</span><span class="cm">     * 删除数据
</span><span class="cm">     * 保存数据
</span><span class="cm">     *
</span><span class="cm">     * @return 刷新后的数据
</span><span class="cm">     */</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">Index</span><span class="o">&gt;</span> <span class="nf">fresh</span><span class="o">();</span>

    <span class="cm">/**
</span><span class="cm">     * 清空数据
</span><span class="cm">     */</span>
    <span class="kt">void</span> <span class="nf">remove</span><span class="o">();</span>

    <span class="cm">/**
</span><span class="cm">     * 存入数据
</span><span class="cm">     *
</span><span class="cm">     * @return 存入之后的数据
</span><span class="cm">     */</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">Index</span><span class="o">&gt;</span> <span class="nf">store</span><span class="o">();</span>

    <span class="cm">/**
</span><span class="cm">     * 获取数据，这个就是专门用来从 redis 中获取数据
</span><span class="cm">     *
</span><span class="cm">     * @return 获得的数据
</span><span class="cm">     */</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">Index</span><span class="o">&gt;</span> <span class="nf">get</span><span class="o">();</span>

    <span class="cm">/**
</span><span class="cm">     * 刷新第三方的数据，并存入本地的Redis
</span><span class="cm">     *
</span><span class="cm">     * @return Index类型的数据
</span><span class="cm">     */</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">Index</span><span class="o">&gt;</span> <span class="nf">fetchIndexesFromThirdPart</span><span class="o">();</span>

    <span class="cm">/**
</span><span class="cm">     * 断路器的方法
</span><span class="cm">     * 如果fetch_indexes_from_third_part获取失败了，
</span><span class="cm">     * 就自动调用 third_part_not_connected 并返回
</span><span class="cm">     *
</span><span class="cm">     * @return 断路器的数据
</span><span class="cm">     */</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">Index</span><span class="o">&gt;</span> <span class="nf">thirdPartNotConnected</span><span class="o">();</span>

    <span class="cm">/**
</span><span class="cm">     * 从第三方获取出来的内容是Map类型
</span><span class="cm">     * 需要转换为 Index类型
</span><span class="cm">     *
</span><span class="cm">     * @param temp 获取到的Map类型的数据
</span><span class="cm">     * @return 返回Index类型的数据
</span><span class="cm">     */</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">Index</span><span class="o">&gt;</span> <span class="nf">map2Index</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&gt;</span> <span class="n">temp</span><span class="o">);</span>
<span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><p>impl.IndexServiceImpl</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">cn.qqlin.trend.service.impl</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">cn.qqlin.trend.pojo.Index</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">cn.qqlin.trend.service.IndexService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">cn.qqlin.trend.util.SpringContextUtil</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">cn.hutool.core.collection.CollUtil</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">cn.hutool.core.collection.CollectionUtil</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.netflix.hystrix.contrib.javanica.annotation.HystrixCommand</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cache.annotation.CacheConfig</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cache.annotation.CacheEvict</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cache.annotation.Cacheable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.client.RestTemplate</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="cm">/**
</span><span class="cm"> * @author qqlin
</span><span class="cm"> * @date 2020-6-13 15:57
</span><span class="cm"> */</span>
<span class="nd">@Service</span>
<span class="nd">@CacheConfig</span><span class="o">(</span><span class="n">cacheNames</span> <span class="o">=</span> <span class="s">&#34;indexes&#34;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">IndexServiceImpl</span> <span class="kd">implements</span> <span class="n">IndexService</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Index</span><span class="o">&gt;</span> <span class="n">indexes</span><span class="o">;</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">RestTemplate</span> <span class="n">restTemplate</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="nd">@HystrixCommand</span><span class="o">(</span><span class="n">fallbackMethod</span> <span class="o">=</span> <span class="s">&#34;thirdPartNotConnected&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Index</span><span class="o">&gt;</span> <span class="nf">fresh</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">indexes</span> <span class="o">=</span> <span class="n">fetchIndexesFromThirdPart</span><span class="o">();</span>
        <span class="n">IndexService</span> <span class="n">indexService</span> <span class="o">=</span> <span class="n">SpringContextUtil</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="n">IndexService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">indexService</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">indexService</span><span class="o">.</span><span class="na">store</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="nd">@CacheEvict</span><span class="o">(</span><span class="n">allEntries</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">remove</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="nd">@Cacheable</span><span class="o">(</span><span class="n">key</span> <span class="o">=</span> <span class="s">&#34;&#39;all_codes&#39;&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Index</span><span class="o">&gt;</span> <span class="nf">store</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">indexes</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="nd">@Cacheable</span><span class="o">(</span><span class="n">key</span> <span class="o">=</span> <span class="s">&#34;&#39;all_codes&#39;&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Index</span><span class="o">&gt;</span> <span class="nf">get</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">CollUtil</span><span class="o">.</span><span class="na">toList</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Index</span><span class="o">&gt;</span> <span class="nf">fetchIndexesFromThirdPart</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&gt;</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">restTemplate</span><span class="o">.</span><span class="na">getForObject</span><span class="o">(</span>
                <span class="s">&#34;http://localhost:8090/indexes/codes.json&#34;</span><span class="o">,</span> <span class="n">List</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="k">assert</span> <span class="n">temp</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">return</span> <span class="n">map2Index</span><span class="o">(</span><span class="n">temp</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Index</span><span class="o">&gt;</span> <span class="nf">thirdPartNotConnected</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;thirdPartNotConnected()&#34;</span><span class="o">);</span>
        <span class="n">Index</span> <span class="n">index</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Index</span><span class="o">();</span>
        <span class="n">index</span><span class="o">.</span><span class="na">setCode</span><span class="o">(</span><span class="s">&#34;000000&#34;</span><span class="o">);</span>
        <span class="n">index</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">&#34;无效指数代码&#34;</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">CollectionUtil</span><span class="o">.</span><span class="na">toList</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Index</span><span class="o">&gt;</span> <span class="nf">map2Index</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&gt;</span> <span class="n">temp</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Index</span><span class="o">&gt;</span> <span class="n">indexes</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">Map</span> <span class="n">map</span> <span class="o">:</span> <span class="n">temp</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">String</span> <span class="n">code</span> <span class="o">=</span> <span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;code&#34;</span><span class="o">).</span><span class="na">toString</span><span class="o">();</span>
            <span class="n">String</span> <span class="n">name</span> <span class="o">=</span> <span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;name&#34;</span><span class="o">).</span><span class="na">toString</span><span class="o">();</span>
            <span class="n">Index</span> <span class="n">index</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Index</span><span class="o">();</span>
            <span class="n">index</span><span class="o">.</span><span class="na">setCode</span><span class="o">(</span><span class="n">code</span><span class="o">);</span>
            <span class="n">index</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
            <span class="n">indexes</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">indexes</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><p>IndexDataService.java</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">cn.qqlin.trend.service</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">cn.qqlin.trend.pojo.IndexData</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="cm">/**
</span><span class="cm"> * 指数数据的采集和存储
</span><span class="cm"> *
</span><span class="cm"> * @author qqlin
</span><span class="cm"> * @date 2020-6-13 16:37
</span><span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">IndexDataService</span> <span class="o">{</span>

    <span class="cm">/**
</span><span class="cm">     * 刷新数据。 刷新的思路就是：
</span><span class="cm">     * 先运行 fetch_indexes_from_third_part 来获取数据
</span><span class="cm">     * 删除数据
</span><span class="cm">     * 保存数据
</span><span class="cm">     *
</span><span class="cm">     * @param code 证券代码
</span><span class="cm">     * @return 所有的证券代码
</span><span class="cm">     */</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">IndexData</span><span class="o">&gt;</span> <span class="nf">fresh</span><span class="o">(</span><span class="n">String</span> <span class="n">code</span><span class="o">);</span>

    <span class="cm">/**
</span><span class="cm">     * 清空数据
</span><span class="cm">     *
</span><span class="cm">     * @param code 证券代码
</span><span class="cm">     */</span>
    <span class="kt">void</span> <span class="nf">remove</span><span class="o">(</span><span class="n">String</span> <span class="n">code</span><span class="o">);</span>

    <span class="cm">/**
</span><span class="cm">     * 存入数据
</span><span class="cm">     *
</span><span class="cm">     * @param code 证券代码
</span><span class="cm">     * @return 存入之后的数据
</span><span class="cm">     */</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">IndexData</span><span class="o">&gt;</span> <span class="nf">store</span><span class="o">(</span><span class="n">String</span> <span class="n">code</span><span class="o">);</span>

    <span class="cm">/**
</span><span class="cm">     * 获取数据，这个就是专门用来从 redis 中获取数据
</span><span class="cm">     *
</span><span class="cm">     * @param code 证券代码
</span><span class="cm">     * @return 获得的数据
</span><span class="cm">     */</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">IndexData</span><span class="o">&gt;</span> <span class="nf">get</span><span class="o">(</span><span class="n">String</span> <span class="n">code</span><span class="o">);</span>

    <span class="cm">/**
</span><span class="cm">     * 刷新第三方的数据，并存入本地的Redis
</span><span class="cm">     *
</span><span class="cm">     * @param code 证券代码
</span><span class="cm">     * @return Index类型的数据
</span><span class="cm">     */</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">IndexData</span><span class="o">&gt;</span> <span class="nf">fetchIndexesFromThirdPart</span><span class="o">(</span><span class="n">String</span> <span class="n">code</span><span class="o">);</span>

    <span class="cm">/**
</span><span class="cm">     * 断路器的方法
</span><span class="cm">     * 如果fetch_indexes_from_third_part获取失败了，
</span><span class="cm">     * 就自动调用 third_part_not_connected 并返回
</span><span class="cm">     *
</span><span class="cm">     * @param code 证券代码
</span><span class="cm">     * @return 断路器的数据
</span><span class="cm">     */</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">IndexData</span><span class="o">&gt;</span> <span class="nf">thirdPartNotConnected</span><span class="o">(</span><span class="n">String</span> <span class="n">code</span><span class="o">);</span>

    <span class="cm">/**
</span><span class="cm">     * 从第三方获取出来的内容是Map类型
</span><span class="cm">     * 需要转换为 Index类型
</span><span class="cm">     *
</span><span class="cm">     * @param temp 获取到的Map类型的数据
</span><span class="cm">     * @return 返回Index类型的数据
</span><span class="cm">     */</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">IndexData</span><span class="o">&gt;</span> <span class="nf">map2IndexData</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&gt;</span> <span class="n">temp</span><span class="o">);</span>

<span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><p>impl.IndexDataServiceImpl</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">cn.qqlin.trend.service.impl</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">cn.qqlin.trend.pojo.IndexData</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">cn.qqlin.trend.service.IndexDataService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">cn.qqlin.trend.util.SpringContextUtil</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">cn.hutool.core.collection.CollUtil</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">cn.hutool.core.collection.CollectionUtil</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">cn.hutool.core.convert.Convert</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.netflix.hystrix.contrib.javanica.annotation.HystrixCommand</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cache.annotation.CacheConfig</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cache.annotation.CacheEvict</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cache.annotation.CachePut</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cache.annotation.Cacheable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.client.RestTemplate</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="cm">/**
</span><span class="cm"> * @author qqlin
</span><span class="cm"> * @date 2020-6-13 16:38
</span><span class="cm"> */</span>
<span class="nd">@Service</span>
<span class="nd">@CacheConfig</span><span class="o">(</span><span class="n">cacheNames</span> <span class="o">=</span> <span class="s">&#34;index_datas&#34;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">IndexDataServiceImpl</span> <span class="kd">implements</span> <span class="n">IndexDataService</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">IndexData</span><span class="o">&gt;&gt;</span> <span class="n">indexDataMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">RestTemplate</span> <span class="n">restTemplate</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="nd">@HystrixCommand</span><span class="o">(</span><span class="n">fallbackMethod</span> <span class="o">=</span> <span class="s">&#34;thirdPartNotConnected&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">IndexData</span><span class="o">&gt;</span> <span class="nf">fresh</span><span class="o">(</span><span class="n">String</span> <span class="n">code</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">IndexData</span><span class="o">&gt;</span> <span class="n">indexDataList</span> <span class="o">=</span> <span class="n">fetchIndexesFromThirdPart</span><span class="o">(</span><span class="n">code</span><span class="o">);</span>

        <span class="n">indexDataMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">code</span><span class="o">,</span> <span class="n">indexDataList</span><span class="o">);</span>

        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;code:&#34;</span> <span class="o">+</span> <span class="n">code</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;indexesDateMap:&#34;</span> <span class="o">+</span> <span class="n">indexDataMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">code</span><span class="o">).</span><span class="na">size</span><span class="o">());</span>

        <span class="n">IndexDataService</span> <span class="n">indexDataService</span> <span class="o">=</span> <span class="n">SpringContextUtil</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="n">IndexDataService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">indexDataService</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">code</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">indexDataService</span><span class="o">.</span><span class="na">store</span><span class="o">(</span><span class="n">code</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="nd">@CacheEvict</span><span class="o">(</span><span class="n">key</span> <span class="o">=</span> <span class="s">&#34;&#39;indexData-code-&#39; + #p0&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">remove</span><span class="o">(</span><span class="n">String</span> <span class="n">code</span><span class="o">)</span> <span class="o">{</span>

    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="nd">@CachePut</span><span class="o">(</span><span class="n">key</span> <span class="o">=</span> <span class="s">&#34;&#39;indexData-code-&#39; + #p0&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">IndexData</span><span class="o">&gt;</span> <span class="nf">store</span><span class="o">(</span><span class="n">String</span> <span class="n">code</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">indexDataMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">code</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="nd">@Cacheable</span><span class="o">(</span><span class="n">key</span> <span class="o">=</span> <span class="s">&#34;&#39;indexData-code-&#39; + #p0&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">IndexData</span><span class="o">&gt;</span> <span class="nf">get</span><span class="o">(</span><span class="n">String</span> <span class="n">code</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">CollUtil</span><span class="o">.</span><span class="na">toList</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">IndexData</span><span class="o">&gt;</span> <span class="nf">fetchIndexesFromThirdPart</span><span class="o">(</span><span class="n">String</span> <span class="n">code</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&gt;</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">restTemplate</span><span class="o">.</span><span class="na">getForObject</span><span class="o">(</span>
                <span class="s">&#34;http://localhost:8090/indexes/&#34;</span> <span class="o">+</span> <span class="n">code</span> <span class="o">+</span> <span class="s">&#34;.json&#34;</span><span class="o">,</span>
                <span class="n">List</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

        <span class="k">return</span> <span class="n">map2IndexData</span><span class="o">(</span><span class="n">temp</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">IndexData</span><span class="o">&gt;</span> <span class="nf">thirdPartNotConnected</span><span class="o">(</span><span class="n">String</span> <span class="n">code</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;thirdPartNotConnected()&#34;</span><span class="o">);</span>
        <span class="n">IndexData</span> <span class="n">indexData</span> <span class="o">=</span> <span class="k">new</span> <span class="n">IndexData</span><span class="o">();</span>
        <span class="n">indexData</span><span class="o">.</span><span class="na">setClosePoint</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>
        <span class="n">indexData</span><span class="o">.</span><span class="na">setDate</span><span class="o">(</span><span class="s">&#34;n/a&#34;</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">CollectionUtil</span><span class="o">.</span><span class="na">toList</span><span class="o">(</span><span class="n">indexData</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">IndexData</span><span class="o">&gt;</span> <span class="nf">map2IndexData</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&gt;</span> <span class="n">temp</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">IndexData</span><span class="o">&gt;</span> <span class="n">indexDataList</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>

        <span class="k">for</span> <span class="o">(</span><span class="n">Map</span> <span class="n">map</span> <span class="o">:</span> <span class="n">temp</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">String</span> <span class="n">date</span> <span class="o">=</span> <span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;date&#34;</span><span class="o">).</span><span class="na">toString</span><span class="o">();</span>
            <span class="kt">float</span> <span class="n">closePoint</span> <span class="o">=</span> <span class="n">Convert</span><span class="o">.</span><span class="na">toFloat</span><span class="o">(</span><span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;closePoint&#34;</span><span class="o">));</span>
            <span class="n">IndexData</span> <span class="n">indexData</span> <span class="o">=</span> <span class="k">new</span> <span class="n">IndexData</span><span class="o">();</span>

            <span class="n">indexData</span><span class="o">.</span><span class="na">setDate</span><span class="o">(</span><span class="n">date</span><span class="o">);</span>
            <span class="n">indexData</span><span class="o">.</span><span class="na">setClosePoint</span><span class="o">(</span><span class="n">closePoint</span><span class="o">);</span>
            <span class="n">indexDataList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">indexData</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">indexDataList</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><h3 id="util">util</h3>
<p>SpringContextUtil.java</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">cn.qqlin.trend.util</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.context.ApplicationContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.ApplicationContextAware</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Component</span><span class="o">;</span>

<span class="cm">/**
</span><span class="cm"> * 工具：用于spring中的服务组件的重新加载
</span><span class="cm"> *
</span><span class="cm"> * @author qqlin
</span><span class="cm"> * @date 2020-6-13 15:46
</span><span class="cm"> */</span>
<span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SpringContextUtil</span> <span class="kd">implements</span> <span class="n">ApplicationContextAware</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="nf">SpringContextUtil</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;SpringContextUtil()&#34;</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="n">ApplicationContext</span> <span class="n">applicationContext</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setApplicationContext</span><span class="o">(</span><span class="n">ApplicationContext</span> <span class="n">applicationContext</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;applicationContext:&#34;</span> <span class="o">+</span> <span class="n">applicationContext</span><span class="o">);</span>
        <span class="n">SpringContextUtil</span><span class="o">.</span><span class="na">applicationContext</span> <span class="o">=</span> <span class="n">applicationContext</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">T</span> <span class="nf">getBean</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">clazz</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">applicationContext</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="n">clazz</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><h3 id="web">web</h3>
<p>IndexController.java</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">cn.qqlin.trend.web</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">cn.qqlin.trend.pojo.Index</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">cn.qqlin.trend.service.IndexService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.GetMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RestController</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="cm">/**
</span><span class="cm"> * @author qqlin
</span><span class="cm"> * @date 2020-6-13 11:06
</span><span class="cm"> */</span>
<span class="nd">@RestController</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">IndexController</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">IndexService</span> <span class="n">indexService</span><span class="o">;</span>

    <span class="cm">/*@GetMapping(&#34;/getCodes&#34;)
</span><span class="cm">    public List&lt;Index&gt; get() throws Exception {
</span><span class="cm">        return indexService.fetchIndexesFromThirdPart();
</span><span class="cm">    }*/</span>

    <span class="c1">//  http://127.0.0.1:8001/freshCodes
</span><span class="c1"></span>    <span class="c1">//  http://127.0.0.1:8001/getCodes
</span><span class="c1"></span>    <span class="c1">//  http://127.0.0.1:8001/removeCodes
</span><span class="c1"></span>
	<span class="nd">@GetMapping</span><span class="o">(</span><span class="s">&#34;/freshCodes&#34;</span><span class="o">)</span>
	<span class="kd">public</span> <span class="n">String</span> <span class="nf">fresh</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
		<span class="n">indexService</span><span class="o">.</span><span class="na">fresh</span><span class="o">();</span>
		<span class="k">return</span> <span class="s">&#34;fresh codes successfully&#34;</span><span class="o">;</span>
	<span class="o">}</span>
	<span class="nd">@GetMapping</span><span class="o">(</span><span class="s">&#34;/getCodes&#34;</span><span class="o">)</span>
	<span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Index</span><span class="o">&gt;</span> <span class="nf">get</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">indexService</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
	<span class="o">}</span>
	<span class="nd">@GetMapping</span><span class="o">(</span><span class="s">&#34;/removeCodes&#34;</span><span class="o">)</span>
	<span class="kd">public</span> <span class="n">String</span> <span class="nf">remove</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
		<span class="n">indexService</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
		<span class="k">return</span> <span class="s">&#34;remove codes successfully&#34;</span><span class="o">;</span>
	<span class="o">}</span>
<span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><p>IndexDataController.java</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">cn.qqlin.trend.web</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">cn.qqlin.trend.pojo.IndexData</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">cn.qqlin.trend.service.IndexDataService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.GetMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.PathVariable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RestController</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="cm">/**
</span><span class="cm"> * @author qqlin
</span><span class="cm"> * @date 2020-6-13 17:51
</span><span class="cm"> */</span>
<span class="nd">@RestController</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">IndexDataController</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">IndexDataService</span> <span class="n">indexDataService</span><span class="o">;</span>

<span class="c1">//  http://127.0.0.1:8001/freshIndexData/000300
</span><span class="c1">//  http://127.0.0.1:8001/getIndexData/000300
</span><span class="c1">//  http://127.0.0.1:8001/removeIndexData/000300
</span><span class="c1"></span>
    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">&#34;/freshIndexData/{code}&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">fresh</span><span class="o">(</span><span class="nd">@PathVariable</span><span class="o">(</span><span class="s">&#34;code&#34;</span><span class="o">)</span> <span class="n">String</span> <span class="n">code</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">indexDataService</span><span class="o">.</span><span class="na">fresh</span><span class="o">(</span><span class="n">code</span><span class="o">);</span>
        <span class="k">return</span> <span class="s">&#34;fresh index data successfully&#34;</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">&#34;/getIndexData/{code}&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">IndexData</span><span class="o">&gt;</span> <span class="nf">get</span><span class="o">(</span><span class="nd">@PathVariable</span><span class="o">(</span><span class="s">&#34;code&#34;</span><span class="o">)</span> <span class="n">String</span> <span class="n">code</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">indexDataService</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">code</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">&#34;/removeIndexData/{code}&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">remove</span><span class="o">(</span><span class="nd">@PathVariable</span><span class="o">(</span><span class="s">&#34;code&#34;</span><span class="o">)</span> <span class="n">String</span> <span class="n">code</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">indexDataService</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">code</span><span class="o">);</span>
        <span class="k">return</span> <span class="s">&#34;remove index data successfully&#34;</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><h2 id="25-指数代码微服务">2.5 指数代码微服务</h2>
<blockquote>
<p>为什么不直接用采集和存储服务提供呢？ 采集和存储服务已经提供了web接口， 干嘛要专门提供一个微服务来获取指数代码？
原因有两个：</p>
<ol>
<li>采集和存储服务本身定位是在采集和存储服务上，其提供的web接口只是为了调试用，其定位不是用于提供指数数据的。</li>
<li>为了使用集群，指数代码微服务会有多个， 而采集和存储服务并非不能做集群，但是它里面有定时器，如果也做成集群，就会有多个定时器同时工作，一起向第三方获取数据，一起把数据保存到 redis里。 这样不仅是额外的开销，也埋下了出现数据冲突的风险。
所以会专门有一个微服务来单纯地提供指数代码。</li>
</ol>
</blockquote>
<h3 id="module-3">module</h3>
<p>新建一个module，命名为index-codes-service，修改pom.xml为</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-xml" data-lang="xml"><span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>

<span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0&#34;</span> <span class="na">xmlns:xsi=</span><span class="s">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
         <span class="na">xsi:schemaLocation=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&#34;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>
    <span class="nt">&lt;parent&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>cn.qqlin.trend<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>trendParentProject<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/parent&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>index-codes-service<span class="nt">&lt;/artifactId&gt;</span>

    <span class="nt">&lt;dependencies&gt;</span>
        <span class="c">&lt;!-- springboot web --&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-web<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!-- eureka-client --&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!-- redis --&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-data-redis<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!--zipkin--&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-zipkin<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>

    <span class="nt">&lt;/dependencies&gt;</span>
<span class="nt">&lt;/project&gt;</span>

</code></pre></td></tr></table>
</div>
</div><h3 id="indexcodesapplicationjava">IndexCodesApplication.java</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">cn.qqlin.trend</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">brave.sampler.Sampler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">cn.hutool.core.convert.Convert</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">cn.hutool.core.thread.ThreadUtil</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">cn.hutool.core.util.NetUtil</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">cn.hutool.core.util.NumberUtil</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">cn.hutool.core.util.StrUtil</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.autoconfigure.SpringBootApplication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.builder.SpringApplicationBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cache.annotation.EnableCaching</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cloud.netflix.eureka.EnableEurekaClient</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Scanner</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.ExecutionException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.Future</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.TimeUnit</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.TimeoutException</span><span class="o">;</span>

<span class="cm">/**
</span><span class="cm">* @author qqlin
</span><span class="cm">* @date 2020-6-13 22:53
</span><span class="cm">*/</span>
<span class="nd">@SpringBootApplication</span>
<span class="nd">@EnableEurekaClient</span>
<span class="nd">@EnableCaching</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">IndexCodesApplication</span> <span class="o">{</span>

   <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
       <span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
       <span class="kt">int</span> <span class="n">defaultPort</span> <span class="o">=</span> <span class="n">8011</span><span class="o">;</span>
       <span class="kt">int</span> <span class="n">redisPort</span> <span class="o">=</span> <span class="n">6379</span><span class="o">;</span>
       <span class="kt">int</span> <span class="n">eurekaServerPort</span> <span class="o">=</span> <span class="n">8761</span><span class="o">;</span>

       <span class="k">if</span> <span class="o">(</span><span class="n">NetUtil</span><span class="o">.</span><span class="na">isUsableLocalPort</span><span class="o">(</span><span class="n">eurekaServerPort</span><span class="o">))</span> <span class="o">{</span>
           <span class="n">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">&#34;检查到端口%d 未启用，判断 eureka 服务器没有启动，本服务无法使用，故退出%n&#34;</span><span class="o">,</span> <span class="n">eurekaServerPort</span><span class="o">);</span>
           <span class="n">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
       <span class="o">}</span>

       <span class="k">if</span> <span class="o">(</span><span class="n">NetUtil</span><span class="o">.</span><span class="na">isUsableLocalPort</span><span class="o">(</span><span class="n">redisPort</span><span class="o">))</span> <span class="o">{</span>
           <span class="n">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">&#34;检查到端口%d 未启用，判断 redis 服务器没有启动，本服务无法使用，故退出%n&#34;</span><span class="o">,</span> <span class="n">redisPort</span><span class="o">);</span>
           <span class="n">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
       <span class="o">}</span>

       <span class="k">if</span> <span class="o">(</span><span class="kc">null</span> <span class="o">!=</span> <span class="n">args</span> <span class="o">&amp;&amp;</span> <span class="n">0</span> <span class="o">!=</span> <span class="n">args</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">{</span>
           <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">arg</span> <span class="o">:</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
               <span class="k">if</span> <span class="o">(</span><span class="n">arg</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">&#34;port=&#34;</span><span class="o">))</span> <span class="o">{</span>
                   <span class="n">String</span> <span class="n">strPort</span> <span class="o">=</span> <span class="n">StrUtil</span><span class="o">.</span><span class="na">subAfter</span><span class="o">(</span><span class="n">arg</span><span class="o">,</span> <span class="s">&#34;port=&#34;</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
                   <span class="k">if</span> <span class="o">(</span><span class="n">NumberUtil</span><span class="o">.</span><span class="na">isNumber</span><span class="o">(</span><span class="n">strPort</span><span class="o">))</span> <span class="o">{</span>
                       <span class="n">port</span> <span class="o">=</span> <span class="n">Convert</span><span class="o">.</span><span class="na">toInt</span><span class="o">(</span><span class="n">strPort</span><span class="o">);</span>
                   <span class="o">}</span>
               <span class="o">}</span>
           <span class="o">}</span>
       <span class="o">}</span>

       <span class="k">if</span> <span class="o">(</span><span class="n">0</span> <span class="o">==</span> <span class="n">port</span><span class="o">)</span> <span class="o">{</span>
           <span class="n">Future</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">future</span> <span class="o">=</span> <span class="n">ThreadUtil</span><span class="o">.</span><span class="na">execAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
               <span class="kt">int</span> <span class="n">p</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
               <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">&#34;请于5秒钟内输入端口号, 推荐  %d ,超过5秒将默认使用 %d %n&#34;</span><span class="o">,</span> <span class="n">defaultPort</span><span class="o">,</span> <span class="n">defaultPort</span><span class="o">);</span>
               <span class="n">Scanner</span> <span class="n">scanner</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Scanner</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">in</span><span class="o">);</span>
               <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                   <span class="n">String</span> <span class="n">strPort</span> <span class="o">=</span> <span class="n">scanner</span><span class="o">.</span><span class="na">nextLine</span><span class="o">();</span>
                   <span class="k">if</span> <span class="o">(!</span><span class="n">NumberUtil</span><span class="o">.</span><span class="na">isInteger</span><span class="o">(</span><span class="n">strPort</span><span class="o">))</span> <span class="o">{</span>
                       <span class="n">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;只能是数字&#34;</span><span class="o">);</span>
                       <span class="k">continue</span><span class="o">;</span>
                   <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                       <span class="n">p</span> <span class="o">=</span> <span class="n">Convert</span><span class="o">.</span><span class="na">toInt</span><span class="o">(</span><span class="n">strPort</span><span class="o">);</span>
                       <span class="n">scanner</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                       <span class="k">break</span><span class="o">;</span>
                   <span class="o">}</span>
               <span class="o">}</span>
               <span class="k">return</span> <span class="n">p</span><span class="o">;</span>
           <span class="o">});</span>
           <span class="k">try</span> <span class="o">{</span>
               <span class="n">port</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">5</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>
           <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="o">|</span> <span class="n">ExecutionException</span> <span class="o">|</span> <span class="n">TimeoutException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
               <span class="n">port</span> <span class="o">=</span> <span class="n">defaultPort</span><span class="o">;</span>
           <span class="o">}</span>
       <span class="o">}</span>

       <span class="k">if</span> <span class="o">(!</span><span class="n">NetUtil</span><span class="o">.</span><span class="na">isUsableLocalPort</span><span class="o">(</span><span class="n">port</span><span class="o">))</span> <span class="o">{</span>
           <span class="n">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">&#34;端口%d被占用了，无法启动%n&#34;</span><span class="o">,</span> <span class="n">port</span><span class="o">);</span>
           <span class="n">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
       <span class="o">}</span>
       <span class="k">new</span> <span class="n">SpringApplicationBuilder</span><span class="o">(</span><span class="n">IndexCodesApplication</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">properties</span><span class="o">(</span><span class="s">&#34;server.port=&#34;</span> <span class="o">+</span> <span class="n">port</span><span class="o">).</span><span class="na">run</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>
   <span class="o">}</span>

   <span class="nd">@Bean</span>
   <span class="kd">public</span> <span class="n">Sampler</span> <span class="nf">defaultSampler</span><span class="o">()</span> <span class="o">{</span>
       <span class="k">return</span> <span class="n">Sampler</span><span class="o">.</span><span class="na">ALWAYS_SAMPLE</span><span class="o">;</span>
   <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="applicationyml-3">application.yml</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yml" data-lang="yml"><span class="k">spring</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">application</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">name</span><span class="p">:</span><span class="w"> </span>index-codes-service<span class="w">
</span><span class="w">  </span><span class="k">zipkin</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">base-url</span><span class="p">:</span><span class="w"> </span>http<span class="p">:</span>//localhost<span class="p">:</span><span class="m">9411</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="k">eureka</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">client</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">service-url</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="k">defaultZone</span><span class="p">:</span><span class="w"> </span>http<span class="p">:</span>//localhost<span class="p">:</span><span class="m">8761</span>/eureka/<span class="w">
</span><span class="w">      
</span></code></pre></td></tr></table>
</div>
</div><h3 id="config-1">config</h3>
<p>IpConfiguration.java</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">cn.qqlin.trend.config</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.boot.web.context.WebServerInitializedEvent</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.ApplicationListener</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Component</span><span class="o">;</span>

<span class="cm">/**
</span><span class="cm"> * 用于获取当前的端口号。
</span><span class="cm"> * 因为这个微服务会做成集群，不同的微服务使用的是不同的端口号，
</span><span class="cm"> * 可以通过获取并打印出来知道当前是哪个。
</span><span class="cm"> *
</span><span class="cm"> * @author qqlin
</span><span class="cm"> * @date 2020-6-13 23:00
</span><span class="cm"> */</span>
<span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">IpConfiguration</span> <span class="kd">implements</span> <span class="n">ApplicationListener</span><span class="o">&lt;</span><span class="n">WebServerInitializedEvent</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kt">int</span> <span class="n">serverPort</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onApplicationEvent</span><span class="o">(</span><span class="n">WebServerInitializedEvent</span> <span class="n">webServerInitializedEvent</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">serverPort</span> <span class="o">=</span> <span class="n">webServerInitializedEvent</span><span class="o">.</span><span class="na">getWebServer</span><span class="o">().</span><span class="na">getPort</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getServerPort</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">serverPort</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><p>RedisCacheConfig.java</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">cn.qqlin.trend.config</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.fasterxml.jackson.annotation.JsonAutoDetect</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.fasterxml.jackson.annotation.PropertyAccessor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.fasterxml.jackson.databind.ObjectMapper</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.context.properties.ConfigurationProperties</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cache.CacheManager</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.redis.cache.RedisCacheConfiguration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.redis.cache.RedisCacheManager</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.redis.connection.RedisConnectionFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.redis.serializer.Jackson2JsonRedisSerializer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.redis.serializer.RedisSerializationContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.redis.serializer.RedisSerializer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.redis.serializer.StringRedisSerializer</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.time.Duration</span><span class="o">;</span>

<span class="cm">/**
</span><span class="cm"> * @author qqlin
</span><span class="cm"> * @date 2020-6-13 23:03
</span><span class="cm"> */</span>
<span class="nd">@Configuration</span>
<span class="nd">@ConfigurationProperties</span><span class="o">(</span><span class="n">prefix</span> <span class="o">=</span> <span class="s">&#34;spring.cache.redis&#34;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RedisCacheConfig</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="n">Duration</span> <span class="n">timeToLive</span> <span class="o">=</span> <span class="n">Duration</span><span class="o">.</span><span class="na">ZERO</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTimeToLive</span><span class="o">(</span><span class="n">Duration</span> <span class="n">timeToLive</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">timeToLive</span> <span class="o">=</span> <span class="n">timeToLive</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="n">CacheManager</span> <span class="nf">cacheManager</span><span class="o">(</span><span class="n">RedisConnectionFactory</span> <span class="n">factory</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">RedisSerializer</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">redisSerializer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringRedisSerializer</span><span class="o">();</span>

        <span class="n">Jackson2JsonRedisSerializer</span> <span class="n">jackson2JsonRedisSerializer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Jackson2JsonRedisSerializer</span><span class="o">(</span><span class="n">Object</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

        <span class="c1">// 解决查询缓存转换异常的问题
</span><span class="c1"></span>        <span class="n">ObjectMapper</span> <span class="n">objectMapper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectMapper</span><span class="o">();</span>
        <span class="n">objectMapper</span><span class="o">.</span><span class="na">setVisibility</span><span class="o">(</span><span class="n">PropertyAccessor</span><span class="o">.</span><span class="na">ALL</span><span class="o">,</span> <span class="n">JsonAutoDetect</span><span class="o">.</span><span class="na">Visibility</span><span class="o">.</span><span class="na">PUBLIC_ONLY</span><span class="o">);</span>
        <span class="n">objectMapper</span><span class="o">.</span><span class="na">enableDefaultTyping</span><span class="o">(</span><span class="n">ObjectMapper</span><span class="o">.</span><span class="na">DefaultTyping</span><span class="o">.</span><span class="na">NON_FINAL</span><span class="o">);</span>
        <span class="n">jackson2JsonRedisSerializer</span><span class="o">.</span><span class="na">setObjectMapper</span><span class="o">(</span><span class="n">objectMapper</span><span class="o">);</span>

        <span class="c1">// 配置序列化（解决乱码的问题）
</span><span class="c1"></span>        <span class="n">RedisCacheConfiguration</span> <span class="n">configuration</span> <span class="o">=</span> <span class="n">RedisCacheConfiguration</span><span class="o">.</span><span class="na">defaultCacheConfig</span><span class="o">()</span>
                <span class="o">.</span><span class="na">entryTtl</span><span class="o">(</span><span class="n">timeToLive</span><span class="o">)</span>
                <span class="o">.</span><span class="na">serializeKeysWith</span><span class="o">(</span><span class="n">RedisSerializationContext</span><span class="o">.</span><span class="na">SerializationPair</span><span class="o">.</span><span class="na">fromSerializer</span><span class="o">(</span><span class="n">redisSerializer</span><span class="o">))</span>
                <span class="o">.</span><span class="na">serializeValuesWith</span><span class="o">(</span><span class="n">RedisSerializationContext</span><span class="o">.</span><span class="na">SerializationPair</span><span class="o">.</span><span class="na">fromSerializer</span><span class="o">(</span><span class="n">jackson2JsonRedisSerializer</span><span class="o">))</span>
                <span class="o">.</span><span class="na">disableCachingNullValues</span><span class="o">();</span>

        <span class="n">RedisCacheManager</span> <span class="n">cacheManager</span> <span class="o">=</span> <span class="n">RedisCacheManager</span><span class="o">.</span><span class="na">builder</span><span class="o">(</span><span class="n">factory</span><span class="o">)</span>
                <span class="o">.</span><span class="na">cacheDefaults</span><span class="o">(</span><span class="n">configuration</span><span class="o">)</span>
                <span class="o">.</span><span class="na">build</span><span class="o">();</span>

        <span class="k">return</span> <span class="n">cacheManager</span><span class="o">;</span>

    <span class="o">}</span>
<span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><h3 id="pojo-1">pojo</h3>
<p>Index.java</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">cn.qqlin.trend.pojo</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>

<span class="cm">/**
</span><span class="cm"> * @author qqlin
</span><span class="cm"> * @date 2020-6-13 23:18
</span><span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Index</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="o">-</span><span class="n">5587270167443098440L</span><span class="o">;</span>

    <span class="cm">/**
</span><span class="cm">     * 证券的代码
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">code</span><span class="o">;</span>

    <span class="cm">/**
</span><span class="cm">     * 证券的名称
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getCode</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">code</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setCode</span><span class="o">(</span><span class="n">String</span> <span class="n">code</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">code</span> <span class="o">=</span> <span class="n">code</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">name</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setName</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><h3 id="service-1">service</h3>
<p>IndexService.java</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">cn.qqlin.trend.service</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">cn.qqlin.trend.pojo.Index</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="cm">/**
</span><span class="cm"> * @author qqlin
</span><span class="cm"> * @date 2020-6-13 23:20
</span><span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">IndexService</span> <span class="o">{</span>

    <span class="cm">/**
</span><span class="cm">     * 直接从redis获取数据
</span><span class="cm">     * 如果没有数据，则会返回 “无效指数代码 ”。
</span><span class="cm">     *
</span><span class="cm">     * @return 返回Index的所有值
</span><span class="cm">     */</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">Index</span><span class="o">&gt;</span> <span class="nf">getIndexes</span><span class="o">();</span>
<span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><p>impl.IndexServiceImpl</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">cn.qqlin.trend.service.impl</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">cn.qqlin.trend.pojo.Index</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">cn.qqlin.trend.service.IndexService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">cn.hutool.core.collection.CollUtil</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cache.annotation.CacheConfig</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cache.annotation.Cacheable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="cm">/**
</span><span class="cm"> * @author qqlin
</span><span class="cm"> * @date 2020-6-13 23:20
</span><span class="cm"> */</span>
<span class="nd">@Service</span>
<span class="nd">@CacheConfig</span><span class="o">(</span><span class="n">cacheNames</span> <span class="o">=</span> <span class="s">&#34;indexes&#34;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">IndexServiceImpl</span> <span class="kd">implements</span> <span class="n">IndexService</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Index</span><span class="o">&gt;</span> <span class="n">indexes</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="nd">@Cacheable</span><span class="o">(</span><span class="n">key</span> <span class="o">=</span> <span class="s">&#34;&#39;all_codes&#39;&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Index</span><span class="o">&gt;</span> <span class="nf">getIndexes</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">Index</span> <span class="n">index</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Index</span><span class="o">();</span>
        <span class="n">index</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">&#34;无效指数代码&#34;</span><span class="o">);</span>
        <span class="n">index</span><span class="o">.</span><span class="na">setCode</span><span class="o">(</span><span class="s">&#34;000000&#34;</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">CollUtil</span><span class="o">.</span><span class="na">toList</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><h3 id="web-1">web</h3>
<p>IndexController.java</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">cn.qqlin.trend.web</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">cn.qqlin.trend.config.IpConfiguration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">cn.qqlin.trend.pojo.Index</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">cn.qqlin.trend.service.IndexService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.CrossOrigin</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.GetMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RestController</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="cm">/**
</span><span class="cm"> * 表示允许跨域，@CrossOrigin
</span><span class="cm"> * 因为后续的回测视图是另一个端口号的，访问这个服务是属于跨域了。
</span><span class="cm"> *
</span><span class="cm"> * @author qqlin
</span><span class="cm"> * @date 2020-6-13 23:25
</span><span class="cm"> */</span>
<span class="nd">@RestController</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">IndexController</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">IndexService</span> <span class="n">indexService</span><span class="o">;</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">IpConfiguration</span> <span class="n">ipConfiguration</span><span class="o">;</span>

<span class="c1">//  http://127.0.0.1:8011/codes
</span><span class="c1"></span>
    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">&#34;/codes&#34;</span><span class="o">)</span>
    <span class="nd">@CrossOrigin</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Index</span><span class="o">&gt;</span> <span class="nf">codes</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;current instance&#39;s port is&#34;</span> <span class="o">+</span> <span class="n">ipConfiguration</span><span class="o">.</span><span class="na">getServerPort</span><span class="o">());</span>
        <span class="k">return</span> <span class="n">indexService</span><span class="o">.</span><span class="na">getIndexes</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><p><strong>先启动 EurekaServerApplication
然后启动 IndexCodesApplication</strong>
然后访问地址：</p>
<p>http://127.0.0.1:8011/codes</p>
<h2 id="26-指数数据微服务">2.6 指数数据微服务</h2>
<h3 id="module-4">module</h3>
<p>新建一个module，命名为index-data-service，修改pom.xml为</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-xml" data-lang="xml"><span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>

<span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0&#34;</span> <span class="na">xmlns:xsi=</span><span class="s">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
         <span class="na">xsi:schemaLocation=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&#34;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>

    <span class="nt">&lt;parent&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>cn.qqlin.trend<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>trendParentProject<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/parent&gt;</span>

    <span class="nt">&lt;artifactId&gt;</span>index-data-service<span class="nt">&lt;/artifactId&gt;</span>

    <span class="nt">&lt;dependencies&gt;</span>
        <span class="c">&lt;!-- springboot web --&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-web<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!-- eureka-client --&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!-- redis --&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-data-redis<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!--zipkin--&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-zipkin<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>

    <span class="nt">&lt;/dependencies&gt;</span>
<span class="nt">&lt;/project&gt;</span>

</code></pre></td></tr></table>
</div>
</div><h3 id="indexdataapplicationjava">IndexDataApplication.java</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span><span class="lnt">96
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">cn.qqlin.trend</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">brave.sampler.Sampler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">cn.hutool.core.convert.Convert</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">cn.hutool.core.thread.ThreadUtil</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">cn.hutool.core.util.NetUtil</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">cn.hutool.core.util.NumberUtil</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">cn.hutool.core.util.StrUtil</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.autoconfigure.SpringBootApplication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.builder.SpringApplicationBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cache.annotation.EnableCaching</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cloud.netflix.eureka.EnableEurekaClient</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Scanner</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.ExecutionException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.Future</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.TimeUnit</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.TimeoutException</span><span class="o">;</span>

<span class="cm">/**
</span><span class="cm"> * @author qqlin
</span><span class="cm"> * @date 2020-6-14 0:10
</span><span class="cm"> */</span>
<span class="nd">@SpringBootApplication</span>
<span class="nd">@EnableEurekaClient</span>
<span class="nd">@EnableCaching</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">IndexDataApplication</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">defaultPort</span> <span class="o">=</span> <span class="n">8021</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">redisPort</span> <span class="o">=</span> <span class="n">6379</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">eurekaServerPort</span> <span class="o">=</span> <span class="n">8761</span><span class="o">;</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">NetUtil</span><span class="o">.</span><span class="na">isUsableLocalPort</span><span class="o">(</span><span class="n">eurekaServerPort</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">&#34;检查到端口%d 未启用，判断 eureka 服务器没有启用，本服务无法启动， 故退出%n&#34;</span><span class="o">,</span> <span class="n">eurekaServerPort</span><span class="o">);</span>
            <span class="n">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">NetUtil</span><span class="o">.</span><span class="na">isUsableLocalPort</span><span class="o">(</span><span class="n">redisPort</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">&#34;检查到端口%d 未启用，判断 redis 服务器没有启动， 本服务无法启动，故退出%n&#34;</span><span class="o">,</span> <span class="n">redisPort</span><span class="o">);</span>
            <span class="n">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="kc">null</span> <span class="o">!=</span> <span class="n">args</span> <span class="o">&amp;&amp;</span> <span class="n">0</span> <span class="o">!=</span> <span class="n">args</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">arg</span> <span class="o">:</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">String</span> <span class="n">strPort</span> <span class="o">=</span> <span class="n">StrUtil</span><span class="o">.</span><span class="na">subAfter</span><span class="o">(</span><span class="n">arg</span><span class="o">,</span> <span class="s">&#34;port=&#34;</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">NumberUtil</span><span class="o">.</span><span class="na">isNumber</span><span class="o">(</span><span class="n">strPort</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">port</span> <span class="o">=</span> <span class="n">Convert</span><span class="o">.</span><span class="na">toInt</span><span class="o">(</span><span class="n">strPort</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">0</span> <span class="o">==</span> <span class="n">port</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Future</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">future</span> <span class="o">=</span> <span class="n">ThreadUtil</span><span class="o">.</span><span class="na">execAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
                <span class="kt">int</span> <span class="n">p</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">&#34;请于5秒内输入端口号，推荐%d，超过5秒默认使用端口%d&#34;</span><span class="o">,</span> <span class="n">defaultPort</span><span class="o">,</span> <span class="n">defaultPort</span><span class="o">);</span>
                <span class="n">Scanner</span> <span class="n">scanner</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Scanner</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">in</span><span class="o">);</span>
                <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">String</span> <span class="n">strPort</span> <span class="o">=</span> <span class="n">scanner</span><span class="o">.</span><span class="na">nextLine</span><span class="o">();</span>
                    <span class="k">if</span> <span class="o">(!</span><span class="n">NumberUtil</span><span class="o">.</span><span class="na">isInteger</span><span class="o">(</span><span class="n">strPort</span><span class="o">))</span> <span class="o">{</span>
                        <span class="n">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;只能是数字&#34;</span><span class="o">);</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                        <span class="n">p</span> <span class="o">=</span> <span class="n">Convert</span><span class="o">.</span><span class="na">toInt</span><span class="o">(</span><span class="n">strPort</span><span class="o">);</span>
                        <span class="n">scanner</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="k">return</span> <span class="n">p</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="k">return</span> <span class="n">p</span><span class="o">;</span>
            <span class="o">});</span>

            <span class="k">try</span> <span class="o">{</span>
                <span class="n">port</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">5</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ExecutionException</span> <span class="o">|</span> <span class="n">TimeoutException</span> <span class="o">|</span> <span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">port</span> <span class="o">=</span> <span class="n">defaultPort</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(!</span><span class="n">NetUtil</span><span class="o">.</span><span class="na">isUsableLocalPort</span><span class="o">(</span><span class="n">port</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">&#34;端口%d被占用了，无法启动%n&#34;</span><span class="o">,</span> <span class="n">port</span><span class="o">);</span>
            <span class="n">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">new</span> <span class="n">SpringApplicationBuilder</span><span class="o">(</span><span class="n">IndexDataApplication</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                <span class="o">.</span><span class="na">properties</span><span class="o">(</span><span class="s">&#34;server.port=&#34;</span> <span class="o">+</span> <span class="n">port</span><span class="o">)</span>
                <span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="n">Sampler</span> <span class="nf">defaultSampler</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">Sampler</span><span class="o">.</span><span class="na">ALWAYS_SAMPLE</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><h3 id="applicationyml-4">application.yml</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yml" data-lang="yml"><span class="k">spring</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">application</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">name</span><span class="p">:</span><span class="w"> </span>index-data-service<span class="w">
</span><span class="w">  </span><span class="k">zipkin</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">base-url</span><span class="p">:</span><span class="w"> </span>http<span class="p">:</span>//localhost<span class="p">:</span><span class="m">9411</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="k">eureka</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">client</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">service-url</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="k">defaultZone</span><span class="p">:</span><span class="w"> </span>http<span class="p">:</span>//localhost<span class="p">:</span><span class="m">8761</span>/eureka/<span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h3 id="config-2">config</h3>
<p>IpConfiguration.java</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">cn.qqlin.trend.config</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.boot.web.context.WebServerInitializedEvent</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.ApplicationListener</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Component</span><span class="o">;</span>

<span class="cm">/**
</span><span class="cm"> * 用于获取当前的端口号。
</span><span class="cm"> * 因为这个微服务会做成集群，不同的微服务使用的是不同的端口号，
</span><span class="cm"> * 可以通过获取并打印出来知道当前是哪个。
</span><span class="cm"> *
</span><span class="cm"> * @author qqlin
</span><span class="cm"> * @date 2020-6-13 23:00
</span><span class="cm"> */</span>
<span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">IpConfiguration</span> <span class="kd">implements</span> <span class="n">ApplicationListener</span><span class="o">&lt;</span><span class="n">WebServerInitializedEvent</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kt">int</span> <span class="n">serverPort</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onApplicationEvent</span><span class="o">(</span><span class="n">WebServerInitializedEvent</span> <span class="n">webServerInitializedEvent</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">serverPort</span> <span class="o">=</span> <span class="n">webServerInitializedEvent</span><span class="o">.</span><span class="na">getWebServer</span><span class="o">().</span><span class="na">getPort</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getServerPort</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">serverPort</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>RedisCacheConfig.java</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">cn.qqlin.trend.config</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.fasterxml.jackson.annotation.JsonAutoDetect</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.fasterxml.jackson.annotation.PropertyAccessor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.fasterxml.jackson.databind.ObjectMapper</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.context.properties.ConfigurationProperties</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cache.CacheManager</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.redis.cache.RedisCacheConfiguration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.redis.cache.RedisCacheManager</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.redis.connection.RedisConnectionFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.redis.serializer.Jackson2JsonRedisSerializer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.redis.serializer.RedisSerializationContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.redis.serializer.RedisSerializer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.data.redis.serializer.StringRedisSerializer</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.time.Duration</span><span class="o">;</span>

<span class="cm">/**
</span><span class="cm"> * @author qqlin
</span><span class="cm"> * @date 2020-6-13 23:03
</span><span class="cm"> */</span>
<span class="nd">@Configuration</span>
<span class="nd">@ConfigurationProperties</span><span class="o">(</span><span class="n">prefix</span> <span class="o">=</span> <span class="s">&#34;spring.cache.redis&#34;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RedisCacheConfig</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="n">Duration</span> <span class="n">timeToLive</span> <span class="o">=</span> <span class="n">Duration</span><span class="o">.</span><span class="na">ZERO</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTimeToLive</span><span class="o">(</span><span class="n">Duration</span> <span class="n">timeToLive</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">timeToLive</span> <span class="o">=</span> <span class="n">timeToLive</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="n">CacheManager</span> <span class="nf">cacheManager</span><span class="o">(</span><span class="n">RedisConnectionFactory</span> <span class="n">factory</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">RedisSerializer</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">redisSerializer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringRedisSerializer</span><span class="o">();</span>

        <span class="n">Jackson2JsonRedisSerializer</span> <span class="n">jackson2JsonRedisSerializer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Jackson2JsonRedisSerializer</span><span class="o">(</span><span class="n">Object</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

        <span class="c1">// 解决查询缓存转换异常的问题
</span><span class="c1"></span>        <span class="n">ObjectMapper</span> <span class="n">objectMapper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectMapper</span><span class="o">();</span>
        <span class="n">objectMapper</span><span class="o">.</span><span class="na">setVisibility</span><span class="o">(</span><span class="n">PropertyAccessor</span><span class="o">.</span><span class="na">ALL</span><span class="o">,</span> <span class="n">JsonAutoDetect</span><span class="o">.</span><span class="na">Visibility</span><span class="o">.</span><span class="na">PUBLIC_ONLY</span><span class="o">);</span>
        <span class="n">objectMapper</span><span class="o">.</span><span class="na">enableDefaultTyping</span><span class="o">(</span><span class="n">ObjectMapper</span><span class="o">.</span><span class="na">DefaultTyping</span><span class="o">.</span><span class="na">NON_FINAL</span><span class="o">);</span>
        <span class="n">jackson2JsonRedisSerializer</span><span class="o">.</span><span class="na">setObjectMapper</span><span class="o">(</span><span class="n">objectMapper</span><span class="o">);</span>

        <span class="c1">// 配置序列化（解决乱码的问题）
</span><span class="c1"></span>        <span class="n">RedisCacheConfiguration</span> <span class="n">configuration</span> <span class="o">=</span> <span class="n">RedisCacheConfiguration</span><span class="o">.</span><span class="na">defaultCacheConfig</span><span class="o">()</span>
                <span class="o">.</span><span class="na">entryTtl</span><span class="o">(</span><span class="n">timeToLive</span><span class="o">)</span>
                <span class="o">.</span><span class="na">serializeKeysWith</span><span class="o">(</span><span class="n">RedisSerializationContext</span><span class="o">.</span><span class="na">SerializationPair</span><span class="o">.</span><span class="na">fromSerializer</span><span class="o">(</span><span class="n">redisSerializer</span><span class="o">))</span>
                <span class="o">.</span><span class="na">serializeValuesWith</span><span class="o">(</span><span class="n">RedisSerializationContext</span><span class="o">.</span><span class="na">SerializationPair</span><span class="o">.</span><span class="na">fromSerializer</span><span class="o">(</span><span class="n">jackson2JsonRedisSerializer</span><span class="o">))</span>
                <span class="o">.</span><span class="na">disableCachingNullValues</span><span class="o">();</span>

        <span class="n">RedisCacheManager</span> <span class="n">cacheManager</span> <span class="o">=</span> <span class="n">RedisCacheManager</span><span class="o">.</span><span class="na">builder</span><span class="o">(</span><span class="n">factory</span><span class="o">)</span>
                <span class="o">.</span><span class="na">cacheDefaults</span><span class="o">(</span><span class="n">configuration</span><span class="o">)</span>
                <span class="o">.</span><span class="na">build</span><span class="o">();</span>

        <span class="k">return</span> <span class="n">cacheManager</span><span class="o">;</span>

    <span class="o">}</span>
<span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><h3 id="pojo-2">pojo</h3>
<p>IndexData.java</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">cn.qqlin.trend.pojo</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>

<span class="cm">/**
</span><span class="cm"> * @author qqlin
</span><span class="cm"> * @date 2020-6-14 0:00
</span><span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">IndexData</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="o">-</span><span class="n">9511000068712106L</span><span class="o">;</span>

    <span class="cm">/**
</span><span class="cm">     * 数据的日期
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">date</span><span class="o">;</span>

    <span class="cm">/**
</span><span class="cm">     * 收盘点
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kt">float</span> <span class="n">closePoint</span><span class="o">;</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getDate</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">date</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setDate</span><span class="o">(</span><span class="n">String</span> <span class="n">date</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">date</span> <span class="o">=</span> <span class="n">date</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">float</span> <span class="nf">getClosePoint</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">closePoint</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setClosePoint</span><span class="o">(</span><span class="kt">float</span> <span class="n">closePoint</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">closePoint</span> <span class="o">=</span> <span class="n">closePoint</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><h3 id="service-2">service</h3>
<p>IndexDataService.java</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">cn.qqlin.trend.service</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">cn.qqlin.trend.pojo.IndexData</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="cm">/**
</span><span class="cm"> * @author qqlin
</span><span class="cm"> * @date 2020-6-14 0:01
</span><span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">IndexDataService</span> <span class="o">{</span>

    <span class="cm">/**
</span><span class="cm">     * 从redis获取数据
</span><span class="cm">     *
</span><span class="cm">     * @param code 证券代码
</span><span class="cm">     * @return 返回所有的证券数据
</span><span class="cm">     */</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">IndexData</span><span class="o">&gt;</span> <span class="nf">get</span><span class="o">(</span><span class="n">String</span> <span class="n">code</span><span class="o">);</span>
<span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><p>impl.IndexDataServiceImpl</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">cn.qqlin.trend.service.impl</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">cn.qqlin.trend.pojo.IndexData</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">cn.qqlin.trend.service.IndexDataService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">cn.hutool.core.collection.CollUtil</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cache.annotation.CacheConfig</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cache.annotation.Cacheable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="cm">/**
</span><span class="cm"> * @author qqlin
</span><span class="cm"> * @date 2020-6-14 0:01
</span><span class="cm"> */</span>
<span class="nd">@Service</span>
<span class="nd">@CacheConfig</span><span class="o">(</span><span class="n">cacheNames</span> <span class="o">=</span> <span class="s">&#34;index_datas&#34;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">IndexDataServiceImpl</span> <span class="kd">implements</span> <span class="n">IndexDataService</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="nd">@Cacheable</span><span class="o">(</span><span class="n">key</span> <span class="o">=</span> <span class="s">&#34;&#39;indexData-code-&#39;+ #p0&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">IndexData</span><span class="o">&gt;</span> <span class="nf">get</span><span class="o">(</span><span class="n">String</span> <span class="n">code</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">CollUtil</span><span class="o">.</span><span class="na">toList</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><h3 id="web-2">web</h3>
<p>IndexDataController.java</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">cn.qqlin.trend.web</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">cn.qqlin.trend.config.IpConfiguration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">cn.qqlin.trend.pojo.IndexData</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">cn.qqlin.trend.service.IndexDataService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.GetMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.PathVariable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RestController</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="cm">/**
</span><span class="cm"> * @author qqlin
</span><span class="cm"> * @date 2020-6-14 0:07
</span><span class="cm"> */</span>
<span class="nd">@RestController</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">IndexDataController</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">IndexDataService</span> <span class="n">indexDataService</span><span class="o">;</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">IpConfiguration</span> <span class="n">ipConfiguration</span><span class="o">;</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">&#34;/data/{code}&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">IndexData</span><span class="o">&gt;</span> <span class="nf">get</span><span class="o">(</span><span class="nd">@PathVariable</span><span class="o">(</span><span class="s">&#34;code&#34;</span><span class="o">)</span> <span class="n">String</span> <span class="n">code</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;current instance is :&#34;</span> <span class="o">+</span> <span class="n">ipConfiguration</span><span class="o">.</span><span class="na">getServerPort</span><span class="o">());</span>
        <span class="k">return</span> <span class="n">indexDataService</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">code</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><p>先启动 EurekaServerApplication
然后启动 IndexDataApplication
访问地址：</p>
<p>http://127.0.0.1:8021/data/000300</p>
<h2 id="27-网关">2.7 网关</h2>
<h3 id="module-5">module</h3>
<p>新建一个module，命名为index-zuul-service，修改pom.xml为</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-xml" data-lang="xml"><span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
<span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0&#34;</span>
         <span class="na">xmlns:xsi=</span><span class="s">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
         <span class="na">xsi:schemaLocation=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&#34;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;parent&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>trendParentProject<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>cn.qqlin.trend<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/parent&gt;</span>
    <span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>

    <span class="nt">&lt;artifactId&gt;</span>index-zuul-service<span class="nt">&lt;/artifactId&gt;</span>

    <span class="nt">&lt;dependencies&gt;</span>
        <span class="c">&lt;!-- eureka-client --&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!-- springboot web --&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-web<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!--zuul--&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-zuul<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!--zipkin--&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-zipkin<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;/dependencies&gt;</span>

<span class="nt">&lt;/project&gt;</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="indexzuulserviceapplicationjava">IndexZuulServiceApplication.java</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">cn.qqlin.trend</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">brave.sampler.Sampler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">cn.hutool.core.util.NetUtil</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.autoconfigure.SpringBootApplication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.builder.SpringApplicationBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cloud.client.discovery.EnableDiscoveryClient</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cloud.netflix.eureka.EnableEurekaClient</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cloud.netflix.zuul.EnableZuulProxy</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="o">;</span>

<span class="cm">/**
</span><span class="cm"> * @author qqlin
</span><span class="cm"> * @date 2020-6-14 10:33
</span><span class="cm"> */</span>
<span class="nd">@SpringBootApplication</span>
<span class="nd">@EnableZuulProxy</span>
<span class="nd">@EnableEurekaClient</span>
<span class="nd">@EnableDiscoveryClient</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">IndexZuulServiceApplication</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="n">8031</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">NetUtil</span><span class="o">.</span><span class="na">isUsableLocalPort</span><span class="o">(</span><span class="n">port</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">&#34;端口%d被占用了，无法启动%n&#34;</span><span class="o">,</span> <span class="n">port</span><span class="o">);</span>
            <span class="n">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">new</span> <span class="n">SpringApplicationBuilder</span><span class="o">(</span><span class="n">IndexZuulServiceApplication</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                <span class="o">.</span><span class="na">properties</span><span class="o">(</span><span class="s">&#34;server.port=&#34;</span> <span class="o">+</span> <span class="n">port</span><span class="o">)</span>
                <span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="n">Sampler</span> <span class="nf">defaultSampler</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">Sampler</span><span class="o">.</span><span class="na">ALWAYS_SAMPLE</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="applicationyml-5">application.yml</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yml" data-lang="yml"><span class="k">spring</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">application</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">name</span><span class="p">:</span><span class="w"> </span>index-zuul-service<span class="w">
</span><span class="w">  </span><span class="k">zipkin</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">base-url</span><span class="p">:</span><span class="w"> </span>http<span class="p">:</span>//localhost<span class="p">:</span><span class="m">9411</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="k">eureka</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">client</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">service-url</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="k">defaultZone</span><span class="p">:</span><span class="w"> </span>http<span class="p">:</span>//localhost<span class="p">:</span><span class="m">8761</span>/eureka/<span class="w">
</span><span class="w">
</span><span class="w"></span><span class="k">zuul</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">routes</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">api-a</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="k">path</span><span class="p">:</span><span class="w"> </span>/api-codes/<span class="cp">**</span><span class="w">
</span><span class="w">      </span><span class="k">serviceId</span><span class="p">:</span><span class="w"> </span>INDEX-CODES-SERVICE<span class="w">
</span><span class="w">    </span><span class="k">api-b</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="k">path</span><span class="p">:</span><span class="w"> </span>/api-backtest/<span class="cp">**</span><span class="w">
</span><span class="w">      </span><span class="k">serviceId</span><span class="p">:</span><span class="w"> </span>TREND-TRADING-BACKTEST-SERVICE<span class="w">
</span><span class="w">    </span><span class="k">api-c</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="k">path</span><span class="p">:</span><span class="w"> </span>/api-view/<span class="cp">**</span><span class="w">
</span><span class="w">      </span><span class="k">serviceId</span><span class="p">:</span><span class="w"> </span>TREND-TRADING-BACKTEST-VIEW<span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h2 id="28-模拟回测微服务">2.8 模拟回测微服务</h2>
<h3 id="module-6">module</h3>
<p>新建一个module，命名为trend-trading-backtest-service，修改pom.xml为</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-xml" data-lang="xml"><span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>

<span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0&#34;</span> <span class="na">xmlns:xsi=</span><span class="s">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
         <span class="na">xsi:schemaLocation=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&#34;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;parent&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>trendParentProject<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>cn.qqlin.trend<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/parent&gt;</span>
    <span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>

    <span class="nt">&lt;artifactId&gt;</span>trend-trading-backtest-service<span class="nt">&lt;/artifactId&gt;</span>

    <span class="nt">&lt;dependencies&gt;</span>
        <span class="c">&lt;!-- springboot web --&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-web<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!-- eureka-client --&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!-- feign --&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-openfeign<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>

        <span class="c">&lt;!-- 断路器 --&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-hystrix<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!--zipkin--&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-zipkin<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!--监控接口--&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-actuator<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;/dependencies&gt;</span>
<span class="nt">&lt;/project&gt;</span>

</code></pre></td></tr></table>
</div>
</div><h3 id="trendtradingbacktestserviceapplication">TrendTradingBackTestServiceApplication</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">cn.qqlin.trend</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">brave.sampler.Sampler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">cn.hutool.core.convert.Convert</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">cn.hutool.core.thread.ThreadUtil</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">cn.hutool.core.util.NetUtil</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">cn.hutool.core.util.NumberUtil</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">cn.hutool.core.util.StrUtil</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.autoconfigure.SpringBootApplication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.builder.SpringApplicationBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cloud.client.circuitbreaker.EnableCircuitBreaker</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cloud.client.discovery.EnableDiscoveryClient</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cloud.netflix.eureka.EnableEurekaClient</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cloud.openfeign.EnableFeignClients</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Scanner</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.ExecutionException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.Future</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.TimeUnit</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.TimeoutException</span><span class="o">;</span>

<span class="cm">/**
</span><span class="cm"> * @author qqlin
</span><span class="cm"> * @date 2020-6-14 10:48
</span><span class="cm"> */</span>
<span class="nd">@SpringBootApplication</span>
<span class="nd">@EnableEurekaClient</span>
<span class="nd">@EnableDiscoveryClient</span>
<span class="nd">@EnableFeignClients</span>
<span class="nd">@EnableCircuitBreaker</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TrendTradingBackTestServiceApplication</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">defaultPort</span> <span class="o">=</span> <span class="n">8051</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">eurekaServerPort</span> <span class="o">=</span> <span class="n">8761</span><span class="o">;</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">NetUtil</span><span class="o">.</span><span class="na">isUsableLocalPort</span><span class="o">(</span><span class="n">eurekaServerPort</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">&#34;检查到端口%d 未启用，判断 eureka 服务器没有启动，本服务无法使用，故退出%n&#34;</span><span class="o">,</span> <span class="n">eurekaServerPort</span><span class="o">);</span>
            <span class="n">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="kc">null</span> <span class="o">!=</span> <span class="n">args</span> <span class="o">&amp;&amp;</span> <span class="n">0</span> <span class="o">!=</span> <span class="n">args</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">arg</span> <span class="o">:</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">arg</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">&#34;port=&#34;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">String</span> <span class="n">strPort</span> <span class="o">=</span> <span class="n">StrUtil</span><span class="o">.</span><span class="na">subAfter</span><span class="o">(</span><span class="n">arg</span><span class="o">,</span> <span class="s">&#34;port=&#34;</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">NumberUtil</span><span class="o">.</span><span class="na">isNumber</span><span class="o">(</span><span class="n">strPort</span><span class="o">))</span> <span class="o">{</span>
                        <span class="n">port</span> <span class="o">=</span> <span class="n">Convert</span><span class="o">.</span><span class="na">toInt</span><span class="o">(</span><span class="n">strPort</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">0</span> <span class="o">==</span> <span class="n">port</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Future</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">future</span> <span class="o">=</span> <span class="n">ThreadUtil</span><span class="o">.</span><span class="na">execAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
                <span class="kt">int</span> <span class="n">p</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">&#34;请于5秒钟内输入端口号, 推荐  %d ,超过5秒将默认使用 %d &#34;</span><span class="o">,</span> <span class="n">defaultPort</span><span class="o">,</span> <span class="n">defaultPort</span><span class="o">);</span>
                <span class="n">Scanner</span> <span class="n">scanner</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Scanner</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">in</span><span class="o">);</span>
                <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">String</span> <span class="n">strPort</span> <span class="o">=</span> <span class="n">scanner</span><span class="o">.</span><span class="na">nextLine</span><span class="o">();</span>
                    <span class="k">if</span> <span class="o">(!</span><span class="n">NumberUtil</span><span class="o">.</span><span class="na">isInteger</span><span class="o">(</span><span class="n">strPort</span><span class="o">))</span> <span class="o">{</span>
                        <span class="n">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;只能是数字&#34;</span><span class="o">);</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                        <span class="n">p</span> <span class="o">=</span> <span class="n">Convert</span><span class="o">.</span><span class="na">toInt</span><span class="o">(</span><span class="n">strPort</span><span class="o">);</span>
                        <span class="n">scanner</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
                <span class="k">return</span> <span class="n">p</span><span class="o">;</span>
            <span class="o">});</span>
            
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">port</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">5</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="o">|</span> <span class="n">ExecutionException</span> <span class="o">|</span> <span class="n">TimeoutException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">port</span> <span class="o">=</span> <span class="n">defaultPort</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(!</span><span class="n">NetUtil</span><span class="o">.</span><span class="na">isUsableLocalPort</span><span class="o">(</span><span class="n">port</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">&#34;端口%d被占用了，无法启动%n&#34;</span><span class="o">,</span> <span class="n">port</span><span class="o">);</span>
            <span class="n">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
        <span class="o">}</span>
        
        <span class="k">new</span> <span class="n">SpringApplicationBuilder</span><span class="o">(</span><span class="n">TrendTradingBackTestServiceApplication</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                <span class="o">.</span><span class="na">properties</span><span class="o">(</span><span class="s">&#34;server.port=&#34;</span> <span class="o">+</span> <span class="n">port</span><span class="o">)</span>
                <span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="n">Sampler</span> <span class="nf">defaultSampler</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">Sampler</span><span class="o">.</span><span class="na">ALWAYS_SAMPLE</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><h3 id="applicationyml-6">application.yml</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yml" data-lang="yml"><span class="k">spring</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">application</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">name</span><span class="p">:</span><span class="w"> </span>trend-trading-backtest-service<span class="w">
</span><span class="w">  </span><span class="k">zipkin</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">base-url</span><span class="p">:</span><span class="w"> </span>http<span class="p">:</span>//localhost<span class="p">:</span><span class="m">9411</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="k">eureka</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">client</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">service-url</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="k">defaultZone</span><span class="p">:</span><span class="w"> </span>http<span class="p">:</span>//localhost<span class="p">:</span><span class="m">8761</span>/eureka/<span class="w">
</span><span class="w">
</span><span class="w"></span><span class="k">feign.hystrix.enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="k">management</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">endpoints</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">web</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="k">exposure</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="k">include</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;*&#34;</span><span class="w">
</span><span class="w">      </span><span class="k">cors</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="k">allowed-methods</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;*&#34;</span><span class="w">
</span><span class="w">        </span><span class="k">allowed-origins</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;*&#34;</span><span class="w">
</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h3 id="client">client</h3>
<p>IndexDataClient.java</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">cn.qqlin.trend.client</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">cn.qqlin.trend.pojo.IndexData</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cloud.openfeign.FeignClient</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Primary</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.GetMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.PathVariable</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="cm">/**
</span><span class="cm"> * @author qqlin
</span><span class="cm"> * @date 2020-6-14 10:54
</span><span class="cm"> */</span>
<span class="nd">@Primary</span>
<span class="nd">@FeignClient</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;INDEX-DATA-SERVICE&#34;</span><span class="o">,</span> <span class="n">fallback</span> <span class="o">=</span> <span class="n">IndexDataClientFeignHystrix</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">IndexDataClient</span> <span class="o">{</span>

    <span class="cm">/**
</span><span class="cm">     * 根据指数代码获取指数数据
</span><span class="cm">     *
</span><span class="cm">     * @param code 指数代码
</span><span class="cm">     * @return 返回所有查询数据
</span><span class="cm">     */</span>
    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">&#34;/data/{code}&#34;</span><span class="o">)</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">IndexData</span><span class="o">&gt;</span> <span class="nf">getIndexData</span><span class="o">(</span><span class="nd">@PathVariable</span><span class="o">(</span><span class="s">&#34;code&#34;</span><span class="o">)</span> <span class="n">String</span> <span class="n">code</span><span class="o">);</span>
<span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><p>IndexDataClientFeignHystrix.java</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">cn.qqlin.trend.client</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">cn.qqlin.trend.pojo.IndexData</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">cn.hutool.core.collection.CollectionUtil</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Component</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="cm">/**
</span><span class="cm"> * @author qqlin
</span><span class="cm"> * @date 2020-6-14 10:56
</span><span class="cm"> */</span>
<span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">IndexDataClientFeignHystrix</span> <span class="kd">implements</span> <span class="n">IndexDataClient</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">IndexData</span><span class="o">&gt;</span> <span class="nf">getIndexData</span><span class="o">(</span><span class="n">String</span> <span class="n">code</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">IndexData</span> <span class="n">indexData</span> <span class="o">=</span> <span class="k">new</span> <span class="n">IndexData</span><span class="o">();</span>
        <span class="n">indexData</span><span class="o">.</span><span class="na">setClosePoint</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>
        <span class="n">indexData</span><span class="o">.</span><span class="na">setDate</span><span class="o">(</span><span class="s">&#34;0000-00-00&#34;</span><span class="o">);</span>

        <span class="k">return</span> <span class="n">CollectionUtil</span><span class="o">.</span><span class="na">toList</span><span class="o">(</span><span class="n">indexData</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><h3 id="pojo-3">pojo</h3>
<p>IndexData.java</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">cn.qqlin.trend.pojo</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>

<span class="cm">/**
</span><span class="cm"> * @author qqlin
</span><span class="cm"> * @date 2020-6-14 10:52
</span><span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">IndexData</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="o">-</span><span class="n">9511000068712106L</span><span class="o">;</span>

    <span class="cm">/**
</span><span class="cm">     * 数据的日期
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">date</span><span class="o">;</span>

    <span class="cm">/**
</span><span class="cm">     * 收盘点
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kt">float</span> <span class="n">closePoint</span><span class="o">;</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getDate</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">date</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setDate</span><span class="o">(</span><span class="n">String</span> <span class="n">date</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">date</span> <span class="o">=</span> <span class="n">date</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">float</span> <span class="nf">getClosePoint</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">closePoint</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setClosePoint</span><span class="o">(</span><span class="kt">float</span> <span class="n">closePoint</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">closePoint</span> <span class="o">=</span> <span class="n">closePoint</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><p>Profit.java</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">cn.qqlin.trend.pojo</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>

<span class="cm">/**
</span><span class="cm"> * @author qqlin
</span><span class="cm"> * @date 2020-6-15 14:19
</span><span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Profit</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="n">2787659230368197107L</span><span class="o">;</span>

    <span class="cm">/**
</span><span class="cm">     * 收益日期
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">date</span><span class="o">;</span>

    <span class="cm">/**
</span><span class="cm">     * 收益的值
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kt">float</span> <span class="n">value</span><span class="o">;</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getDate</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">date</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setDate</span><span class="o">(</span><span class="n">String</span> <span class="n">date</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">date</span> <span class="o">=</span> <span class="n">date</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">float</span> <span class="nf">getValue</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">value</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setValue</span><span class="o">(</span><span class="kt">float</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><p>Trade.java</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">cn.qqlin.trend.pojo</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>

<span class="cm">/**
</span><span class="cm"> * @author qqlin
</span><span class="cm"> * @date 2020-6-15 17:17
</span><span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Trade</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="n">3916642514594342236L</span><span class="o">;</span>

    <span class="cm">/**
</span><span class="cm">     * 买入阈值
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">buyDate</span><span class="o">;</span>

    <span class="cm">/**
</span><span class="cm">     * 卖出阈值
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">sellDate</span><span class="o">;</span>

    <span class="cm">/**
</span><span class="cm">     * 买入收盘点
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kt">float</span> <span class="n">buyClosePoint</span><span class="o">;</span>

    <span class="cm">/**
</span><span class="cm">     * 卖出收盘点
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kt">float</span> <span class="n">sellClosePoint</span><span class="o">;</span>

    <span class="cm">/**
</span><span class="cm">     * 收益率
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kt">float</span> <span class="n">rate</span><span class="o">;</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getBuyDate</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">buyDate</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setBuyDate</span><span class="o">(</span><span class="n">String</span> <span class="n">buyDate</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">buyDate</span> <span class="o">=</span> <span class="n">buyDate</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getSellDate</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">sellDate</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setSellDate</span><span class="o">(</span><span class="n">String</span> <span class="n">sellDate</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">sellDate</span> <span class="o">=</span> <span class="n">sellDate</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">float</span> <span class="nf">getBuyClosePoint</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">buyClosePoint</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setBuyClosePoint</span><span class="o">(</span><span class="kt">float</span> <span class="n">buyClosePoint</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">buyClosePoint</span> <span class="o">=</span> <span class="n">buyClosePoint</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">float</span> <span class="nf">getSellClosePoint</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">sellClosePoint</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setSellClosePoint</span><span class="o">(</span><span class="kt">float</span> <span class="n">sellClosePoint</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">sellClosePoint</span> <span class="o">=</span> <span class="n">sellClosePoint</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">float</span> <span class="nf">getRate</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">rate</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setRate</span><span class="o">(</span><span class="kt">float</span> <span class="n">rate</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">rate</span> <span class="o">=</span> <span class="n">rate</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><p>AnnualProfit.java</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">cn.qqlin.trend.pojo</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>

<span class="cm">/**
</span><span class="cm"> * @author qqlin
</span><span class="cm"> * @date 2020-6-15 22:08
</span><span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AnnualProfit</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="o">-</span><span class="n">7418682840805152436L</span><span class="o">;</span>
    <span class="cm">/**
</span><span class="cm">     * 当期的年份
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">year</span><span class="o">;</span>

    <span class="cm">/**
</span><span class="cm">     * 指数投资的收益
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kt">float</span> <span class="n">indexIncome</span><span class="o">;</span>

    <span class="cm">/**
</span><span class="cm">     * 趋势投资的收益
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="kt">float</span> <span class="n">trendIncome</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getYear</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">year</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setYear</span><span class="o">(</span><span class="kt">int</span> <span class="n">year</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">year</span> <span class="o">=</span> <span class="n">year</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">float</span> <span class="nf">getIndexIncome</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">indexIncome</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setIndexIncome</span><span class="o">(</span><span class="kt">float</span> <span class="n">indexIncome</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">indexIncome</span> <span class="o">=</span> <span class="n">indexIncome</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">float</span> <span class="nf">getTrendIncome</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">trendIncome</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTrendIncome</span><span class="o">(</span><span class="kt">float</span> <span class="n">trendIncome</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">trendIncome</span> <span class="o">=</span> <span class="n">trendIncome</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">&#34;AnnualProfit{&#34;</span> <span class="o">+</span>
                <span class="s">&#34;year=&#34;</span> <span class="o">+</span> <span class="n">year</span> <span class="o">+</span>
                <span class="s">&#34;, indexIncome=&#34;</span> <span class="o">+</span> <span class="n">indexIncome</span> <span class="o">+</span>
                <span class="s">&#34;, trendIncome=&#34;</span> <span class="o">+</span> <span class="n">trendIncome</span> <span class="o">+</span>
                <span class="sc">&#39;}&#39;</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><h3 id="service-3">service</h3>
<p>BackTestService.java</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">cn.qqlin.trend.service</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">cn.qqlin.trend.pojo.AnnualProfit</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">cn.qqlin.trend.pojo.IndexData</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">cn.qqlin.trend.pojo.Profit</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="cm">/**
</span><span class="cm"> * @author qqlin
</span><span class="cm"> * @date 2020-6-14 10:58
</span><span class="cm"> */</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">BackTestService</span> <span class="o">{</span>

    <span class="cm">/**
</span><span class="cm">     * 获取指数数据
</span><span class="cm">     *
</span><span class="cm">     * @param code 证券代码
</span><span class="cm">     * @return 返回指数代码对应的所有数据
</span><span class="cm">     */</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">IndexData</span><span class="o">&gt;</span> <span class="nf">indexDataList</span><span class="o">(</span><span class="n">String</span> <span class="n">code</span><span class="o">);</span>

    <span class="cm">/**
</span><span class="cm">     * 存放模拟数据中的相关计算数值
</span><span class="cm">     *
</span><span class="cm">     * @param movingAverageDay MA 均线：MA 即 moving average, 移动均线的意思。 比如MA20就表示20日均线，取最近20天的值的平均数。
</span><span class="cm">     *                         如果当前的收盘点高于这个均线一定的比例，那么我们认为上涨的趋势可能就来了，就可以买了。
</span><span class="cm">     * @param sellRate         出售阈值：如果当前的收盘点，比起最近的20个交易日里的最高的点，跌了 5%或者 10%了，
</span><span class="cm">     *                         那么我们认为下跌趋势可能就来了，就可以卖了。
</span><span class="cm">     * @param buyRate          买入阈值：如果当前的收盘点，比起最近的20个交易日里的最高的点，涨了 5%或者 10%了，
</span><span class="cm">     *                         那么我们认为下跌趋势可能就来了，就可以买了。
</span><span class="cm">     * @param serviceCharge    服务手续费
</span><span class="cm">     * @param indexDatas       指数的数据，用于计算
</span><span class="cm">     * @return 存入Map中的相关计算数值
</span><span class="cm">     */</span>
    <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="nf">simulate</span><span class="o">(</span><span class="kt">int</span> <span class="n">movingAverageDay</span><span class="o">,</span> <span class="kt">float</span> <span class="n">sellRate</span><span class="o">,</span> <span class="kt">float</span> <span class="n">buyRate</span><span class="o">,</span>
                                 <span class="kt">float</span> <span class="n">serviceCharge</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">IndexData</span><span class="o">&gt;</span> <span class="n">indexDatas</span><span class="o">);</span>

    <span class="cm">/**
</span><span class="cm">     * 用于计算当前的时间范围是多少年。
</span><span class="cm">     *
</span><span class="cm">     * @param allIndexDatas 该指数的所有值
</span><span class="cm">     * @return 总共的年份
</span><span class="cm">     */</span>
    <span class="kt">float</span> <span class="nf">getYears</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">IndexData</span><span class="o">&gt;</span> <span class="n">allIndexDatas</span><span class="o">);</span>

    <span class="cm">/**
</span><span class="cm">     * 获取某个日期里的年份
</span><span class="cm">     *
</span><span class="cm">     * @param date 日期
</span><span class="cm">     * @return 返回哪一年
</span><span class="cm">     */</span>
    <span class="kt">int</span> <span class="nf">getYear</span><span class="o">(</span><span class="n">String</span> <span class="n">date</span><span class="o">);</span>

    <span class="cm">/**
</span><span class="cm">     * 计算某一年的指数投资收益
</span><span class="cm">     *
</span><span class="cm">     * @param year       某一年
</span><span class="cm">     * @param indexdatas 所有的指数数据
</span><span class="cm">     * @return 返回指数投资收益
</span><span class="cm">     */</span>
    <span class="kt">float</span> <span class="nf">getIndexIncome</span><span class="o">(</span><span class="kt">int</span> <span class="n">year</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">IndexData</span><span class="o">&gt;</span> <span class="n">indexdatas</span><span class="o">);</span>

    <span class="cm">/**
</span><span class="cm">     * 计算某一年的趋势投资收益
</span><span class="cm">     *
</span><span class="cm">     * @param year    某一年
</span><span class="cm">     * @param profits 所有的收益
</span><span class="cm">     * @return 返回趋势投资的收益
</span><span class="cm">     */</span>
    <span class="kt">float</span> <span class="nf">getTrendIncome</span><span class="o">(</span><span class="kt">int</span> <span class="n">year</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Profit</span><span class="o">&gt;</span> <span class="n">profits</span><span class="o">);</span>

    <span class="cm">/**
</span><span class="cm">     * 计算完整时间范围内，每一年的指数投资的收益和趋势投资的收益
</span><span class="cm">     *
</span><span class="cm">     * @param indexDatas 所有的指数数据
</span><span class="cm">     * @param profits    所有的收益
</span><span class="cm">     * @return 某一年的收益
</span><span class="cm">     */</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">AnnualProfit</span><span class="o">&gt;</span> <span class="nf">calculateAnnualProfits</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">IndexData</span><span class="o">&gt;</span> <span class="n">indexDatas</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Profit</span><span class="o">&gt;</span> <span class="n">profits</span><span class="o">);</span>

<span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><p>impl.BackTestServiceImpl</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">cn.qqlin.trend.service.impl</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">cn.qqlin.trend.client.IndexDataClient</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">cn.qqlin.trend.pojo.AnnualProfit</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">cn.qqlin.trend.pojo.IndexData</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">cn.qqlin.trend.pojo.Profit</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">cn.qqlin.trend.pojo.Trade</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">cn.qqlin.trend.service.BackTestService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">cn.hutool.core.convert.Convert</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">cn.hutool.core.date.DateUnit</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">cn.hutool.core.date.DateUtil</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">cn.hutool.core.util.StrUtil</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.*</span><span class="o">;</span>

<span class="cm">/**
</span><span class="cm"> * @author qqlin
</span><span class="cm"> * @date 2020-6-14 10:59
</span><span class="cm"> */</span>
<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BackTestServiceImpl</span> <span class="kd">implements</span> <span class="n">BackTestService</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">IndexDataClient</span> <span class="n">indexDataClient</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">IndexData</span><span class="o">&gt;</span> <span class="nf">indexDataList</span><span class="o">(</span><span class="n">String</span> <span class="n">code</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">IndexData</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">indexDataClient</span><span class="o">.</span><span class="na">getIndexData</span><span class="o">(</span><span class="n">code</span><span class="o">);</span>
        <span class="n">Collections</span><span class="o">.</span><span class="na">reverse</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>

<span class="c1">//        for (IndexData indexData : result) {
</span><span class="c1">//            System.out.println(indexData.getDate());
</span><span class="c1">//        }
</span><span class="c1"></span>
        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="nf">simulate</span><span class="o">(</span><span class="kt">int</span> <span class="n">movingAverageDay</span><span class="o">,</span> <span class="kt">float</span> <span class="n">sellRate</span><span class="o">,</span> <span class="kt">float</span> <span class="n">buyRate</span><span class="o">,</span>
                                        <span class="kt">float</span> <span class="n">serviceCharge</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">IndexData</span><span class="o">&gt;</span> <span class="n">indexDatas</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Profit</span><span class="o">&gt;</span> <span class="n">profits</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Trade</span><span class="o">&gt;</span> <span class="n">trades</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>

        <span class="c1">// 初始现金
</span><span class="c1"></span>        <span class="kt">float</span> <span class="n">initCash</span> <span class="o">=</span> <span class="n">1000</span><span class="o">;</span>
        <span class="c1">// 现金
</span><span class="c1"></span>        <span class="kt">float</span> <span class="n">cash</span> <span class="o">=</span> <span class="n">initCash</span><span class="o">;</span>
        <span class="c1">// 份额
</span><span class="c1"></span>        <span class="kt">float</span> <span class="n">share</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
        <span class="c1">// 份值
</span><span class="c1"></span>        <span class="kt">float</span> <span class="n">value</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>

        <span class="c1">//盈利交易次数
</span><span class="c1"></span>        <span class="kt">int</span> <span class="n">winCount</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
        <span class="kt">float</span> <span class="n">totalWinRate</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
        <span class="kt">float</span> <span class="n">avgWinRate</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>

        <span class="c1">//亏损交易次数
</span><span class="c1"></span>        <span class="kt">int</span> <span class="n">lossCount</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
        <span class="kt">float</span> <span class="n">totalLossRate</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
        <span class="kt">float</span> <span class="n">avgLossRate</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>

        <span class="c1">// 初始收盘点
</span><span class="c1"></span>        <span class="kt">float</span> <span class="n">init</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">indexDatas</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">init</span> <span class="o">=</span> <span class="n">indexDatas</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">0</span><span class="o">).</span><span class="na">getClosePoint</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">indexDatas</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">IndexData</span> <span class="n">indexData</span> <span class="o">=</span> <span class="n">indexDatas</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
            <span class="kt">float</span> <span class="n">closePoint</span> <span class="o">=</span> <span class="n">indexData</span><span class="o">.</span><span class="na">getClosePoint</span><span class="o">();</span>
            <span class="kt">float</span> <span class="n">avg</span> <span class="o">=</span> <span class="n">getMA</span><span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="n">movingAverageDay</span><span class="o">,</span> <span class="n">indexDatas</span><span class="o">);</span>
            <span class="kt">float</span> <span class="n">max</span> <span class="o">=</span> <span class="n">getMax</span><span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="n">movingAverageDay</span><span class="o">,</span> <span class="n">indexDatas</span><span class="o">);</span>

            <span class="kt">float</span> <span class="n">increase_rate</span> <span class="o">=</span> <span class="n">closePoint</span> <span class="o">/</span> <span class="n">avg</span><span class="o">;</span>
            <span class="kt">float</span> <span class="n">decrease_rate</span> <span class="o">=</span> <span class="n">closePoint</span> <span class="o">/</span> <span class="n">max</span><span class="o">;</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">avg</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// buy 超过了均线
</span><span class="c1"></span>                <span class="k">if</span> <span class="o">(</span><span class="n">increase_rate</span> <span class="o">&gt;</span> <span class="n">buyRate</span><span class="o">)</span> <span class="o">{</span>
                    <span class="c1">// 如果没买
</span><span class="c1"></span>                    <span class="k">if</span> <span class="o">(</span><span class="n">0</span> <span class="o">==</span> <span class="n">share</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">share</span> <span class="o">=</span> <span class="n">cash</span> <span class="o">/</span> <span class="n">closePoint</span><span class="o">;</span>
                        <span class="n">cash</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>

                        <span class="n">Trade</span> <span class="n">trade</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Trade</span><span class="o">();</span>
                        <span class="n">trade</span><span class="o">.</span><span class="na">setBuyDate</span><span class="o">(</span><span class="n">indexData</span><span class="o">.</span><span class="na">getDate</span><span class="o">());</span>
                        <span class="n">trade</span><span class="o">.</span><span class="na">setBuyClosePoint</span><span class="o">(</span><span class="n">indexData</span><span class="o">.</span><span class="na">getClosePoint</span><span class="o">());</span>
                        <span class="n">trade</span><span class="o">.</span><span class="na">setSellDate</span><span class="o">(</span><span class="s">&#34;n/a&#34;</span><span class="o">);</span>
                        <span class="n">trade</span><span class="o">.</span><span class="na">setSellClosePoint</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>
                        <span class="n">trades</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">trade</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">}</span>
                <span class="c1">//sell 低于了卖点
</span><span class="c1"></span>                <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">decrease_rate</span> <span class="o">&lt;</span> <span class="n">sellRate</span><span class="o">)</span> <span class="o">{</span>
                    <span class="c1">// 如果没卖
</span><span class="c1"></span>                    <span class="k">if</span> <span class="o">(</span><span class="n">0</span> <span class="o">!=</span> <span class="n">share</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">cash</span> <span class="o">=</span> <span class="n">closePoint</span> <span class="o">*</span> <span class="n">share</span> <span class="o">*</span> <span class="o">(</span><span class="n">1</span> <span class="o">-</span> <span class="n">serviceCharge</span><span class="o">);</span>
                        <span class="n">share</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>

                        <span class="n">Trade</span> <span class="n">trade</span> <span class="o">=</span> <span class="n">trades</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">trades</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">-</span> <span class="n">1</span><span class="o">);</span>
                        <span class="n">trade</span><span class="o">.</span><span class="na">setSellDate</span><span class="o">(</span><span class="n">indexData</span><span class="o">.</span><span class="na">getDate</span><span class="o">());</span>
                        <span class="n">trade</span><span class="o">.</span><span class="na">setSellClosePoint</span><span class="o">(</span><span class="n">indexData</span><span class="o">.</span><span class="na">getClosePoint</span><span class="o">());</span>

                        <span class="kt">float</span> <span class="n">rate</span> <span class="o">=</span> <span class="n">cash</span> <span class="o">/</span> <span class="n">initCash</span><span class="o">;</span>
                        <span class="n">trade</span><span class="o">.</span><span class="na">setRate</span><span class="o">(</span><span class="n">rate</span><span class="o">);</span>

                        <span class="k">if</span> <span class="o">(</span><span class="n">trade</span><span class="o">.</span><span class="na">getSellClosePoint</span><span class="o">()</span> <span class="o">-</span> <span class="n">trade</span><span class="o">.</span><span class="na">getBuyClosePoint</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">totalWinRate</span> <span class="o">+=</span> <span class="o">(</span><span class="n">trade</span><span class="o">.</span><span class="na">getSellClosePoint</span><span class="o">()</span> <span class="o">-</span> <span class="n">trade</span><span class="o">.</span><span class="na">getBuyClosePoint</span><span class="o">())</span> <span class="o">/</span> <span class="n">trade</span><span class="o">.</span><span class="na">getBuyClosePoint</span><span class="o">();</span>
                            <span class="n">winCount</span><span class="o">++;</span>
                        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                            <span class="n">totalLossRate</span> <span class="o">+=</span> <span class="o">(</span><span class="n">trade</span><span class="o">.</span><span class="na">getSellClosePoint</span><span class="o">()</span> <span class="o">-</span> <span class="n">trade</span><span class="o">.</span><span class="na">getBuyClosePoint</span><span class="o">())</span> <span class="o">/</span> <span class="n">trade</span><span class="o">.</span><span class="na">getBuyClosePoint</span><span class="o">();</span>
                            <span class="n">lossCount</span><span class="o">++;</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span>
                <span class="c1">// do nothing
</span><span class="c1"></span>                <span class="k">else</span> <span class="o">{</span>

                <span class="o">}</span>
            <span class="o">}</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">share</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">closePoint</span> <span class="o">*</span> <span class="n">share</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">cash</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="kt">float</span> <span class="n">rate</span> <span class="o">=</span> <span class="n">value</span> <span class="o">/</span> <span class="n">initCash</span><span class="o">;</span>

            <span class="n">Profit</span> <span class="n">profit</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Profit</span><span class="o">();</span>
            <span class="n">profit</span><span class="o">.</span><span class="na">setDate</span><span class="o">(</span><span class="n">indexData</span><span class="o">.</span><span class="na">getDate</span><span class="o">());</span>
            <span class="n">profit</span><span class="o">.</span><span class="na">setValue</span><span class="o">(</span><span class="n">rate</span> <span class="o">*</span> <span class="n">init</span><span class="o">);</span>

<span class="c1">//            System.out.println(&#34;profit.value:&#34; + profit.getValue());
</span><span class="c1"></span>            <span class="n">profits</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">profit</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="n">avgWinRate</span> <span class="o">=</span> <span class="n">totalWinRate</span> <span class="o">/</span> <span class="n">winCount</span><span class="o">;</span>
        <span class="n">avgLossRate</span> <span class="o">=</span> <span class="n">totalLossRate</span> <span class="o">/</span> <span class="n">lossCount</span><span class="o">;</span>

        <span class="n">List</span><span class="o">&lt;</span><span class="n">AnnualProfit</span><span class="o">&gt;</span> <span class="n">annualProfits</span> <span class="o">=</span> <span class="n">calculateAnnualProfits</span><span class="o">(</span><span class="n">indexDatas</span><span class="o">,</span> <span class="n">profits</span><span class="o">);</span>

        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
        <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;profits&#34;</span><span class="o">,</span> <span class="n">profits</span><span class="o">);</span>
        <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;trades&#34;</span><span class="o">,</span> <span class="n">trades</span><span class="o">);</span>

        <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;winCount&#34;</span><span class="o">,</span> <span class="n">winCount</span><span class="o">);</span>
        <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;lossCount&#34;</span><span class="o">,</span> <span class="n">lossCount</span><span class="o">);</span>
        <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;avgWinRate&#34;</span><span class="o">,</span> <span class="n">avgWinRate</span><span class="o">);</span>
        <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;avgLossRate&#34;</span><span class="o">,</span> <span class="n">avgLossRate</span><span class="o">);</span>

        <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;annualProfits&#34;</span><span class="o">,</span> <span class="n">annualProfits</span><span class="o">);</span>

        <span class="k">return</span> <span class="n">map</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">float</span> <span class="nf">getMax</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">,</span> <span class="kt">int</span> <span class="n">day</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">IndexData</span><span class="o">&gt;</span> <span class="n">indexDatas</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">start</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="n">1</span> <span class="o">-</span> <span class="n">day</span><span class="o">;</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">start</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kt">int</span> <span class="n">now</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="n">1</span><span class="o">;</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">start</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">0</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kt">float</span> <span class="n">max</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">start</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">now</span><span class="o">;</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">IndexData</span> <span class="n">bean</span> <span class="o">=</span> <span class="n">indexDatas</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">j</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">bean</span><span class="o">.</span><span class="na">getClosePoint</span><span class="o">()</span> <span class="o">&gt;</span> <span class="n">max</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">max</span> <span class="o">=</span> <span class="n">bean</span><span class="o">.</span><span class="na">getClosePoint</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">max</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">float</span> <span class="nf">getMA</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">,</span> <span class="kt">int</span> <span class="n">day</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">IndexData</span><span class="o">&gt;</span> <span class="n">indexDatas</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">start</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="n">1</span> <span class="o">-</span> <span class="n">day</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">now</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="n">1</span><span class="o">;</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">start</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">0</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kt">float</span> <span class="n">sum</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
        <span class="kt">float</span> <span class="n">avg</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">start</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">now</span><span class="o">;</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">IndexData</span> <span class="n">bean</span> <span class="o">=</span> <span class="n">indexDatas</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">j</span><span class="o">);</span>
            <span class="n">sum</span> <span class="o">+=</span> <span class="n">bean</span><span class="o">.</span><span class="na">getClosePoint</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="n">avg</span> <span class="o">=</span> <span class="n">sum</span> <span class="o">/</span> <span class="o">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">start</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">avg</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">float</span> <span class="nf">getYears</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">IndexData</span><span class="o">&gt;</span> <span class="n">allIndexDatas</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">float</span> <span class="n">years</span><span class="o">;</span>
        <span class="n">String</span> <span class="n">sDateStart</span> <span class="o">=</span> <span class="n">allIndexDatas</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">0</span><span class="o">).</span><span class="na">getDate</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">sDateEnd</span> <span class="o">=</span> <span class="n">allIndexDatas</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">allIndexDatas</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">-</span> <span class="n">1</span><span class="o">).</span><span class="na">getDate</span><span class="o">();</span>

        <span class="n">Date</span> <span class="n">dateStart</span> <span class="o">=</span> <span class="n">DateUtil</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">sDateStart</span><span class="o">);</span>
        <span class="n">Date</span> <span class="n">dateEnd</span> <span class="o">=</span> <span class="n">DateUtil</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">sDateEnd</span><span class="o">);</span>

        <span class="kt">long</span> <span class="n">days</span> <span class="o">=</span> <span class="n">DateUtil</span><span class="o">.</span><span class="na">between</span><span class="o">(</span><span class="n">dateStart</span><span class="o">,</span> <span class="n">dateEnd</span><span class="o">,</span> <span class="n">DateUnit</span><span class="o">.</span><span class="na">DAY</span><span class="o">);</span>
        <span class="n">years</span> <span class="o">=</span> <span class="n">days</span> <span class="o">/</span> <span class="n">365f</span><span class="o">;</span>
        <span class="k">return</span> <span class="n">years</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getYear</span><span class="o">(</span><span class="n">String</span> <span class="n">date</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">strYear</span> <span class="o">=</span> <span class="n">StrUtil</span><span class="o">.</span><span class="na">subBefore</span><span class="o">(</span><span class="n">date</span><span class="o">,</span> <span class="s">&#34;-&#34;</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">Convert</span><span class="o">.</span><span class="na">toInt</span><span class="o">(</span><span class="n">strYear</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">float</span> <span class="nf">getIndexIncome</span><span class="o">(</span><span class="kt">int</span> <span class="n">year</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">IndexData</span><span class="o">&gt;</span> <span class="n">indexdatas</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">IndexData</span> <span class="n">firstIndexData</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="n">IndexData</span> <span class="n">lastIndexData</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

        <span class="k">for</span> <span class="o">(</span><span class="n">IndexData</span> <span class="n">indexData</span> <span class="o">:</span> <span class="n">indexdatas</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">String</span> <span class="n">strDate</span> <span class="o">=</span> <span class="n">indexData</span><span class="o">.</span><span class="na">getDate</span><span class="o">();</span>
            <span class="kt">int</span> <span class="n">currentYear</span> <span class="o">=</span> <span class="n">getYear</span><span class="o">(</span><span class="n">strDate</span><span class="o">);</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">currentYear</span> <span class="o">==</span> <span class="n">year</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="kc">null</span> <span class="o">==</span> <span class="n">firstIndexData</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">firstIndexData</span> <span class="o">=</span> <span class="n">indexData</span><span class="o">;</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="n">lastIndexData</span> <span class="o">=</span> <span class="n">indexData</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">lastIndexData</span><span class="o">.</span><span class="na">getClosePoint</span><span class="o">()</span> <span class="o">-</span> <span class="n">firstIndexData</span><span class="o">.</span><span class="na">getClosePoint</span><span class="o">())</span> <span class="o">/</span> <span class="n">firstIndexData</span><span class="o">.</span><span class="na">getClosePoint</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">float</span> <span class="nf">getTrendIncome</span><span class="o">(</span><span class="kt">int</span> <span class="n">year</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Profit</span><span class="o">&gt;</span> <span class="n">profits</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Profit</span> <span class="n">firstProfit</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="n">Profit</span> <span class="n">lastProfit</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

        <span class="k">for</span> <span class="o">(</span><span class="n">Profit</span> <span class="n">profit</span> <span class="o">:</span> <span class="n">profits</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">String</span> <span class="n">strDate</span> <span class="o">=</span> <span class="n">profit</span><span class="o">.</span><span class="na">getDate</span><span class="o">();</span>
            <span class="kt">int</span> <span class="n">currentYear</span> <span class="o">=</span> <span class="n">getYear</span><span class="o">(</span><span class="n">strDate</span><span class="o">);</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">currentYear</span> <span class="o">==</span> <span class="n">year</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="kc">null</span> <span class="o">==</span> <span class="n">firstProfit</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">firstProfit</span> <span class="o">=</span> <span class="n">profit</span><span class="o">;</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="n">lastProfit</span> <span class="o">=</span> <span class="n">profit</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">lastProfit</span><span class="o">.</span><span class="na">getValue</span><span class="o">()</span> <span class="o">-</span> <span class="n">firstProfit</span><span class="o">.</span><span class="na">getValue</span><span class="o">())</span> <span class="o">/</span> <span class="n">firstProfit</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">AnnualProfit</span><span class="o">&gt;</span> <span class="nf">calculateAnnualProfits</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">IndexData</span><span class="o">&gt;</span> <span class="n">indexDatas</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Profit</span><span class="o">&gt;</span> <span class="n">profits</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">AnnualProfit</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>

        <span class="n">String</span> <span class="n">strStartDate</span> <span class="o">=</span> <span class="n">indexDatas</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">0</span><span class="o">).</span><span class="na">getDate</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">strEndDate</span> <span class="o">=</span> <span class="n">indexDatas</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">indexDatas</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">-</span> <span class="n">1</span><span class="o">).</span><span class="na">getDate</span><span class="o">();</span>

        <span class="n">Date</span> <span class="n">startDate</span> <span class="o">=</span> <span class="n">DateUtil</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">strStartDate</span><span class="o">);</span>
        <span class="n">Date</span> <span class="n">endDate</span> <span class="o">=</span> <span class="n">DateUtil</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">strEndDate</span><span class="o">);</span>

        <span class="kt">int</span> <span class="n">startYear</span> <span class="o">=</span> <span class="n">DateUtil</span><span class="o">.</span><span class="na">year</span><span class="o">(</span><span class="n">startDate</span><span class="o">);</span>
        <span class="kt">int</span> <span class="n">endYear</span> <span class="o">=</span> <span class="n">DateUtil</span><span class="o">.</span><span class="na">year</span><span class="o">(</span><span class="n">endDate</span><span class="o">);</span>

        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">year</span> <span class="o">=</span> <span class="n">startYear</span><span class="o">;</span> <span class="n">year</span> <span class="o">&lt;=</span> <span class="n">endYear</span><span class="o">;</span> <span class="n">year</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">AnnualProfit</span> <span class="n">annualProfit</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AnnualProfit</span><span class="o">();</span>
            <span class="n">annualProfit</span><span class="o">.</span><span class="na">setYear</span><span class="o">(</span><span class="n">year</span><span class="o">);</span>

            <span class="kt">float</span> <span class="n">indexIncome</span> <span class="o">=</span> <span class="n">getIndexIncome</span><span class="o">(</span><span class="n">year</span><span class="o">,</span> <span class="n">indexDatas</span><span class="o">);</span>
            <span class="kt">float</span> <span class="n">trendIncome</span> <span class="o">=</span> <span class="n">getTrendIncome</span><span class="o">(</span><span class="n">year</span><span class="o">,</span> <span class="n">profits</span><span class="o">);</span>
            <span class="n">annualProfit</span><span class="o">.</span><span class="na">setIndexIncome</span><span class="o">(</span><span class="n">indexIncome</span><span class="o">);</span>
            <span class="n">annualProfit</span><span class="o">.</span><span class="na">setTrendIncome</span><span class="o">(</span><span class="n">trendIncome</span><span class="o">);</span>

            <span class="n">result</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">annualProfit</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><h3 id="util-1">util</h3>
<p>用于测试AccessService.java</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">cn.qqlin.trend.util</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">cn.hutool.core.thread.ThreadUtil</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">cn.hutool.http.HttpUtil</span><span class="o">;</span>

<span class="cm">/**
</span><span class="cm"> * @author qqlin
</span><span class="cm"> * @date 2020-6-16 12:14
</span><span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AccessService</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">ThreadUtil</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">1000</span><span class="o">);</span>
            <span class="n">access</span><span class="o">(</span><span class="n">8051</span><span class="o">);</span>
            <span class="n">access</span><span class="o">(</span><span class="n">8052</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">access</span><span class="o">(</span><span class="kt">int</span> <span class="n">port</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">String</span> <span class="n">html</span> <span class="o">=</span> <span class="n">HttpUtil</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&#34;http://127.0.0.1:%d/simulate/399975/20/1.01/0.99/0/null/null/&#34;</span><span class="o">,</span> <span class="n">port</span><span class="o">));</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">&#34;%d 地址的模拟回测服务访问成功，返回大小是 %d%n&#34;</span><span class="o">,</span> <span class="n">port</span><span class="o">,</span> <span class="n">html</span><span class="o">.</span><span class="na">length</span><span class="o">());</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">&#34;%d 地址的模拟回测服务无法访问%n&#34;</span><span class="o">,</span> <span class="n">port</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><h3 id="web-3">web</h3>
<p>BackTestController.java</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">cn.qqlin.trend.web</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">cn.qqlin.trend.pojo.AnnualProfit</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">cn.qqlin.trend.pojo.IndexData</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">cn.qqlin.trend.pojo.Profit</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">cn.qqlin.trend.pojo.Trade</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">cn.qqlin.trend.service.BackTestService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">cn.hutool.core.date.DateUtil</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">cn.hutool.core.util.StrUtil</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.CrossOrigin</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.GetMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.PathVariable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RestController</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.*</span><span class="o">;</span>

<span class="cm">/**
</span><span class="cm"> * @author qqlin
</span><span class="cm"> * @date 2020-6-14 11:04
</span><span class="cm"> */</span>
<span class="nd">@RestController</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BackTestController</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">BackTestService</span> <span class="n">backTestService</span><span class="o">;</span>

    <span class="cm">/**
</span><span class="cm">     * 这个需求是对日期功能的增加，看上去挺简单，其实还略微复杂，需求包括如下内容
</span><span class="cm">     * 1. 当获取到指数数据后，要把对应的开始日期和结束日期拿到并显示在日期控件上
</span><span class="cm">     * 2. 每次切换指数代码，都会更新开始日期和结束日期。
</span><span class="cm">     * 3. 日期能够选择的范围在 开始日期 到 结束日期之间， 超过了就不能选择了。
</span><span class="cm">     * 4. 当选择了新的日期范围的时候，会自动获取对应的数据出来。
</span><span class="cm">     * 5. 对于服务端，如果没有提供开始和结束日期，则返回所有数据。 如果提供了，则返回指定日期范围的对应数据。
</span><span class="cm">     * 6. 开始日期不能大于结束日期
</span><span class="cm">     *
</span><span class="cm">     * @param code         证券代码
</span><span class="cm">     * @param strStartDate 开始日期
</span><span class="cm">     * @param strEndDate   结束日期
</span><span class="cm">     * @return 可在服务器中传递的Map视图
</span><span class="cm">     * @throws Exception
</span><span class="cm">     */</span>
    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">&#34;/simulate/{code}/{ma}/{buyThreshold}/{sellThreshold}/{serviceCharge}//{startDate}/{endDate}&#34;</span><span class="o">)</span>
    <span class="nd">@CrossOrigin</span>
    <span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="nf">backTest</span><span class="o">(</span><span class="nd">@PathVariable</span><span class="o">(</span><span class="s">&#34;code&#34;</span><span class="o">)</span> <span class="n">String</span> <span class="n">code</span><span class="o">,</span>
                                        <span class="nd">@PathVariable</span><span class="o">(</span><span class="s">&#34;ma&#34;</span><span class="o">)</span> <span class="kt">int</span> <span class="n">movingAverageDay</span><span class="o">,</span>
                                        <span class="nd">@PathVariable</span><span class="o">(</span><span class="s">&#34;buyThreshold&#34;</span><span class="o">)</span> <span class="kt">float</span> <span class="n">buyRate</span><span class="o">,</span>
                                        <span class="nd">@PathVariable</span><span class="o">(</span><span class="s">&#34;sellThreshold&#34;</span><span class="o">)</span> <span class="kt">float</span> <span class="n">sellRate</span><span class="o">,</span>
                                        <span class="nd">@PathVariable</span><span class="o">(</span><span class="s">&#34;serviceCharge&#34;</span><span class="o">)</span> <span class="kt">float</span> <span class="n">serviceCharge</span><span class="o">,</span>
                                        <span class="nd">@PathVariable</span><span class="o">(</span><span class="s">&#34;startDate&#34;</span><span class="o">)</span> <span class="n">String</span> <span class="n">strStartDate</span><span class="o">,</span>
                                        <span class="nd">@PathVariable</span><span class="o">(</span><span class="s">&#34;endDate&#34;</span><span class="o">)</span> <span class="n">String</span> <span class="n">strEndDate</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">IndexData</span><span class="o">&gt;</span> <span class="n">allIndexDatas</span> <span class="o">=</span> <span class="n">backTestService</span><span class="o">.</span><span class="na">indexDataList</span><span class="o">(</span><span class="n">code</span><span class="o">);</span>

        <span class="c1">// 计算出开始日期和结束日期
</span><span class="c1"></span>        <span class="n">String</span> <span class="n">indexStartDate</span> <span class="o">=</span> <span class="n">allIndexDatas</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">0</span><span class="o">).</span><span class="na">getDate</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">indexEndDate</span> <span class="o">=</span> <span class="n">allIndexDatas</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">allIndexDatas</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">-</span> <span class="n">1</span><span class="o">).</span><span class="na">getDate</span><span class="o">();</span>

        <span class="c1">// 根据开始日期和结束日期获取对应日期范围的数据
</span><span class="c1"></span>        <span class="n">allIndexDatas</span> <span class="o">=</span> <span class="n">filterByDateRange</span><span class="o">(</span><span class="n">allIndexDatas</span><span class="o">,</span> <span class="n">strStartDate</span><span class="o">,</span> <span class="n">strEndDate</span><span class="o">);</span>

        <span class="c1">//计算均线所需的天数
</span><span class="c1">//        int movingAverageDay = 20;
</span><span class="c1"></span>
        <span class="c1">// 卖出阈值
</span><span class="c1">//        float sellRate = 0.95f;
</span><span class="c1"></span>        <span class="c1">// 买入阈值
</span><span class="c1">//        float buyRate = 1.05f;
</span><span class="c1"></span>
        <span class="c1">// 交易手续费
</span><span class="c1">//        float serviceCharge = 0f;
</span><span class="c1"></span>
        <span class="c1">// 模拟数据中的相关计算
</span><span class="c1"></span>        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="o">?&gt;</span> <span class="n">simulateResult</span> <span class="o">=</span> <span class="n">backTestService</span><span class="o">.</span><span class="na">simulate</span><span class="o">(</span><span class="n">movingAverageDay</span><span class="o">,</span> <span class="n">sellRate</span><span class="o">,</span> <span class="n">buyRate</span><span class="o">,</span> <span class="n">serviceCharge</span><span class="o">,</span> <span class="n">allIndexDatas</span><span class="o">);</span>

        <span class="n">List</span><span class="o">&lt;</span><span class="n">Profit</span><span class="o">&gt;</span> <span class="n">profits</span> <span class="o">=</span> <span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Profit</span><span class="o">&gt;)</span> <span class="n">simulateResult</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;profits&#34;</span><span class="o">);</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Trade</span><span class="o">&gt;</span> <span class="n">trades</span> <span class="o">=</span> <span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Trade</span><span class="o">&gt;)</span> <span class="n">simulateResult</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;trades&#34;</span><span class="o">);</span>

        <span class="c1">// 获取区间范围内的合计年份
</span><span class="c1"></span>        <span class="kt">float</span> <span class="n">years</span> <span class="o">=</span> <span class="n">backTestService</span><span class="o">.</span><span class="na">getYears</span><span class="o">(</span><span class="n">allIndexDatas</span><span class="o">);</span>

        <span class="c1">// 计算指数投资的收益和年化收益率
</span><span class="c1"></span>        <span class="kd">final</span> <span class="kt">float</span> <span class="n">closePoint</span> <span class="o">=</span> <span class="n">allIndexDatas</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">allIndexDatas</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">-</span> <span class="n">1</span><span class="o">).</span><span class="na">getClosePoint</span><span class="o">()</span> <span class="o">-</span> <span class="n">allIndexDatas</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">0</span><span class="o">).</span><span class="na">getClosePoint</span><span class="o">();</span>
        <span class="kt">float</span> <span class="n">indexIncomeTotal</span> <span class="o">=</span> <span class="n">closePoint</span> <span class="o">/</span> <span class="n">allIndexDatas</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">0</span><span class="o">).</span><span class="na">getClosePoint</span><span class="o">();</span>
        <span class="kt">float</span> <span class="n">indexIncomeAnnual</span> <span class="o">=</span> <span class="o">(</span><span class="kt">float</span><span class="o">)</span> <span class="n">Math</span><span class="o">.</span><span class="na">pow</span><span class="o">(</span><span class="n">1</span> <span class="o">+</span> <span class="n">indexIncomeTotal</span><span class="o">,</span> <span class="n">1</span> <span class="o">/</span> <span class="n">years</span><span class="o">)</span> <span class="o">-</span> <span class="n">1</span><span class="o">;</span>

        <span class="c1">// 计算趋势投资的收益和年化收益率
</span><span class="c1"></span>        <span class="kd">final</span> <span class="kt">float</span> <span class="n">value</span> <span class="o">=</span> <span class="n">profits</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">profits</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">-</span> <span class="n">1</span><span class="o">).</span><span class="na">getValue</span><span class="o">()</span> <span class="o">-</span> <span class="n">profits</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">0</span><span class="o">).</span><span class="na">getValue</span><span class="o">();</span>
        <span class="kt">float</span> <span class="n">trendIncomeTotal</span> <span class="o">=</span> <span class="n">value</span> <span class="o">/</span> <span class="n">profits</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">0</span><span class="o">).</span><span class="na">getValue</span><span class="o">();</span>
        <span class="kt">float</span> <span class="n">trendIncomeAnnual</span> <span class="o">=</span> <span class="o">(</span><span class="kt">float</span><span class="o">)</span> <span class="n">Math</span><span class="o">.</span><span class="na">pow</span><span class="o">(</span><span class="n">1</span> <span class="o">+</span> <span class="n">trendIncomeTotal</span><span class="o">,</span> <span class="n">1</span> <span class="o">/</span> <span class="n">years</span><span class="o">)</span> <span class="o">-</span> <span class="n">1</span><span class="o">;</span>

        <span class="c1">// 计算盈利交易次数和盈利交易比例
</span><span class="c1"></span>        <span class="kt">int</span> <span class="n">winCount</span> <span class="o">=</span> <span class="o">(</span><span class="n">Integer</span><span class="o">)</span> <span class="n">simulateResult</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;winCount&#34;</span><span class="o">);</span>
        <span class="kt">float</span> <span class="n">avgWinRate</span> <span class="o">=</span> <span class="o">(</span><span class="n">Float</span><span class="o">)</span> <span class="n">simulateResult</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;avgWinRate&#34;</span><span class="o">);</span>

        <span class="c1">// 计算亏损交易次数和盈利交易比例
</span><span class="c1"></span>        <span class="kt">int</span> <span class="n">lossCount</span> <span class="o">=</span> <span class="o">(</span><span class="n">Integer</span><span class="o">)</span> <span class="n">simulateResult</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;lossCount&#34;</span><span class="o">);</span>
        <span class="kt">float</span> <span class="n">avgLossRate</span> <span class="o">=</span> <span class="o">(</span><span class="n">Float</span><span class="o">)</span> <span class="n">simulateResult</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;avgLossRate&#34;</span><span class="o">);</span>

        <span class="c1">// 计算完整时间范围内，每一年的指数投资的收益和趋势投资的收益
</span><span class="c1"></span>        <span class="n">List</span><span class="o">&lt;</span><span class="n">AnnualProfit</span><span class="o">&gt;</span> <span class="n">annualProfits</span> <span class="o">=</span> <span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">AnnualProfit</span><span class="o">&gt;)</span> <span class="n">simulateResult</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;annualProfits&#34;</span><span class="o">);</span>

        <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
        <span class="n">result</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;indexDatas&#34;</span><span class="o">,</span> <span class="n">allIndexDatas</span><span class="o">);</span>
        <span class="n">result</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;indexStartDate&#34;</span><span class="o">,</span> <span class="n">indexStartDate</span><span class="o">);</span>
        <span class="n">result</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;indexEndDate&#34;</span><span class="o">,</span> <span class="n">indexEndDate</span><span class="o">);</span>

        <span class="n">result</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;profits&#34;</span><span class="o">,</span> <span class="n">profits</span><span class="o">);</span>
        <span class="n">result</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;trades&#34;</span><span class="o">,</span> <span class="n">trades</span><span class="o">);</span>

        <span class="n">result</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;years&#34;</span><span class="o">,</span> <span class="n">years</span><span class="o">);</span>
        <span class="n">result</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;indexIncomeTotal&#34;</span><span class="o">,</span> <span class="n">indexIncomeTotal</span><span class="o">);</span>
        <span class="n">result</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;indexIncomeAnnual&#34;</span><span class="o">,</span> <span class="n">indexIncomeAnnual</span><span class="o">);</span>
        <span class="n">result</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;trendIncomeTotal&#34;</span><span class="o">,</span> <span class="n">trendIncomeTotal</span><span class="o">);</span>
        <span class="n">result</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;trendIncomeAnnual&#34;</span><span class="o">,</span> <span class="n">trendIncomeAnnual</span><span class="o">);</span>

        <span class="n">result</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;winCount&#34;</span><span class="o">,</span> <span class="n">winCount</span><span class="o">);</span>
        <span class="n">result</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;lossCount&#34;</span><span class="o">,</span> <span class="n">lossCount</span><span class="o">);</span>
        <span class="n">result</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;avgWinRate&#34;</span><span class="o">,</span> <span class="n">avgWinRate</span><span class="o">);</span>
        <span class="n">result</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;avgLossRate&#34;</span><span class="o">,</span> <span class="n">avgLossRate</span><span class="o">);</span>

        <span class="n">result</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;annualProfits&#34;</span><span class="o">,</span> <span class="n">annualProfits</span><span class="o">);</span>

        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * 根据开始日期和结束日期获取对应日期范围的数据
</span><span class="cm">     *
</span><span class="cm">     * @param allIndexDatas 对应的全部指数数据
</span><span class="cm">     * @param strStartDate  开始日期
</span><span class="cm">     * @param strEndDate    结束日期
</span><span class="cm">     * @return 日期区间的所有数据
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">IndexData</span><span class="o">&gt;</span> <span class="nf">filterByDateRange</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">IndexData</span><span class="o">&gt;</span> <span class="n">allIndexDatas</span><span class="o">,</span> <span class="n">String</span> <span class="n">strStartDate</span><span class="o">,</span> <span class="n">String</span> <span class="n">strEndDate</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">StrUtil</span><span class="o">.</span><span class="na">isBlankOrUndefined</span><span class="o">(</span><span class="n">strStartDate</span><span class="o">)</span> <span class="o">||</span> <span class="n">StrUtil</span><span class="o">.</span><span class="na">isBlankOrUndefined</span><span class="o">(</span><span class="n">strEndDate</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">allIndexDatas</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="n">List</span><span class="o">&lt;</span><span class="n">IndexData</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="n">Date</span> <span class="n">startDate</span> <span class="o">=</span> <span class="n">DateUtil</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">strStartDate</span><span class="o">);</span>
        <span class="n">Date</span> <span class="n">endDate</span> <span class="o">=</span> <span class="n">DateUtil</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">strEndDate</span><span class="o">);</span>

        <span class="k">for</span> <span class="o">(</span><span class="n">IndexData</span> <span class="n">indexData</span> <span class="o">:</span> <span class="n">allIndexDatas</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Date</span> <span class="n">date</span> <span class="o">=</span> <span class="n">DateUtil</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">indexData</span><span class="o">.</span><span class="na">getDate</span><span class="o">());</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">date</span><span class="o">.</span><span class="na">getTime</span><span class="o">()</span> <span class="o">&gt;=</span> <span class="n">startDate</span><span class="o">.</span><span class="na">getTime</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">date</span><span class="o">.</span><span class="na">getTime</span><span class="o">()</span> <span class="o">&lt;=</span> <span class="n">endDate</span><span class="o">.</span><span class="na">getTime</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">result</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">indexData</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><h2 id="29-模拟回测视图微服务">2.9 模拟回测视图微服务</h2>
<h3 id="module-7">module</h3>
<p>新建一个module，命名为trend-trading-backtest-view，修改pom.xml为</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-xml" data-lang="xml"><span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>

<span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0&#34;</span> <span class="na">xmlns:xsi=</span><span class="s">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
         <span class="na">xsi:schemaLocation=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&#34;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;parent&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>trendParentProject<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>cn.qqlin.trend<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/parent&gt;</span>
    <span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>

    <span class="nt">&lt;artifactId&gt;</span>trend-trading-backtest-view<span class="nt">&lt;/artifactId&gt;</span>

    <span class="nt">&lt;dependencies&gt;</span>
        <span class="c">&lt;!-- springboot web --&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-web<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!--thymeleaf--&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-thymeleaf<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!-- eureka-client --&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!--zipkin--&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-zipkin<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!--config-client--&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-config<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!-- RabbitMQ --&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-actuator<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-bus-amqp<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>

    <span class="nt">&lt;/dependencies&gt;</span>
<span class="nt">&lt;/project&gt;</span>

</code></pre></td></tr></table>
</div>
</div><h3 id="trendtradingbacktestviewapplication">TrendTradingBackTestViewApplication</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">cn.qqlin.trend</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">brave.sampler.Sampler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">cn.hutool.core.convert.Convert</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">cn.hutool.core.thread.ThreadUtil</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">cn.hutool.core.util.NetUtil</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">cn.hutool.core.util.NumberUtil</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">cn.hutool.core.util.StrUtil</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.autoconfigure.SpringBootApplication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.builder.SpringApplicationBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cloud.netflix.eureka.EnableEurekaClient</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Scanner</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.ExecutionException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.Future</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.TimeUnit</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.TimeoutException</span><span class="o">;</span>

<span class="cm">/**
</span><span class="cm"> * @author qqlin
</span><span class="cm"> * @date 2020-6-15 0:15
</span><span class="cm"> */</span>
<span class="nd">@SpringBootApplication</span>
<span class="nd">@EnableEurekaClient</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TrendTradingBackTestViewApplication</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">defaultPort</span> <span class="o">=</span> <span class="n">8041</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">eurekaServerPort</span> <span class="o">=</span> <span class="n">8761</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">configServerPort</span> <span class="o">=</span> <span class="n">8060</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">rabbitMqPort</span> <span class="o">=</span> <span class="n">5672</span><span class="o">;</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">NetUtil</span><span class="o">.</span><span class="na">isUsableLocalPort</span><span class="o">(</span><span class="n">eurekaServerPort</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">&#34;检查到端口%d 未启用，判断 eureka 服务器没有启动，本服务无法使用，故退出%n&#34;</span><span class="o">,</span> <span class="n">eurekaServerPort</span><span class="o">);</span>
            <span class="n">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">NetUtil</span><span class="o">.</span><span class="na">isUsableLocalPort</span><span class="o">(</span><span class="n">configServerPort</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">&#34;检查到端口%d 未启用，判断 配置服务器没有启动， 本服务无法使用，故退出%n&#34;</span><span class="o">,</span> <span class="n">configServerPort</span><span class="o">);</span>
            <span class="n">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">NetUtil</span><span class="o">.</span><span class="na">isUsableLocalPort</span><span class="o">(</span><span class="n">rabbitMqPort</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">&#34;检查到端口%d 未启用，判断 rabbitMQ 服务器没有启动， 本服务无法使用，故退出%n&#34;</span><span class="o">,</span> <span class="n">rabbitMqPort</span><span class="o">);</span>
            <span class="n">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="kc">null</span> <span class="o">!=</span> <span class="n">args</span> <span class="o">&amp;&amp;</span> <span class="n">0</span> <span class="o">!=</span> <span class="n">args</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">arg</span> <span class="o">:</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">arg</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">&#34;port=&#34;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">String</span> <span class="n">strPort</span> <span class="o">=</span> <span class="n">StrUtil</span><span class="o">.</span><span class="na">subAfter</span><span class="o">(</span><span class="n">arg</span><span class="o">,</span> <span class="s">&#34;port=&#34;</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">NumberUtil</span><span class="o">.</span><span class="na">isNumber</span><span class="o">(</span><span class="n">strPort</span><span class="o">))</span> <span class="o">{</span>
                        <span class="n">port</span> <span class="o">=</span> <span class="n">Convert</span><span class="o">.</span><span class="na">toInt</span><span class="o">(</span><span class="n">strPort</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">0</span> <span class="o">==</span> <span class="n">port</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Future</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">future</span> <span class="o">=</span> <span class="n">ThreadUtil</span><span class="o">.</span><span class="na">execAsync</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
                <span class="kt">int</span> <span class="n">p</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;请于5秒钟内输入端口号, 推荐  8041 、 8042  或者  8043，超过5秒将默认使用 &#34;</span> <span class="o">+</span> <span class="n">defaultPort</span><span class="o">);</span>
                <span class="n">Scanner</span> <span class="n">scanner</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Scanner</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">in</span><span class="o">);</span>
                <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">String</span> <span class="n">strPort</span> <span class="o">=</span> <span class="n">scanner</span><span class="o">.</span><span class="na">nextLine</span><span class="o">();</span>
                    <span class="k">if</span> <span class="o">(!</span><span class="n">NumberUtil</span><span class="o">.</span><span class="na">isInteger</span><span class="o">(</span><span class="n">strPort</span><span class="o">))</span> <span class="o">{</span>
                        <span class="n">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;只能是数字&#34;</span><span class="o">);</span>
                        <span class="k">continue</span><span class="o">;</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                        <span class="n">p</span> <span class="o">=</span> <span class="n">Convert</span><span class="o">.</span><span class="na">toInt</span><span class="o">(</span><span class="n">strPort</span><span class="o">);</span>
                        <span class="n">scanner</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
                <span class="k">return</span> <span class="n">p</span><span class="o">;</span>
            <span class="o">});</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">port</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">5</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="o">|</span> <span class="n">ExecutionException</span> <span class="o">|</span> <span class="n">TimeoutException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">port</span> <span class="o">=</span> <span class="n">defaultPort</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">NetUtil</span><span class="o">.</span><span class="na">isUsableLocalPort</span><span class="o">(</span><span class="n">port</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">&#34;端口%d被占用了，无法启动%n&#34;</span><span class="o">,</span> <span class="n">port</span><span class="o">);</span>
                <span class="n">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>


        <span class="k">new</span> <span class="n">SpringApplicationBuilder</span><span class="o">(</span><span class="n">TrendTradingBackTestViewApplication</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                <span class="o">.</span><span class="na">properties</span><span class="o">(</span><span class="s">&#34;server.port=&#34;</span> <span class="o">+</span> <span class="n">port</span><span class="o">)</span>
                <span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="n">Sampler</span> <span class="nf">defaultSampler</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">Sampler</span><span class="o">.</span><span class="na">ALWAYS_SAMPLE</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><h3 id="bootstrapyml">bootstrap.yml</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yml" data-lang="yml"><span class="k">spring</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">cloud</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">config</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="k">label</span><span class="p">:</span><span class="w"> </span>master<span class="w">
</span><span class="w">      </span><span class="k">profile</span><span class="p">:</span><span class="w"> </span>dev<span class="w">
</span><span class="w">      </span><span class="k">discovery</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="k">enabled</span><span class="p">:</span><span class="w">  </span><span class="kc">true</span><span class="w">
</span><span class="w">        </span><span class="k">serviceId</span><span class="p">:</span><span class="w">  </span>index-config-server<span class="w">
</span><span class="w">    </span><span class="k">bus</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="k">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">      </span><span class="k">trace</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="k">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">        
</span><span class="w"></span><span class="k">rabbitmq</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">host</span><span class="p">:</span><span class="w"> </span>localhost<span class="w">
</span><span class="w">  </span><span class="k">port</span><span class="p">:</span><span class="w"> </span><span class="m">5672</span><span class="w">
</span><span class="w">  </span><span class="k">username</span><span class="p">:</span><span class="w"> </span>guest<span class="w">
</span><span class="w">  </span><span class="k">password</span><span class="p">:</span><span class="w"> </span>guest<span class="w">
</span><span class="w">  
</span><span class="w"></span><span class="k">eureka</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">client</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">serviceUrl</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="k">defaultZone</span><span class="p">:</span><span class="w"> </span>http<span class="p">:</span>//localhost<span class="p">:</span><span class="m">8761</span>/eureka/<span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h3 id="applicationyml-7">application.yml</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yml" data-lang="yml"><span class="k">spring</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">application</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">name</span><span class="p">:</span><span class="w"> </span>trend-trading-backtest-view<span class="w">
</span><span class="w">    
</span><span class="w">  </span><span class="k">thymeleaf</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">mode</span><span class="p">:</span><span class="w"> </span>LEGACYHTML5<span class="w">
</span><span class="w">    </span><span class="k">encoding</span><span class="p">:</span><span class="w"> </span>UTF<span class="m">-8</span><span class="w">
</span><span class="w">    </span><span class="k">cache</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span><span class="w">    </span><span class="k">servlet</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="k">content-type</span><span class="p">:</span><span class="w"> </span>text/html<span class="w">
</span><span class="w">      
</span><span class="w">  </span><span class="k">zipkin</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">base-url</span><span class="p">:</span><span class="w"> </span>http<span class="p">:</span>//localhost<span class="p">:</span><span class="m">9411</span><span class="w">
</span><span class="w">    
</span><span class="w"></span><span class="k">management</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">endpoints</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">web</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="k">exposure</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="k">include</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;*&#34;</span><span class="w">
</span><span class="w">      </span><span class="k">cors</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="k">allowed-origins</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;*&#34;</span><span class="w">
</span><span class="w">        </span><span class="k">allowed-methods</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;*&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h3 id="static">static</h3>
<p>静态资源，存放相关js和css文件</p>
<h3 id="templates">templates</h3>
<p>静态模板，存放html文件</p>
<p>view.html</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span><span class="lnt">351
</span><span class="lnt">352
</span><span class="lnt">353
</span><span class="lnt">354
</span><span class="lnt">355
</span><span class="lnt">356
</span><span class="lnt">357
</span><span class="lnt">358
</span><span class="lnt">359
</span><span class="lnt">360
</span><span class="lnt">361
</span><span class="lnt">362
</span><span class="lnt">363
</span><span class="lnt">364
</span><span class="lnt">365
</span><span class="lnt">366
</span><span class="lnt">367
</span><span class="lnt">368
</span><span class="lnt">369
</span><span class="lnt">370
</span><span class="lnt">371
</span><span class="lnt">372
</span><span class="lnt">373
</span><span class="lnt">374
</span><span class="lnt">375
</span><span class="lnt">376
</span><span class="lnt">377
</span><span class="lnt">378
</span><span class="lnt">379
</span><span class="lnt">380
</span><span class="lnt">381
</span><span class="lnt">382
</span><span class="lnt">383
</span><span class="lnt">384
</span><span class="lnt">385
</span><span class="lnt">386
</span><span class="lnt">387
</span><span class="lnt">388
</span><span class="lnt">389
</span><span class="lnt">390
</span><span class="lnt">391
</span><span class="lnt">392
</span><span class="lnt">393
</span><span class="lnt">394
</span><span class="lnt">395
</span><span class="lnt">396
</span><span class="lnt">397
</span><span class="lnt">398
</span><span class="lnt">399
</span><span class="lnt">400
</span><span class="lnt">401
</span><span class="lnt">402
</span><span class="lnt">403
</span><span class="lnt">404
</span><span class="lnt">405
</span><span class="lnt">406
</span><span class="lnt">407
</span><span class="lnt">408
</span><span class="lnt">409
</span><span class="lnt">410
</span><span class="lnt">411
</span><span class="lnt">412
</span><span class="lnt">413
</span><span class="lnt">414
</span><span class="lnt">415
</span><span class="lnt">416
</span><span class="lnt">417
</span><span class="lnt">418
</span><span class="lnt">419
</span><span class="lnt">420
</span><span class="lnt">421
</span><span class="lnt">422
</span><span class="lnt">423
</span><span class="lnt">424
</span><span class="lnt">425
</span><span class="lnt">426
</span><span class="lnt">427
</span><span class="lnt">428
</span><span class="lnt">429
</span><span class="lnt">430
</span><span class="lnt">431
</span><span class="lnt">432
</span><span class="lnt">433
</span><span class="lnt">434
</span><span class="lnt">435
</span><span class="lnt">436
</span><span class="lnt">437
</span><span class="lnt">438
</span><span class="lnt">439
</span><span class="lnt">440
</span><span class="lnt">441
</span><span class="lnt">442
</span><span class="lnt">443
</span><span class="lnt">444
</span><span class="lnt">445
</span><span class="lnt">446
</span><span class="lnt">447
</span><span class="lnt">448
</span><span class="lnt">449
</span><span class="lnt">450
</span><span class="lnt">451
</span><span class="lnt">452
</span><span class="lnt">453
</span><span class="lnt">454
</span><span class="lnt">455
</span><span class="lnt">456
</span><span class="lnt">457
</span><span class="lnt">458
</span><span class="lnt">459
</span><span class="lnt">460
</span><span class="lnt">461
</span><span class="lnt">462
</span><span class="lnt">463
</span><span class="lnt">464
</span><span class="lnt">465
</span><span class="lnt">466
</span><span class="lnt">467
</span><span class="lnt">468
</span><span class="lnt">469
</span><span class="lnt">470
</span><span class="lnt">471
</span><span class="lnt">472
</span><span class="lnt">473
</span><span class="lnt">474
</span><span class="lnt">475
</span><span class="lnt">476
</span><span class="lnt">477
</span><span class="lnt">478
</span><span class="lnt">479
</span><span class="lnt">480
</span><span class="lnt">481
</span><span class="lnt">482
</span><span class="lnt">483
</span><span class="lnt">484
</span><span class="lnt">485
</span><span class="lnt">486
</span><span class="lnt">487
</span><span class="lnt">488
</span><span class="lnt">489
</span><span class="lnt">490
</span><span class="lnt">491
</span><span class="lnt">492
</span><span class="lnt">493
</span><span class="lnt">494
</span><span class="lnt">495
</span><span class="lnt">496
</span><span class="lnt">497
</span><span class="lnt">498
</span><span class="lnt">499
</span><span class="lnt">500
</span><span class="lnt">501
</span><span class="lnt">502
</span><span class="lnt">503
</span><span class="lnt">504
</span><span class="lnt">505
</span><span class="lnt">506
</span><span class="lnt">507
</span><span class="lnt">508
</span><span class="lnt">509
</span><span class="lnt">510
</span><span class="lnt">511
</span><span class="lnt">512
</span><span class="lnt">513
</span><span class="lnt">514
</span><span class="lnt">515
</span><span class="lnt">516
</span><span class="lnt">517
</span><span class="lnt">518
</span><span class="lnt">519
</span><span class="lnt">520
</span><span class="lnt">521
</span><span class="lnt">522
</span><span class="lnt">523
</span><span class="lnt">524
</span><span class="lnt">525
</span><span class="lnt">526
</span><span class="lnt">527
</span><span class="lnt">528
</span><span class="lnt">529
</span><span class="lnt">530
</span><span class="lnt">531
</span><span class="lnt">532
</span><span class="lnt">533
</span><span class="lnt">534
</span><span class="lnt">535
</span><span class="lnt">536
</span><span class="lnt">537
</span><span class="lnt">538
</span><span class="lnt">539
</span><span class="lnt">540
</span><span class="lnt">541
</span><span class="lnt">542
</span><span class="lnt">543
</span><span class="lnt">544
</span><span class="lnt">545
</span><span class="lnt">546
</span><span class="lnt">547
</span><span class="lnt">548
</span><span class="lnt">549
</span><span class="lnt">550
</span><span class="lnt">551
</span><span class="lnt">552
</span><span class="lnt">553
</span><span class="lnt">554
</span><span class="lnt">555
</span><span class="lnt">556
</span><span class="lnt">557
</span><span class="lnt">558
</span><span class="lnt">559
</span><span class="lnt">560
</span><span class="lnt">561
</span><span class="lnt">562
</span><span class="lnt">563
</span><span class="lnt">564
</span><span class="lnt">565
</span><span class="lnt">566
</span><span class="lnt">567
</span><span class="lnt">568
</span><span class="lnt">569
</span><span class="lnt">570
</span><span class="lnt">571
</span><span class="lnt">572
</span><span class="lnt">573
</span><span class="lnt">574
</span><span class="lnt">575
</span><span class="lnt">576
</span><span class="lnt">577
</span><span class="lnt">578
</span><span class="lnt">579
</span><span class="lnt">580
</span><span class="lnt">581
</span><span class="lnt">582
</span><span class="lnt">583
</span><span class="lnt">584
</span><span class="lnt">585
</span><span class="lnt">586
</span><span class="lnt">587
</span><span class="lnt">588
</span><span class="lnt">589
</span><span class="lnt">590
</span><span class="lnt">591
</span><span class="lnt">592
</span><span class="lnt">593
</span><span class="lnt">594
</span><span class="lnt">595
</span><span class="lnt">596
</span><span class="lnt">597
</span><span class="lnt">598
</span><span class="lnt">599
</span><span class="lnt">600
</span><span class="lnt">601
</span><span class="lnt">602
</span><span class="lnt">603
</span><span class="lnt">604
</span><span class="lnt">605
</span><span class="lnt">606
</span><span class="lnt">607
</span><span class="lnt">608
</span><span class="lnt">609
</span><span class="lnt">610
</span><span class="lnt">611
</span><span class="lnt">612
</span><span class="lnt">613
</span><span class="lnt">614
</span><span class="lnt">615
</span><span class="lnt">616
</span><span class="lnt">617
</span><span class="lnt">618
</span><span class="lnt">619
</span><span class="lnt">620
</span><span class="lnt">621
</span><span class="lnt">622
</span><span class="lnt">623
</span><span class="lnt">624
</span><span class="lnt">625
</span><span class="lnt">626
</span><span class="lnt">627
</span><span class="lnt">628
</span><span class="lnt">629
</span><span class="lnt">630
</span><span class="lnt">631
</span><span class="lnt">632
</span><span class="lnt">633
</span><span class="lnt">634
</span><span class="lnt">635
</span><span class="lnt">636
</span><span class="lnt">637
</span><span class="lnt">638
</span><span class="lnt">639
</span><span class="lnt">640
</span><span class="lnt">641
</span><span class="lnt">642
</span><span class="lnt">643
</span><span class="lnt">644
</span><span class="lnt">645
</span><span class="lnt">646
</span><span class="lnt">647
</span><span class="lnt">648
</span><span class="lnt">649
</span><span class="lnt">650
</span><span class="lnt">651
</span><span class="lnt">652
</span><span class="lnt">653
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-html" data-lang="html"><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span> <span class="na">xmlns:th</span><span class="o">=</span><span class="s">&#34;http://www.thymeleaf.org&#34;</span> <span class="na">xmlns:v-bind</span><span class="o">=</span><span class="s">&#34;http://www.w3.org/1999/xhtml&#34;</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">head</span> <span class="na">th:include</span><span class="o">=</span><span class="s">&#34;include/header::html(&#39;趋势投资模拟回测&#39;)&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="kd">var</span> <span class="nx">chart4Profit</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">chart4AnnualIncome</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

    <span class="nx">$</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">data4Vue</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">indexes</span><span class="o">:</span> <span class="p">[],</span>
            <span class="nx">currentIndex</span><span class="o">:</span> <span class="s1">&#39;000300&#39;</span><span class="p">,</span>

            <span class="nx">indexDatas</span><span class="o">:</span> <span class="p">[],</span>
            <span class="nx">dates</span><span class="o">:</span> <span class="p">[],</span>
            <span class="nx">closePoints</span><span class="o">:</span> <span class="p">[],</span>

            <span class="nx">flushDate</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>

            <span class="nx">indexStartDate</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
            <span class="nx">indexEndDate</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
            <span class="nx">startDate</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
            <span class="nx">endDate</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>

            <span class="nx">profits</span><span class="o">:</span> <span class="p">[],</span>
            <span class="nx">profitValues</span><span class="o">:</span> <span class="p">[],</span>

            <span class="nx">trades</span><span class="o">:</span> <span class="p">[],</span>

            <span class="nx">years</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="nx">indexIncomeTotal</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="nx">indexIncomeAnnual</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="nx">trendIncomeTotal</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="nx">trendIncomeAnnual</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>

            <span class="nx">winCount</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="nx">lossCount</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="nx">avgWinRate</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="nx">avgLossRate</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>

            <span class="nx">annualProfits</span><span class="o">:</span> <span class="p">[],</span>
            <span class="nx">annuals</span><span class="o">:</span> <span class="p">[],</span>
            <span class="nx">indexIncomes</span><span class="o">:</span> <span class="p">[],</span>
            <span class="nx">trendIncomes</span><span class="o">:</span> <span class="p">[],</span>

            <span class="nx">ma</span><span class="o">:</span> <span class="mi">20</span><span class="p">,</span>

            <span class="nx">buyThreshold</span><span class="o">:</span> <span class="mf">1.01</span><span class="p">,</span>
            <span class="nx">sellThreshold</span><span class="o">:</span> <span class="mf">0.99</span><span class="p">,</span>

            <span class="nx">serviceCharge</span><span class="o">:</span> <span class="mf">0.0</span><span class="p">,</span>

        <span class="p">};</span>

        <span class="c1">//ViewModel
</span><span class="c1"></span>        <span class="kd">var</span> <span class="nx">vue</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Vue</span><span class="p">({</span>
            <span class="nx">el</span><span class="o">:</span> <span class="s1">&#39;#workingArea&#39;</span><span class="p">,</span>
            <span class="nx">data</span><span class="o">:</span> <span class="nx">data4Vue</span><span class="p">,</span>
            <span class="nx">mounted</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="c1">//mounted　表示这个 Vue 对象加载成功了
</span><span class="c1"></span>                <span class="k">this</span><span class="p">.</span><span class="nx">init</span><span class="p">();</span>
                <span class="nx">$</span><span class="p">(</span><span class="s2">&#34;[data-toggle=&#39;tooltip&#39;]&#34;</span><span class="p">).</span><span class="nx">tooltip</span><span class="p">();</span>
            <span class="p">},</span>
            <span class="nx">methods</span><span class="o">:</span> <span class="p">{</span>
                <span class="nx">init</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                    <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="s2">&#34;http://127.0.0.1:8031/api-codes/codes&#34;</span><span class="p">;</span>
                    <span class="nx">axios</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">url</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">vue</span><span class="p">.</span><span class="nx">indexes</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
                        <span class="nx">vue</span><span class="p">.</span><span class="nx">$nextTick</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                            <span class="nx">vue</span><span class="p">.</span><span class="nx">simulate</span><span class="p">();</span>
                        <span class="p">});</span>
                    <span class="p">});</span>
                <span class="p">},</span>
                <span class="nx">simulate</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                    <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="s2">&#34;http://127.0.0.1:8031/api-backtest/simulate/&#34;</span> <span class="o">+</span> <span class="nx">vue</span><span class="p">.</span><span class="nx">currentIndex</span> <span class="o">+</span> <span class="s2">&#34;/&#34;</span> <span class="o">+</span> <span class="nx">vue</span><span class="p">.</span><span class="nx">ma</span> <span class="o">+</span> <span class="s2">&#34;/&#34;</span> <span class="o">+</span> <span class="nx">vue</span><span class="p">.</span><span class="nx">buyThreshold</span> <span class="o">+</span> <span class="s2">&#34;/&#34;</span> <span class="o">+</span> <span class="nx">vue</span><span class="p">.</span><span class="nx">sellThreshold</span> <span class="o">+</span> <span class="s2">&#34;/&#34;</span> <span class="o">+</span> <span class="nx">vue</span><span class="p">.</span><span class="nx">serviceCharge</span> <span class="o">+</span> <span class="s2">&#34;/&#34;</span> <span class="o">+</span> <span class="nx">vue</span><span class="p">.</span><span class="nx">startDate</span> <span class="o">+</span> <span class="s2">&#34;/&#34;</span> <span class="o">+</span> <span class="nx">vue</span><span class="p">.</span><span class="nx">endDate</span> <span class="o">+</span> <span class="s2">&#34;/&#34;</span><span class="p">;</span>
                    <span class="nx">axios</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">url</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
                        <span class="c1">//清空原数据
</span><span class="c1"></span>                        <span class="nx">vue</span><span class="p">.</span><span class="nx">indexDatas</span> <span class="o">=</span> <span class="p">[];</span>
                        <span class="nx">vue</span><span class="p">.</span><span class="nx">closePoints</span> <span class="o">=</span> <span class="p">[];</span>
                        <span class="nx">vue</span><span class="p">.</span><span class="nx">dates</span> <span class="o">=</span> <span class="p">[];</span>
                        <span class="nx">vue</span><span class="p">.</span><span class="nx">profits</span> <span class="o">=</span> <span class="p">[];</span>
                        <span class="nx">vue</span><span class="p">.</span><span class="nx">profitValues</span> <span class="o">=</span> <span class="p">[];</span>
                        <span class="nx">vue</span><span class="p">.</span><span class="nx">trades</span> <span class="o">=</span> <span class="p">[];</span>
                        <span class="nx">vue</span><span class="p">.</span><span class="nx">annualProfits</span> <span class="o">=</span> <span class="p">[];</span>
                        <span class="nx">vue</span><span class="p">.</span><span class="nx">annuals</span> <span class="o">=</span> <span class="p">[];</span>
                        <span class="nx">vue</span><span class="p">.</span><span class="nx">indexIncomes</span> <span class="o">=</span> <span class="p">[];</span>
                        <span class="nx">vue</span><span class="p">.</span><span class="nx">trendIncomes</span> <span class="o">=</span> <span class="p">[];</span>

                        <span class="c1">//获取返回数据
</span><span class="c1"></span>
                        <span class="nx">vue</span><span class="p">.</span><span class="nx">indexDatas</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">indexDatas</span><span class="p">;</span>
                        <span class="nx">vue</span><span class="p">.</span><span class="nx">dates</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">();</span>
                        <span class="nx">vue</span><span class="p">.</span><span class="nx">closePoints</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">();</span>

                        <span class="c1">//日期
</span><span class="c1"></span>                        <span class="nx">vue</span><span class="p">.</span><span class="nx">indexStartDate</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">indexStartDate</span><span class="p">;</span>
                        <span class="nx">vue</span><span class="p">.</span><span class="nx">indexEndDate</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">indexEndDate</span><span class="p">;</span>

                        <span class="c1">//收益
</span><span class="c1"></span>                        <span class="nx">vue</span><span class="p">.</span><span class="nx">profits</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">profits</span><span class="p">;</span>

                        <span class="c1">//交易明细
</span><span class="c1"></span>                        <span class="nx">vue</span><span class="p">.</span><span class="nx">trades</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">trades</span><span class="p">;</span>

                        <span class="c1">//收益一览
</span><span class="c1"></span>                        <span class="nx">vue</span><span class="p">.</span><span class="nx">years</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">years</span><span class="p">;</span>
                        <span class="nx">vue</span><span class="p">.</span><span class="nx">indexIncomeTotal</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">indexIncomeTotal</span><span class="p">;</span>
                        <span class="nx">vue</span><span class="p">.</span><span class="nx">indexIncomeAnnual</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">indexIncomeAnnual</span><span class="p">;</span>
                        <span class="nx">vue</span><span class="p">.</span><span class="nx">trendIncomeTotal</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">trendIncomeTotal</span><span class="p">;</span>
                        <span class="nx">vue</span><span class="p">.</span><span class="nx">trendIncomeAnnual</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">trendIncomeAnnual</span><span class="p">;</span>

                        <span class="c1">//交易统计
</span><span class="c1"></span>                        <span class="nx">vue</span><span class="p">.</span><span class="nx">winCount</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">winCount</span><span class="p">;</span>
                        <span class="nx">vue</span><span class="p">.</span><span class="nx">lossCount</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">lossCount</span><span class="p">;</span>
                        <span class="nx">vue</span><span class="p">.</span><span class="nx">avgWinRate</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">avgWinRate</span><span class="p">;</span>
                        <span class="nx">vue</span><span class="p">.</span><span class="nx">avgLossRate</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">avgLossRate</span><span class="p">;</span>

                        <span class="c1">//每年收益
</span><span class="c1"></span>                        <span class="nx">vue</span><span class="p">.</span><span class="nx">annualProfits</span> <span class="o">=</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">annualProfits</span><span class="p">;</span>

                        <span class="c1">//指数数据
</span><span class="c1"></span>                        <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="k">in</span> <span class="nx">vue</span><span class="p">.</span><span class="nx">indexDatas</span><span class="p">)</span> <span class="p">{</span>
                            <span class="kd">var</span> <span class="nx">indexData</span> <span class="o">=</span> <span class="nx">vue</span><span class="p">.</span><span class="nx">indexDatas</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
                            <span class="nx">vue</span><span class="p">.</span><span class="nx">dates</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">indexData</span><span class="p">.</span><span class="nx">date</span><span class="p">);</span>
                            <span class="nx">vue</span><span class="p">.</span><span class="nx">closePoints</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">indexData</span><span class="p">.</span><span class="nx">closePoint</span><span class="p">);</span>

                            <span class="kd">var</span> <span class="nx">profit</span> <span class="o">=</span> <span class="nx">vue</span><span class="p">.</span><span class="nx">profits</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
                            <span class="nx">vue</span><span class="p">.</span><span class="nx">profitValues</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">profit</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
                        <span class="p">}</span>

                        <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="k">in</span> <span class="nx">vue</span><span class="p">.</span><span class="nx">annualProfits</span><span class="p">)</span> <span class="p">{</span>
                            <span class="nx">vue</span><span class="p">.</span><span class="nx">annuals</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">vue</span><span class="p">.</span><span class="nx">annualProfits</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">year</span><span class="p">);</span>
                            <span class="nx">vue</span><span class="p">.</span><span class="nx">indexIncomes</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">vue</span><span class="p">.</span><span class="nx">annualProfits</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">indexIncome</span> <span class="o">*</span> <span class="mi">100</span><span class="p">);</span>
                            <span class="nx">vue</span><span class="p">.</span><span class="nx">trendIncomes</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">vue</span><span class="p">.</span><span class="nx">annualProfits</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">trendIncome</span> <span class="o">*</span> <span class="mi">100</span><span class="p">);</span>
                        <span class="p">}</span>

                        <span class="c1">//收益图表
</span><span class="c1"></span>                        <span class="nx">chart4Profit</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">labels</span> <span class="o">=</span> <span class="nx">vue</span><span class="p">.</span><span class="nx">dates</span><span class="p">;</span>
                        <span class="nx">chart4Profit</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">datasets</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">label</span> <span class="o">=</span> <span class="nx">vue</span><span class="p">.</span><span class="nx">currentIndex</span><span class="p">;</span>
                        <span class="nx">chart4Profit</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">datasets</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">data</span> <span class="o">=</span> <span class="nx">vue</span><span class="p">.</span><span class="nx">closePoints</span><span class="p">;</span>
                        <span class="nx">chart4Profit</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">datasets</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">data</span> <span class="o">=</span> <span class="nx">vue</span><span class="p">.</span><span class="nx">profitValues</span><span class="p">;</span>
                        <span class="nx">chart4Profit</span><span class="p">.</span><span class="nx">update</span><span class="p">();</span>

                        <span class="nx">chart4AnnualIncome</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">labels</span> <span class="o">=</span> <span class="nx">vue</span><span class="p">.</span><span class="nx">annuals</span><span class="p">;</span>
                        <span class="nx">chart4AnnualIncome</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">datasets</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">label</span> <span class="o">=</span> <span class="nx">vue</span><span class="p">.</span><span class="nx">currentIndex</span><span class="p">;</span>
                        <span class="nx">chart4AnnualIncome</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">datasets</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">data</span> <span class="o">=</span> <span class="nx">vue</span><span class="p">.</span><span class="nx">indexIncomes</span><span class="p">;</span>
                        <span class="nx">chart4AnnualIncome</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">datasets</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">data</span> <span class="o">=</span> <span class="nx">vue</span><span class="p">.</span><span class="nx">trendIncomes</span><span class="p">;</span>
                        <span class="nx">chart4AnnualIncome</span><span class="p">.</span><span class="nx">update</span><span class="p">();</span>

                        <span class="k">if</span> <span class="p">(</span><span class="nx">vue</span><span class="p">.</span><span class="nx">flushDate</span><span class="p">)</span>
                            <span class="nx">vue</span><span class="p">.</span><span class="nx">updateDate</span><span class="p">();</span>

                    <span class="p">});</span>
                <span class="p">},</span>
                <span class="nx">changeParam</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                    <span class="nx">vue</span><span class="p">.</span><span class="nx">flushDate</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
                    <span class="nx">vue</span><span class="p">.</span><span class="nx">simulate</span><span class="p">();</span>
                <span class="p">},</span>
                <span class="nx">changeParamWithFlushDate</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                    <span class="nx">vue</span><span class="p">.</span><span class="nx">flushDate</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                    <span class="nx">vue</span><span class="p">.</span><span class="nx">startDate</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
                    <span class="nx">vue</span><span class="p">.</span><span class="nx">endDate</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
                    <span class="nx">vue</span><span class="p">.</span><span class="nx">simulate</span><span class="p">();</span>
                <span class="p">},</span>
                <span class="nx">updateDate</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                    <span class="nx">vue</span><span class="p">.</span><span class="nx">startDate</span> <span class="o">=</span> <span class="nx">vue</span><span class="p">.</span><span class="nx">indexStartDate</span><span class="p">;</span>
                    <span class="nx">vue</span><span class="p">.</span><span class="nx">endDate</span> <span class="o">=</span> <span class="nx">vue</span><span class="p">.</span><span class="nx">indexEndDate</span><span class="p">;</span>

                    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;vue.indexStartDate：&#34;</span> <span class="o">+</span> <span class="nx">vue</span><span class="p">.</span><span class="nx">indexStartDate</span><span class="p">);</span>

                    <span class="c1">//需要先destroy，否则后续新的日期范围如果超出了前面的日期范围，会出冲突
</span><span class="c1"></span>                    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#date4Start&#39;</span><span class="p">).</span><span class="nx">datepicker</span><span class="p">(</span><span class="s2">&#34;destroy&#34;</span><span class="p">);</span>
                    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#date4Start&#39;</span><span class="p">).</span><span class="nx">datepicker</span><span class="p">({</span>
                        <span class="s2">&#34;format&#34;</span><span class="o">:</span> <span class="s1">&#39;yyyy-mm-dd&#39;</span><span class="p">,</span>
                        <span class="s2">&#34;language&#34;</span><span class="o">:</span> <span class="s2">&#34;zh-CN&#34;</span><span class="p">,</span>
                        <span class="nx">autoclose</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
                        <span class="nx">startDate</span><span class="o">:</span> <span class="nx">vue</span><span class="p">.</span><span class="nx">indexStartDate</span><span class="p">,</span>
                        <span class="nx">endDate</span><span class="o">:</span> <span class="nx">vue</span><span class="p">.</span><span class="nx">indexEndDate</span><span class="p">,</span>
                    <span class="p">}).</span><span class="nx">on</span><span class="p">(</span><span class="s2">&#34;changeDate&#34;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
                        <span class="kd">var</span> <span class="nx">month</span> <span class="o">=</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">date</span><span class="p">.</span><span class="nx">getMonth</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">month</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span>
                            <span class="nx">month</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span> <span class="o">+</span> <span class="nx">month</span><span class="p">;</span>
                        <span class="kd">var</span> <span class="nx">day</span> <span class="o">=</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">date</span><span class="p">.</span><span class="nx">getDate</span><span class="p">());</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">day</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span>
                            <span class="nx">day</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span> <span class="o">+</span> <span class="nx">day</span><span class="p">;</span>
                        <span class="nx">vue</span><span class="p">.</span><span class="nx">startDate</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">date</span><span class="p">.</span><span class="nx">getFullYear</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&#34;-&#34;</span> <span class="o">+</span> <span class="nx">month</span> <span class="o">+</span> <span class="s2">&#34;-&#34;</span> <span class="o">+</span> <span class="nx">day</span><span class="p">;</span>

                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">vue</span><span class="p">.</span><span class="nx">checkDateRange</span><span class="p">())</span> <span class="p">{</span>
                            <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#date4Start&#39;</span><span class="p">).</span><span class="nx">datepicker</span><span class="p">(</span><span class="s1">&#39;update&#39;</span><span class="p">,</span> <span class="nx">vue</span><span class="p">.</span><span class="nx">indexStartDate</span><span class="p">);</span>
                            <span class="k">return</span><span class="p">;</span>
                        <span class="p">}</span>

                        <span class="nx">vue</span><span class="p">.</span><span class="nx">changeParam</span><span class="p">();</span>
                    <span class="p">});</span>

                    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#date4End&#39;</span><span class="p">).</span><span class="nx">datepicker</span><span class="p">(</span><span class="s2">&#34;destroy&#34;</span><span class="p">);</span>
                    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#date4End&#39;</span><span class="p">).</span><span class="nx">datepicker</span><span class="p">({</span>
                        <span class="s2">&#34;format&#34;</span><span class="o">:</span> <span class="s1">&#39;yyyy-mm-dd&#39;</span><span class="p">,</span>
                        <span class="s2">&#34;language&#34;</span><span class="o">:</span> <span class="s2">&#34;zh-CN&#34;</span><span class="p">,</span>
                        <span class="nx">autoclose</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
                        <span class="nx">startDate</span><span class="o">:</span> <span class="nx">vue</span><span class="p">.</span><span class="nx">indexStartDate</span><span class="p">,</span>
                        <span class="nx">endDate</span><span class="o">:</span> <span class="nx">vue</span><span class="p">.</span><span class="nx">indexEndDate</span><span class="p">,</span>
                    <span class="p">}).</span><span class="nx">on</span><span class="p">(</span><span class="s2">&#34;changeDate&#34;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
                        <span class="kd">var</span> <span class="nx">month</span> <span class="o">=</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">date</span><span class="p">.</span><span class="nx">getMonth</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">month</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span>
                            <span class="nx">month</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span> <span class="o">+</span> <span class="nx">month</span><span class="p">;</span>
                        <span class="kd">var</span> <span class="nx">day</span> <span class="o">=</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">date</span><span class="p">.</span><span class="nx">getDate</span><span class="p">());</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">day</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span>
                            <span class="nx">day</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span> <span class="o">+</span> <span class="nx">day</span><span class="p">;</span>
                        <span class="nx">vue</span><span class="p">.</span><span class="nx">endDate</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">date</span><span class="p">.</span><span class="nx">getFullYear</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&#34;-&#34;</span> <span class="o">+</span> <span class="nx">month</span> <span class="o">+</span> <span class="s2">&#34;-&#34;</span> <span class="o">+</span> <span class="nx">day</span><span class="p">;</span>
                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">vue</span><span class="p">.</span><span class="nx">checkDateRange</span><span class="p">())</span> <span class="p">{</span>
                            <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#date4End&#39;</span><span class="p">).</span><span class="nx">datepicker</span><span class="p">(</span><span class="s1">&#39;update&#39;</span><span class="p">,</span> <span class="nx">vue</span><span class="p">.</span><span class="nx">indexEndDate</span><span class="p">);</span>
                            <span class="k">return</span><span class="p">;</span>
                        <span class="p">}</span>

                        <span class="nx">vue</span><span class="p">.</span><span class="nx">changeParam</span><span class="p">();</span>

                    <span class="p">});</span>

                    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#date4Start&#39;</span><span class="p">).</span><span class="nx">datepicker</span><span class="p">(</span><span class="s1">&#39;update&#39;</span><span class="p">,</span> <span class="nx">vue</span><span class="p">.</span><span class="nx">indexStartDate</span><span class="p">);</span>
                    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#date4End&#39;</span><span class="p">).</span><span class="nx">datepicker</span><span class="p">(</span><span class="s1">&#39;update&#39;</span><span class="p">,</span> <span class="nx">vue</span><span class="p">.</span><span class="nx">indexEndDate</span><span class="p">);</span>
                <span class="p">},</span>
                <span class="nx">checkDateRange</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="kc">null</span> <span class="o">==</span> <span class="nx">vue</span><span class="p">.</span><span class="nx">startDate</span> <span class="o">||</span> <span class="kc">null</span> <span class="o">==</span> <span class="nx">vue</span><span class="p">.</span><span class="nx">endDate</span><span class="p">)</span>
                        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>

                    <span class="kd">var</span> <span class="nx">strStartDate</span> <span class="o">=</span> <span class="nx">vue</span><span class="p">.</span><span class="nx">startDate</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/-/g</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
                    <span class="kd">var</span> <span class="nx">startTime</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">strStartDate</span><span class="p">).</span><span class="nx">getTime</span><span class="p">();</span>
                    <span class="kd">var</span> <span class="nx">strEndDate</span> <span class="o">=</span> <span class="nx">vue</span><span class="p">.</span><span class="nx">endDate</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/-/g</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
                    <span class="kd">var</span> <span class="nx">endTime</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">strEndDate</span><span class="p">).</span><span class="nx">getTime</span><span class="p">();</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">startTime</span> <span class="o">&gt;</span> <span class="nx">endTime</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">alert</span><span class="p">(</span><span class="s2">&#34;开始日期不能大于日期！&#34;</span><span class="p">);</span>
                        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>

                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">});</span>

        <span class="kd">var</span> <span class="nx">ctx4Profit</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&#34;.canvas4Profit&#34;</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">getContext</span><span class="p">(</span><span class="s1">&#39;2d&#39;</span><span class="p">);</span>
        <span class="nx">chart4Profit</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Chart</span><span class="p">(</span><span class="nx">ctx4Profit</span><span class="p">,</span> <span class="p">{</span>
            <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;line&#39;</span><span class="p">,</span>
            <span class="nx">data</span><span class="o">:</span> <span class="p">{</span>
                <span class="nx">labels</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="nx">datasets</span><span class="o">:</span> <span class="p">[</span>
                    <span class="p">{</span>
                        <span class="nx">label</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                        <span class="nx">data</span><span class="o">:</span> <span class="p">[],</span>
                        <span class="nx">borderColor</span><span class="o">:</span> <span class="s1">&#39;#FF4040&#39;</span><span class="p">,</span>
                        <span class="nx">backgroundColor</span><span class="o">:</span> <span class="s1">&#39;#FF4040&#39;</span><span class="p">,</span>
                        <span class="nx">borderWidth</span><span class="o">:</span> <span class="mf">1.2</span><span class="p">,</span>
                        <span class="nx">pointRadius</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="nx">fill</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
                        <span class="nx">lineTension</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="p">},</span>
                    <span class="p">{</span>
                        <span class="nx">label</span><span class="o">:</span> <span class="s1">&#39;趋势投资&#39;</span><span class="p">,</span>
                        <span class="nx">data</span><span class="o">:</span> <span class="p">[],</span>
                        <span class="nx">borderColor</span><span class="o">:</span> <span class="s1">&#39;#5D98C8&#39;</span><span class="p">,</span>
                        <span class="nx">backgroundColor</span><span class="o">:</span> <span class="s1">&#39;#5D98C8&#39;</span><span class="p">,</span>
                        <span class="nx">borderWidth</span><span class="o">:</span> <span class="mf">1.2</span><span class="p">,</span>
                        <span class="nx">pointRadius</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="nx">fill</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
                        <span class="nx">lineTension</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">]</span>
            <span class="p">},</span>
            <span class="nx">options</span><span class="o">:</span> <span class="p">{</span>
                <span class="nx">title</span><span class="o">:</span> <span class="p">{</span>
                    <span class="nx">display</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
                    <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;指数趋势投资收益对比图&#39;</span>
                <span class="p">},</span>
                <span class="nx">responsive</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
                <span class="nx">responsiveAnimationDuration</span><span class="o">:</span> <span class="mi">3000</span><span class="p">,</span>
                <span class="nx">scales</span><span class="o">:</span> <span class="p">{</span>
                    <span class="nx">yAxes</span><span class="o">:</span> <span class="p">[{</span>
                        <span class="nx">ticks</span><span class="o">:</span> <span class="p">{</span>
                            <span class="nx">beginAtZero</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
                        <span class="p">}</span>
                    <span class="p">}]</span>
                <span class="p">},</span>
                <span class="nx">tooltips</span><span class="o">:</span> <span class="p">{</span>
                    <span class="nx">intersect</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
                    <span class="nx">mode</span><span class="o">:</span> <span class="s1">&#39;index&#39;</span><span class="p">,</span>
<span class="c1">//                      axis: &#39;y&#39;,
</span><span class="c1"></span>                    <span class="nx">callbacks</span><span class="o">:</span> <span class="p">{</span>
                        <span class="nx">label</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">tooltipItem</span><span class="p">,</span> <span class="nx">myData</span><span class="p">)</span> <span class="p">{</span>
                            <span class="kd">var</span> <span class="nx">label</span> <span class="o">=</span> <span class="nx">myData</span><span class="p">.</span><span class="nx">datasets</span><span class="p">[</span><span class="nx">tooltipItem</span><span class="p">.</span><span class="nx">datasetIndex</span><span class="p">].</span><span class="nx">label</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
                            <span class="k">if</span> <span class="p">(</span><span class="nx">label</span><span class="p">)</span> <span class="p">{</span>
                                <span class="nx">label</span> <span class="o">+=</span> <span class="s1">&#39;: &#39;</span><span class="p">;</span>
                            <span class="p">}</span>
                            <span class="nx">label</span> <span class="o">+=</span> <span class="nb">parseFloat</span><span class="p">(</span><span class="nx">tooltipItem</span><span class="p">.</span><span class="nx">value</span><span class="p">).</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
                            <span class="k">return</span> <span class="nx">label</span><span class="p">;</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">});</span>

        <span class="kd">var</span> <span class="nx">ctx4AnnualIncome</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&#34;.canvas4AnnualIncome&#34;</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">getContext</span><span class="p">(</span><span class="s1">&#39;2d&#39;</span><span class="p">);</span>
        <span class="nx">chart4AnnualIncome</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Chart</span><span class="p">(</span><span class="nx">ctx4AnnualIncome</span><span class="p">,</span> <span class="p">{</span>
            <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;bar&#39;</span><span class="p">,</span>
            <span class="nx">data</span><span class="o">:</span> <span class="p">{</span>
                <span class="nx">labels</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="nx">datasets</span><span class="o">:</span> <span class="p">[</span>
                    <span class="p">{</span>
                        <span class="nx">label</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                        <span class="nx">data</span><span class="o">:</span> <span class="p">[],</span>
                        <span class="nx">borderColor</span><span class="o">:</span> <span class="s1">&#39;#FF4040&#39;</span><span class="p">,</span>
                        <span class="nx">backgroundColor</span><span class="o">:</span> <span class="s1">&#39;#FF4040&#39;</span><span class="p">,</span>
                        <span class="nx">borderWidth</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="nx">pointRadius</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="nx">fill</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
                        <span class="nx">lineTension</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="p">},</span>
                    <span class="p">{</span>
                        <span class="nx">label</span><span class="o">:</span> <span class="s1">&#39;趋势投资&#39;</span><span class="p">,</span>
                        <span class="nx">data</span><span class="o">:</span> <span class="p">[],</span>
                        <span class="nx">borderColor</span><span class="o">:</span> <span class="s1">&#39;#5D98C8&#39;</span><span class="p">,</span>
                        <span class="nx">backgroundColor</span><span class="o">:</span> <span class="s1">&#39;#5D98C8&#39;</span><span class="p">,</span>
                        <span class="nx">borderWidth</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="nx">pointRadius</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="nx">fill</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
                        <span class="nx">lineTension</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">]</span>
            <span class="p">},</span>
            <span class="nx">options</span><span class="o">:</span> <span class="p">{</span>
                <span class="nx">title</span><span class="o">:</span> <span class="p">{</span>
                    <span class="nx">display</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
                    <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;指数/趋势收益分布对比图&#39;</span>
                <span class="p">},</span>
                <span class="nx">responsive</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
                <span class="nx">responsiveAnimationDuration</span><span class="o">:</span> <span class="mi">3000</span><span class="p">,</span>
                <span class="nx">scales</span><span class="o">:</span> <span class="p">{</span>
                    <span class="nx">yAxes</span><span class="o">:</span> <span class="p">[{</span>
                        <span class="nx">ticks</span><span class="o">:</span> <span class="p">{</span>
                            <span class="nx">beginAtZero</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
<span class="c1">//                              suggestedMin: -10,
</span><span class="c1">//                              suggestedMax: 200,
</span><span class="c1"></span>                        <span class="p">}</span>
                    <span class="p">}]</span>
                <span class="p">},</span>
                <span class="nx">tooltips</span><span class="o">:</span> <span class="p">{</span>
                    <span class="nx">intersect</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
                    <span class="nx">mode</span><span class="o">:</span> <span class="s1">&#39;index&#39;</span><span class="p">,</span>

                    <span class="nx">callbacks</span><span class="o">:</span> <span class="p">{</span>
                        <span class="nx">label</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">tooltipItem</span><span class="p">,</span> <span class="nx">myData</span><span class="p">)</span> <span class="p">{</span>
                            <span class="kd">var</span> <span class="nx">label</span> <span class="o">=</span> <span class="nx">myData</span><span class="p">.</span><span class="nx">datasets</span><span class="p">[</span><span class="nx">tooltipItem</span><span class="p">.</span><span class="nx">datasetIndex</span><span class="p">].</span><span class="nx">label</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
                            <span class="k">if</span> <span class="p">(</span><span class="nx">label</span><span class="p">)</span> <span class="p">{</span>
                                <span class="nx">label</span> <span class="o">+=</span> <span class="s1">&#39;: &#39;</span><span class="p">;</span>
                            <span class="p">}</span>
                            <span class="nx">label</span> <span class="o">+=</span> <span class="nb">parseFloat</span><span class="p">(</span><span class="nx">tooltipItem</span><span class="p">.</span><span class="nx">value</span><span class="p">).</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
                            <span class="nx">label</span> <span class="o">+=</span> <span class="s2">&#34;%&#34;</span><span class="p">;</span>
                            <span class="k">return</span> <span class="nx">label</span><span class="p">;</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">});</span>

    <span class="p">});</span>

<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">style</span><span class="p">&gt;</span>
    <span class="nt">table</span><span class="p">.</span><span class="nc">inputTable</span> <span class="p">{</span>
        <span class="k">width</span><span class="p">:</span> <span class="mi">100</span><span class="kt">%</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nt">table</span><span class="p">.</span><span class="nc">inputTable</span> <span class="nt">td</span> <span class="p">{</span>
        <span class="k">padding</span><span class="p">:</span> <span class="mi">20</span><span class="kt">px</span> <span class="mi">20</span><span class="kt">px</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nt">table</span> <span class="p">{</span>
        <span class="k">margin</span><span class="p">:</span> <span class="mi">20</span><span class="kt">px</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nt">div</span><span class="p">#</span><span class="nn">workingArea</span> <span class="p">{</span>
        <span class="k">margin</span><span class="p">:</span> <span class="mi">50</span><span class="kt">px</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">&lt;/</span><span class="nt">style</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;workingArea&#34;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;label label-info&#34;</span><span class="p">&gt;</span>回测参数<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">table</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;inputTable &#34;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span> <span class="na">width</span><span class="o">=</span><span class="s">&#34;25%&#34;</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">span</span> <span class="na">data-toggle</span><span class="o">=</span><span class="s">&#34;tooltip&#34;</span> <span class="na">data-placement</span><span class="o">=</span><span class="s">&#34;top&#34;</span> <span class="na">title</span><span class="o">=</span><span class="s">&#34;选择某一个指数进行模拟回测&#34;</span><span class="p">&gt;</span>
                    请选择指数:<span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;glyphicon glyphicon-question-sign&#34;</span><span class="p">&gt;</span> <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
                <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
            <span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span> <span class="na">width</span><span class="o">=</span><span class="s">&#34;25%&#34;</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">select</span> <span class="err">@</span><span class="na">change</span><span class="o">=</span><span class="s">&#34;changeParamWithFlushDate&#34;</span> <span class="na">v-model</span><span class="o">=</span><span class="s">&#34;currentIndex&#34;</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;indexSelect form-control&#34;</span><span class="p">&gt;</span>
                    <span class="p">&lt;</span><span class="nt">option</span> <span class="na">v-for</span><span class="o">=</span><span class="s">&#34;bean in indexes &#34;</span> <span class="na">:value</span><span class="o">=</span><span class="s">&#34;bean.code&#34;</span><span class="p">&gt;</span>{{bean.name}} - ( {{bean.code}} )<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
                <span class="p">&lt;/</span><span class="nt">select</span><span class="p">&gt;</span>
            <span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span> <span class="na">width</span><span class="o">=</span><span class="s">&#34;25%&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span> <span class="na">width</span><span class="o">=</span><span class="s">&#34;25%&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>
                            <span class="p">&lt;</span><span class="nt">span</span> <span class="na">data-toggle</span><span class="o">=</span><span class="s">&#34;tooltip&#34;</span> <span class="na">data-placement</span><span class="o">=</span><span class="s">&#34;top&#34;</span>
                                  <span class="na">title</span><span class="o">=</span><span class="s">&#34;MA 即 moving average, 移动均线的意思。 比如MA20就表示20日均线，取最近20天的值的平均数&#34;</span><span class="p">&gt;</span>
                            MA(均线) :<span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;glyphicon glyphicon-question-sign   &#34;</span><span class="p">&gt;</span> <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
                        <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
            <span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">select</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;form-control&#34;</span> <span class="err">@</span><span class="na">change</span><span class="o">=</span><span class="s">&#34;changeParam&#34;</span> <span class="na">v-model</span><span class="o">=</span><span class="s">&#34;ma&#34;</span><span class="p">&gt;</span>
                    <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#34;5&#34;</span><span class="p">&gt;</span>5日<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
                    <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#34;10&#34;</span><span class="p">&gt;</span>10日<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
                    <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#34;20&#34;</span><span class="p">&gt;</span>20日<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
                    <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#34;60&#34;</span><span class="p">&gt;</span>60日<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
                <span class="p">&lt;/</span><span class="nt">select</span><span class="p">&gt;</span>
            <span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>
                        <span class="p">&lt;</span><span class="nt">span</span> <span class="na">data-toggle</span><span class="o">=</span><span class="s">&#34;tooltip&#34;</span> <span class="na">data-placement</span><span class="o">=</span><span class="s">&#34;top&#34;</span>
                              <span class="na">title</span><span class="o">=</span><span class="s">&#34;当前值大于均线，说明上升趋势来了，就可以购买，或者再稍等等，比均线多 5% 再下手，那么购买阈值就是 1.05 &#34;</span><span class="p">&gt;</span>
                            购买阈值:<span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;glyphicon glyphicon-question-sign  &#34;</span><span class="p">&gt;</span> <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
                        <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>

            <span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">select</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;form-control&#34;</span> <span class="err">@</span><span class="na">change</span><span class="o">=</span><span class="s">&#34;changeParam&#34;</span> <span class="na">v-model</span><span class="o">=</span><span class="s">&#34;buyThreshold&#34;</span><span class="p">&gt;</span>
                    <span class="p">&lt;</span><span class="nt">option</span> <span class="na">v-for</span><span class="o">=</span><span class="s">&#34;i in 9&#34;</span> <span class="na">:value</span><span class="o">=</span><span class="s">&#34;i/100+1&#34;</span><span class="p">&gt;</span>{{i/100+1|formatNumberFilter(2)}}<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
                <span class="p">&lt;/</span><span class="nt">select</span><span class="p">&gt;</span>
            <span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>

                        <span class="p">&lt;</span><span class="nt">span</span> <span class="na">data-toggle</span><span class="o">=</span><span class="s">&#34;tooltip&#34;</span> <span class="na">data-placement</span><span class="o">=</span><span class="s">&#34;top&#34;</span>
                              <span class="na">title</span><span class="o">=</span><span class="s">&#34;当前值低于均线，说明下跌趋势来了，就可以出售，或者再稍等等，比最近的高点低 5%，那么购买阈值就是 0.95&#34;</span><span class="p">&gt;</span>
                            出售阈值:<span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;glyphicon glyphicon-question-sign  &#34;</span><span class="p">&gt;</span> <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
                        <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>

            <span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>

                <span class="p">&lt;</span><span class="nt">select</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;form-control&#34;</span> <span class="err">@</span><span class="na">change</span><span class="o">=</span><span class="s">&#34;changeParam&#34;</span> <span class="na">v-model</span><span class="o">=</span><span class="s">&#34;sellThreshold&#34;</span><span class="p">&gt;</span>
                    <span class="p">&lt;</span><span class="nt">option</span> <span class="na">v-for</span><span class="o">=</span><span class="s">&#34;i in 10&#34;</span> <span class="na">:value</span><span class="o">=</span><span class="s">&#34;1-i/100&#34;</span><span class="p">&gt;</span>{{1-i/100|formatNumberFilter(2)}}<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
                <span class="p">&lt;/</span><span class="nt">select</span><span class="p">&gt;</span>
            <span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>
                        <span class="p">&lt;</span><span class="nt">span</span> <span class="na">data-toggle</span><span class="o">=</span><span class="s">&#34;tooltip&#34;</span> <span class="na">data-placement</span><span class="o">=</span><span class="s">&#34;top&#34;</span>
                              <span class="na">title</span><span class="o">=</span><span class="s">&#34;每一笔交易都会有手续费，一般说来手续费都不高，千分之 1.5 的左右，默认是没有计算手续费的&#34;</span><span class="p">&gt;</span>
                            手续费:<span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;glyphicon glyphicon-question-sign   &#34;</span><span class="p">&gt;</span> <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
                        <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
            <span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">select</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;form-control&#34;</span> <span class="err">@</span><span class="na">change</span><span class="o">=</span><span class="s">&#34;changeParam&#34;</span> <span class="na">v-model</span><span class="o">=</span><span class="s">&#34;serviceCharge&#34;</span><span class="p">&gt;</span>
                    <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#34;0&#34;</span><span class="p">&gt;</span>无<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
                    <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#34;0.001&#34;</span><span class="p">&gt;</span>0.1%<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
                    <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#34;0.0015&#34;</span><span class="p">&gt;</span>0.15%<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
                    <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#34;0.002&#34;</span><span class="p">&gt;</span>0.2%<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
                <span class="p">&lt;/</span><span class="nt">select</span><span class="p">&gt;</span>
            <span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>
                        <span class="p">&lt;</span><span class="nt">span</span> <span class="na">data-toggle</span><span class="o">=</span><span class="s">&#34;tooltip&#34;</span> <span class="na">data-placement</span><span class="o">=</span><span class="s">&#34;top&#34;</span> <span class="na">title</span><span class="o">=</span><span class="s">&#34;指定模拟回测的开始日期，默认是当前指数最开始的日期&#34;</span><span class="p">&gt;</span>
                            开始日期:<span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;glyphicon glyphicon-question-sign  &#34;</span><span class="p">&gt;</span> <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
                        <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
            <span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;form-group&#34;</span><span class="p">&gt;</span>
                    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;input-group date&#34;</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;date4Start&#34;</span><span class="p">&gt;</span>
                        <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;text&#34;</span> <span class="na">readOnly</span><span class="o">=</span><span class="s">&#34;readOnly&#34;</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;form-control&#34;</span><span class="p">&gt;&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;input-group-addon&#34;</span><span class="p">&gt;&lt;</span><span class="nt">i</span>
                            <span class="na">class</span><span class="o">=</span><span class="s">&#34;glyphicon glyphicon-th&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">i</span><span class="p">&gt;&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
                    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
                <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
            <span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>
                        <span class="p">&lt;</span><span class="nt">span</span> <span class="na">data-toggle</span><span class="o">=</span><span class="s">&#34;tooltip&#34;</span> <span class="na">data-placement</span><span class="o">=</span><span class="s">&#34;top&#34;</span> <span class="na">title</span><span class="o">=</span><span class="s">&#34;指定模拟回测的结束日期，默认是当前指数最后的日期&#34;</span><span class="p">&gt;</span>
                            结束日期:<span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;glyphicon glyphicon-question-sign  &#34;</span><span class="p">&gt;</span> <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
                        <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
            <span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;form-group&#34;</span><span class="p">&gt;</span>
                    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;input-group date&#34;</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;date4End&#34;</span><span class="p">&gt;</span>
                        <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;text&#34;</span> <span class="na">readOnly</span><span class="o">=</span><span class="s">&#34;readOnly&#34;</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;form-control&#34;</span><span class="p">&gt;&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;input-group-addon&#34;</span><span class="p">&gt;&lt;</span><span class="nt">i</span>
                            <span class="na">class</span><span class="o">=</span><span class="s">&#34;glyphicon glyphicon-th&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">i</span><span class="p">&gt;&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
                    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
                <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
            <span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>

        <span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">table</span><span class="p">&gt;</span>

    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;label label-warning&#34;</span><span class="p">&gt;</span>收益对比图<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;div4chart&#34;</span> <span class="na">style</span><span class="o">=</span><span class="s">&#34;margin:0px auto; width:80%&#34;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">canvas</span> <span class="na">class</span><span class="o">=</span><span class="s">&#39;canvas4Profit&#39;</span><span class="p">&gt;&lt;/</span><span class="nt">canvas</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;label label-warning&#34;</span><span class="p">&gt;</span>收益一览<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

    <span class="p">&lt;</span><span class="nt">table</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;table table-striped table-bordered table-condensed&#34;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">thead</span><span class="p">&gt;</span>

        <span class="p">&lt;</span><span class="nt">th</span><span class="p">&gt;</span>投资类型<span class="p">&lt;/</span><span class="nt">th</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">th</span><span class="p">&gt;</span>投资时长 (年)<span class="p">&lt;/</span><span class="nt">th</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">th</span><span class="p">&gt;</span>1000元投资收益<span class="p">&lt;/</span><span class="nt">th</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">th</span><span class="p">&gt;</span>总收益率<span class="p">&lt;/</span><span class="nt">th</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">th</span><span class="p">&gt;</span>年化收益率<span class="p">&lt;/</span><span class="nt">th</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">thead</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">tbody</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>指数投资<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>{{years|formatNumberFilter(2)}}<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>{{(indexIncomeTotal+1)*1000|formatMoneyFilter}}<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>{{indexIncomeTotal*100|formatNumberFilter(2)}}%<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>{{indexIncomeAnnual*100|formatNumberFilter(2)}}%<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>趋势投资<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>{{years|formatNumberFilter(2)}}<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>{{(trendIncomeTotal+1)*1000|formatMoneyFilter}}<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>{{trendIncomeTotal*100|formatNumberFilter(2)}}%<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>{{trendIncomeAnnual*100|formatNumberFilter(2)}}%<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>相对收益<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>n/a<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>{{(trendIncomeTotal-indexIncomeTotal)*1000|formatMoneyFilter}}<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>{{(trendIncomeTotal-indexIncomeTotal)*100|formatNumberFilter(2)}}%<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>{{(trendIncomeAnnual-indexIncomeAnnual)*100|formatNumberFilter(2)}}%<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>

        <span class="p">&lt;/</span><span class="nt">tbody</span><span class="p">&gt;</span>

    <span class="p">&lt;/</span><span class="nt">table</span><span class="p">&gt;</span>

    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;label label-warning&#34;</span><span class="p">&gt;</span>交易统计<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">table</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;table table-bordered table-condensed&#34;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">thead</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">th</span> <span class="na">align</span><span class="o">=</span><span class="s">&#34;center&#34;</span> <span class="na">colspan</span><span class="o">=</span><span class="s">&#34;2&#34;</span><span class="p">&gt;</span>趋势投资盈亏统计<span class="p">&lt;/</span><span class="nt">th</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">thead</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">tbody</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span> <span class="na">width</span><span class="o">=</span><span class="s">&#34;50%&#34;</span><span class="p">&gt;</span>总共交易次数<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>{{winCount+lossCount}}<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>盈利交易次数<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>{{winCount}}<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>平均盈利比率<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>{{avgWinRate*100|formatNumberFilter(2)}}%<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>亏损交易次数<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>{{lossCount}}<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>平均亏损比率<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>{{avgLossRate*100|formatNumberFilter(2)}}%<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>胜率<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>{{(winCount/(winCount+lossCount))*100|formatNumberFilter(2)}}%<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>

        <span class="p">&lt;/</span><span class="nt">tbody</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">table</span><span class="p">&gt;</span>

    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;label label-warning&#34;</span><span class="p">&gt;</span>收益分布对比表<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

    <span class="p">&lt;</span><span class="nt">table</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;table table-striped table-bordered table-condensed&#34;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">thead</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">th</span><span class="p">&gt;</span>年份<span class="p">&lt;/</span><span class="nt">th</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">th</span><span class="p">&gt;</span>指数收益<span class="p">&lt;/</span><span class="nt">th</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">th</span><span class="p">&gt;</span>趋势投资收益<span class="p">&lt;/</span><span class="nt">th</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">thead</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">tbody</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">tr</span> <span class="na">v-for</span><span class="o">=</span><span class="s">&#34;bean in annualProfits&#34;</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>
                {{bean.year}}
            <span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>
                {{bean.indexIncome*100|formatNumberFilter(2)}}%
            <span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>
                {{bean.trendIncome*100|formatNumberFilter(2)}}%
            <span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">tbody</span><span class="p">&gt;</span>

    <span class="p">&lt;/</span><span class="nt">table</span><span class="p">&gt;</span>

    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;label label-warning&#34;</span><span class="p">&gt;</span>收益分布对比图<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;div4chart&#34;</span> <span class="na">style</span><span class="o">=</span><span class="s">&#34;margin:0px auto; width:80%&#34;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">canvas</span> <span class="na">class</span><span class="o">=</span><span class="s">&#39;canvas4AnnualIncome&#39;</span><span class="p">&gt;&lt;/</span><span class="nt">canvas</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;label label-warning&#34;</span><span class="p">&gt;</span>交易明细<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

    <span class="p">&lt;</span><span class="nt">table</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;table table-striped table-bordered table-condensed table-hover&#34;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">thead</span><span class="p">&gt;</span>

        <span class="p">&lt;</span><span class="nt">th</span><span class="p">&gt;</span>盈/亏<span class="p">&lt;/</span><span class="nt">th</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">th</span><span class="p">&gt;</span>购买日期<span class="p">&lt;/</span><span class="nt">th</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">th</span><span class="p">&gt;</span>购买盘点<span class="p">&lt;/</span><span class="nt">th</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">th</span><span class="p">&gt;</span>出售日期<span class="p">&lt;/</span><span class="nt">th</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">th</span><span class="p">&gt;</span>出售盘点<span class="p">&lt;/</span><span class="nt">th</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">th</span><span class="p">&gt;</span>盈亏比率<span class="p">&lt;/</span><span class="nt">th</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">th</span><span class="p">&gt;</span>1000元投资收益<span class="p">&lt;/</span><span class="nt">th</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">thead</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">tbody</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">tr</span> <span class="na">v-for</span><span class="o">=</span><span class="s">&#34;bean in trades&#34;</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">span</span> <span class="na">v-if</span><span class="o">=</span><span class="s">&#34;bean.sellClosePoint&gt;bean.buyClosePoint&#34;</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;label label-danger&#34;</span><span class="p">&gt;</span>盈利<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">span</span> <span class="na">v-if</span><span class="o">=</span><span class="s">&#34;bean.sellClosePoint&lt;=bean.buyClosePoint&#34;</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;label label-success&#34;</span><span class="p">&gt;</span>亏损<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>

            <span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>{{bean.buyDate}}<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>{{bean.buyClosePoint}}<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>{{bean.sellDate}}<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>

                <span class="p">&lt;</span><span class="nt">span</span> <span class="na">v-if</span><span class="o">=</span><span class="s">&#34;bean.sellClosePoint==0&#34;</span><span class="p">&gt;</span>n/a<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">span</span> <span class="na">v-if</span><span class="o">=</span><span class="s">&#34;bean.sellClosePoint!=0&#34;</span><span class="p">&gt;</span>{{bean.sellClosePoint}}<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>

            <span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">span</span> <span class="na">v-if</span><span class="o">=</span><span class="s">&#34;bean.sellClosePoint==0&#34;</span><span class="p">&gt;</span>n/a<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>

                <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;label&#34;</span>
                      <span class="na">v-bind:class</span><span class="o">=</span><span class="s">&#34;{ &#39;label-danger&#39; : bean.sellClosePoint&gt;bean.buyClosePoint, &#39;label-success&#39; : bean.sellClosePoint&lt;=bean.buyClosePoint }&#34;</span>
                      <span class="na">v-if</span><span class="o">=</span><span class="s">&#34;bean.sellClosePoint!=0&#34;</span><span class="p">&gt;</span>{{(bean.sellClosePoint-bean.buyClosePoint)*100/bean.buyClosePoint | formatNumberFilter(2)}}%<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>

            <span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">span</span> <span class="na">v-if</span><span class="o">=</span><span class="s">&#34;bean.sellClosePoint==0&#34;</span><span class="p">&gt;</span>n/a<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">span</span> <span class="na">v-if</span><span class="o">=</span><span class="s">&#34;bean.sellClosePoint!=0&#34;</span><span class="p">&gt;</span>{{bean.rate*1000 | formatMoneyFilter }}<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>

            <span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>

        <span class="p">&lt;/</span><span class="nt">tbody</span><span class="p">&gt;</span>

    <span class="p">&lt;/</span><span class="nt">table</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">div</span> <span class="na">th:replace</span><span class="o">=</span><span class="s">&#34;include/footer::html&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p>incloud.header.html</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-html" data-lang="html"><span class="p">&lt;</span><span class="nt">template</span> <span class="na">th:fragment</span><span class="o">=</span><span class="s">&#34;html(title)&#34;</span><span class="p">&gt;</span>

    <span class="p">&lt;</span><span class="nt">link</span> <span class="na">href</span><span class="o">=</span><span class="s">&#34;css/bootstrap/3.3.6/bootstrap.min.css&#34;</span> <span class="na">rel</span><span class="o">=</span><span class="s">&#34;stylesheet&#34;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">link</span> <span class="na">href</span><span class="o">=</span><span class="s">&#34;css/bootstrap-datepicker/1.8.0/bootstrap-datepicker.min.css&#34;</span> <span class="na">rel</span><span class="o">=</span><span class="s">&#34;stylesheet&#34;</span><span class="p">&gt;</span>

    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&#34;js/jquery/2.0.0/jquery.min.js&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&#34;js/bootstrap/3.3.6/bootstrap.min.js&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&#34;js/vue/2.5.16/vue.min.js&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&#34;js/chartjs/2.8.0/chart.min.js&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&#34;js/axios/0.17.1/axios.min.js&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&#34;js/bootstrap-datepicker/1.8.0/bootstrap-datepicker.min.js&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&#34;js/bootstrap-datepicker/1.8.0/bootstrap-datepicker.zh-CN.min.js&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>

    <span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
        <span class="kd">function</span> <span class="nx">formatMoney</span><span class="p">(</span><span class="nx">num</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">num</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">String</span><span class="p">(</span><span class="nx">num</span><span class="p">);</span>
            <span class="nx">num</span> <span class="o">=</span> <span class="nx">num</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\$|\,/g</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">isNaN</span><span class="p">(</span><span class="nx">num</span><span class="p">))</span>
                <span class="nx">num</span> <span class="o">=</span> <span class="s2">&#34;0&#34;</span><span class="p">;</span>
            <span class="nx">sign</span> <span class="o">=</span> <span class="p">(</span><span class="nx">num</span> <span class="o">==</span> <span class="p">(</span><span class="nx">num</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">num</span><span class="p">)));</span>
            <span class="nx">num</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">num</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">+</span> <span class="mf">0.50000000001</span><span class="p">);</span>
            <span class="nx">cents</span> <span class="o">=</span> <span class="nx">num</span> <span class="o">%</span> <span class="mi">100</span><span class="p">;</span>
            <span class="nx">num</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">num</span> <span class="o">/</span> <span class="mi">100</span><span class="p">).</span><span class="nx">toString</span><span class="p">();</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">cents</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span>
                <span class="nx">cents</span> <span class="o">=</span> <span class="s2">&#34;0&#34;</span> <span class="o">+</span> <span class="nx">cents</span><span class="p">;</span>
            <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">((</span><span class="nx">num</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="nx">i</span><span class="p">))</span> <span class="o">/</span> <span class="mi">3</span><span class="p">);</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span>
                <span class="nx">num</span> <span class="o">=</span> <span class="nx">num</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">num</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="nx">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span>
                    <span class="nx">num</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">num</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="nx">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">));</span>
            <span class="k">return</span> <span class="p">(((</span><span class="nx">sign</span><span class="p">)</span> <span class="o">?</span> <span class="s1">&#39;&#39;</span> <span class="o">:</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="nx">num</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nx">cents</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="kd">function</span> <span class="nx">formatNumber</span><span class="p">(</span><span class="nx">number</span><span class="p">,</span> <span class="nx">decimals</span><span class="p">,</span> <span class="nx">dec_point</span><span class="p">,</span> <span class="nx">thousands_sep</span><span class="p">)</span> <span class="p">{</span>
            <span class="cm">/*
</span><span class="cm">            * 参数说明：
</span><span class="cm">            * number：要格式化的数字
</span><span class="cm">            * decimals：保留几位小数
</span><span class="cm">            * dec_point：小数点符号
</span><span class="cm">            * thousands_sep：千分位符号
</span><span class="cm">            * */</span>
            <span class="nx">number</span> <span class="o">=</span> <span class="p">(</span><span class="nx">number</span> <span class="o">+</span> <span class="s1">&#39;&#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/[^0-9+-Ee.]/g</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
            <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="o">!</span><span class="nb">isFinite</span><span class="p">(</span><span class="o">+</span><span class="nx">number</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">+</span><span class="nx">number</span><span class="p">,</span>
                <span class="nx">prec</span> <span class="o">=</span> <span class="o">!</span><span class="nb">isFinite</span><span class="p">(</span><span class="o">+</span><span class="nx">decimals</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">decimals</span><span class="p">),</span>
                <span class="nx">sep</span> <span class="o">=</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">thousands_sep</span> <span class="o">===</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="s1">&#39;,&#39;</span> <span class="o">:</span> <span class="nx">thousands_sep</span><span class="p">,</span>
                <span class="nx">dec</span> <span class="o">=</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">dec_point</span> <span class="o">===</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="s1">&#39;.&#39;</span> <span class="o">:</span> <span class="nx">dec_point</span><span class="p">,</span>
                <span class="nx">s</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="nx">toFixedFix</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">n</span><span class="p">,</span> <span class="nx">prec</span><span class="p">)</span> <span class="p">{</span>
                    <span class="kd">var</span> <span class="nx">k</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="nx">prec</span><span class="p">);</span>
                    <span class="k">return</span> <span class="s1">&#39;&#39;</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">ceil</span><span class="p">(</span><span class="nx">n</span> <span class="o">*</span> <span class="nx">k</span><span class="p">)</span> <span class="o">/</span> <span class="nx">k</span><span class="p">;</span>
                <span class="p">};</span>

            <span class="nx">s</span> <span class="o">=</span> <span class="p">(</span><span class="nx">prec</span> <span class="o">?</span> <span class="nx">toFixedFix</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span> <span class="nx">prec</span><span class="p">)</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">n</span><span class="p">)).</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">);</span>
            <span class="kd">var</span> <span class="nx">re</span> <span class="o">=</span> <span class="sr">/(-?\d+)(\d{3})/</span><span class="p">;</span>
            <span class="k">while</span> <span class="p">(</span><span class="nx">re</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="p">{</span>
                <span class="nx">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">s</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">replace</span><span class="p">(</span><span class="nx">re</span><span class="p">,</span> <span class="s2">&#34;$1&#34;</span> <span class="o">+</span> <span class="nx">sep</span> <span class="o">+</span> <span class="s2">&#34;$2&#34;</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">((</span><span class="nx">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">).</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="nx">prec</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
                <span class="nx">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="nx">prec</span> <span class="o">-</span> <span class="nx">s</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="nx">s</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">dec</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nx">Vue</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="s2">&#34;formatMoneyFilter&#34;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">formatMoney</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
        <span class="p">});</span>

        <span class="nx">Vue</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="s2">&#34;formatNumberFilter&#34;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">decimal</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">decimal</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span>
                <span class="nx">decimal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

            <span class="k">return</span> <span class="nx">formatNumber</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">decimal</span><span class="p">,</span> <span class="s2">&#34;.&#34;</span><span class="p">,</span> <span class="s2">&#34;,&#34;</span><span class="p">);</span>
        <span class="p">});</span>

        <span class="nx">Vue</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="s1">&#39;formatDateFilter&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">formatString</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="kc">null</span> <span class="o">==</span> <span class="nx">value</span><span class="p">)</span>
                <span class="k">return</span> <span class="s2">&#34;&#34;</span><span class="p">;</span>
            <span class="nx">formatString</span> <span class="o">=</span> <span class="nx">formatString</span> <span class="o">||</span> <span class="s1">&#39;YYYY-MM-DD&#39;</span><span class="p">;</span>
            <span class="k">return</span> <span class="nx">moment</span><span class="p">(</span><span class="nx">value</span><span class="p">).</span><span class="nx">format</span><span class="p">(</span><span class="nx">formatString</span><span class="p">);</span>
        <span class="p">});</span>

    <span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">http-equiv</span><span class="o">=</span><span class="s">&#34;Content-Type&#34;</span> <span class="na">content</span><span class="o">=</span><span class="s">&#34;text/html; charset=utf-8&#34;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;viewport&#34;</span>
          <span class="na">content</span><span class="o">=</span><span class="s">&#34;width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no&#34;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;apple-mobile-web-app-capable&#34;</span> <span class="na">content</span><span class="o">=</span><span class="s">&#34;yes&#34;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">http-equiv</span><span class="o">=</span><span class="s">&#34;X-UA-Compatible&#34;</span> <span class="na">content</span><span class="o">=</span><span class="s">&#34;IE=edge&#34;</span><span class="p">&gt;</span>

    <span class="p">&lt;</span><span class="nt">title</span> <span class="na">th:text</span><span class="o">=</span><span class="s">&#34;${title}&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">template</span><span class="p">&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p>include.footer.html</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-html" data-lang="html"><span class="p">&lt;</span><span class="nt">div</span> <span class="na">th:fragment</span><span class="o">=</span><span class="s">&#34;html&#34;</span> <span class="na">xmlns:th</span><span class="o">=</span><span class="s">&#34;http://www.w3.org/1999/xhtml&#34;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">style</span><span class="o">=</span><span class="s">&#34;margin:0px auto;text-align:center&#34;</span><span class="p">&gt;</span>
        powered by <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&#34;http://daniel1n.top&#34;</span><span class="p">&gt;</span>daniel1n.top<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">p</span> <span class="na">th:text</span><span class="o">=</span><span class="s">&#34;${version}&#34;</span><span class="p">&gt;</span>unknown<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

</code></pre></td></tr></table>
</div>
</div><h3 id="util-2">util</h3>
<p>FreshConfigUtil.java</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">cn.how2j.trend.util</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">cn.hutool.http.HttpUtil</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>

<span class="cm">/**
</span><span class="cm"> * @author qqlin
</span><span class="cm"> * @date 2020-6-16 10:57
</span><span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">FreshConfigUtil</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">headers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
        <span class="n">headers</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;Content-Type&#34;</span><span class="o">,</span> <span class="s">&#34;application/json; charset=utf-8&#34;</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;因为要去git获取，还要刷新index-config-server, 会比较卡，所以一般会要好几秒才能完成，请耐心等待&#34;</span><span class="o">);</span>

        <span class="n">String</span> <span class="n">result</span> <span class="o">=</span> <span class="n">HttpUtil</span><span class="o">.</span><span class="na">createPost</span><span class="o">(</span><span class="s">&#34;http://localhost:8041/actuator/bus-refresh&#34;</span><span class="o">).</span><span class="na">addHeaders</span><span class="o">(</span><span class="n">headers</span><span class="o">).</span><span class="na">execute</span><span class="o">().</span><span class="na">body</span><span class="o">();</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;result:&#34;</span> <span class="o">+</span> <span class="n">result</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;refresh 完成&#34;</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><h3 id="web-4">web</h3>
<p>ViewController.java</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">cn.how2j.trend.web</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Value</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cloud.context.config.annotation.RefreshScope</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Controller</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.ui.Model</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.GetMapping</span><span class="o">;</span>

<span class="cm">/**
</span><span class="cm"> * @author qqlin
</span><span class="cm"> * @date 2020-6-15 0:28
</span><span class="cm"> */</span>
<span class="nd">@Controller</span>
<span class="nd">@RefreshScope</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ViewController</span> <span class="o">{</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">&#34;${version}&#34;</span><span class="o">)</span>
    <span class="n">String</span> <span class="n">version</span><span class="o">;</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">&#34;/&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">view</span><span class="o">(</span><span class="n">Model</span> <span class="n">model</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">model</span><span class="o">.</span><span class="na">addAttribute</span><span class="o">(</span><span class="s">&#34;version&#34;</span><span class="o">,</span> <span class="n">version</span><span class="o">);</span>
        <span class="k">return</span> <span class="s">&#34;view&#34;</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><h2 id="210-配置服务器">2.10 配置服务器</h2>
<h3 id="module-8">module</h3>
<p>新建一个module，命名为index-config-server，修改pom.xml为</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-xml" data-lang="xml"><span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>

<span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0&#34;</span> <span class="na">xmlns:xsi=</span><span class="s">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
         <span class="na">xsi:schemaLocation=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&#34;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>

    <span class="nt">&lt;parent&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>trendParentProject<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>cn.how2j.trend<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/parent&gt;</span>

    <span class="nt">&lt;groupId&gt;</span>cn.how2j.trend<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>index-config-server<span class="nt">&lt;/artifactId&gt;</span>

    <span class="nt">&lt;dependencies&gt;</span>
        <span class="c">&lt;!--eureka--&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!--web--&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-web<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!--配置服务器--&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-config-server<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>

    <span class="nt">&lt;/dependencies&gt;</span>
<span class="nt">&lt;/project&gt;</span>

</code></pre></td></tr></table>
</div>
</div><h3 id="indexconfigserverapplication">IndexConfigServerApplication</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">cn.how2j.trend</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">cn.hutool.core.util.NetUtil</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.autoconfigure.SpringBootApplication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.builder.SpringApplicationBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cloud.client.discovery.EnableDiscoveryClient</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cloud.config.server.EnableConfigServer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cloud.netflix.eureka.EnableEurekaClient</span><span class="o">;</span>

<span class="cm">/**
</span><span class="cm"> * @author qqlin
</span><span class="cm"> * @date 2020-6-16 10:16
</span><span class="cm"> */</span>
<span class="nd">@SpringBootApplication</span>
<span class="nd">@EnableConfigServer</span>
<span class="nd">@EnableDiscoveryClient</span>
<span class="nd">@EnableEurekaClient</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">IndexConfigServerApplication</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="n">8060</span><span class="o">;</span>

        <span class="kt">int</span> <span class="n">eurekaServerPort</span> <span class="o">=</span> <span class="n">8761</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">NetUtil</span><span class="o">.</span><span class="na">isUsableLocalPort</span><span class="o">(</span><span class="n">eurekaServerPort</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">&#34;检查到端口%d 未启用，判断 eureka 服务器没有启动，本服务无法使用，故退出%n&#34;</span><span class="o">,</span> <span class="n">eurekaServerPort</span><span class="o">);</span>
            <span class="n">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(!</span><span class="n">NetUtil</span><span class="o">.</span><span class="na">isUsableLocalPort</span><span class="o">(</span><span class="n">port</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">&#34;端口%d被占用了，无法启动%n&#34;</span><span class="o">,</span> <span class="n">port</span><span class="o">);</span>
            <span class="n">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">new</span> <span class="n">SpringApplicationBuilder</span><span class="o">(</span><span class="n">IndexConfigServerApplication</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                <span class="o">.</span><span class="na">properties</span><span class="o">(</span><span class="s">&#34;server.port=&#34;</span> <span class="o">+</span> <span class="n">port</span><span class="o">)</span>
                <span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><h3 id="applicationyml-8">application.yml</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yml" data-lang="yml"><span class="k">spring</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">application</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">name</span><span class="p">:</span><span class="w"> </span>index-config-server<span class="w">
</span><span class="w">  </span><span class="k">cloud</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">config</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="k">label</span><span class="p">:</span><span class="w"> </span>master<span class="w">
</span><span class="w">      </span><span class="k">server</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="k">git</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="k">uri</span><span class="p">:</span><span class="w"> </span>https<span class="p">:</span>//github.com/daniel1n/trendConfig/<span class="w">
</span><span class="w">          </span><span class="k">search-paths</span><span class="p">:</span><span class="w"> </span>respo<span class="w">
</span><span class="w"></span><span class="k">eureka</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">client</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">service-url</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="k">defaultZone</span><span class="p">:</span><span class="w"> </span>http<span class="p">:</span>//localhost<span class="p">:</span><span class="m">8761</span>/eureka/<span class="w">
</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h2 id="211-断路器监控">2.11 断路器监控</h2>
<h3 id="module-9">module</h3>
<p>新建一个module，命名为index-hystrix-dashboard，修改pom.xml为</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-xml" data-lang="xml"><span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>

<span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0&#34;</span> <span class="na">xmlns:xsi=</span><span class="s">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
         <span class="na">xsi:schemaLocation=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&#34;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>

    <span class="nt">&lt;parent&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>trendParentProject<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>cn.how2j.trend<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/parent&gt;</span>

    <span class="nt">&lt;groupId&gt;</span>cn.how2j.trend<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>index-hystrix-dashboard<span class="nt">&lt;/artifactId&gt;</span>

    <span class="nt">&lt;dependencies&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-web<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-actuator<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-hystrix<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-hystrix-dashboard<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>

    <span class="nt">&lt;/dependencies&gt;</span>
<span class="nt">&lt;/project&gt;</span>

</code></pre></td></tr></table>
</div>
</div><h3 id="indexhystrixdashboardapplication">IndexHystrixDashboardApplication</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">cn.how2j.trend</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">cn.hutool.core.util.NetUtil</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.autoconfigure.SpringBootApplication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.builder.SpringApplicationBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cloud.netflix.hystrix.dashboard.EnableHystrixDashboard</span><span class="o">;</span>

<span class="cm">/**
</span><span class="cm"> * @author qqlin
</span><span class="cm"> * @date 2020-6-16 12:07
</span><span class="cm"> */</span>
<span class="nd">@SpringBootApplication</span>
<span class="nd">@EnableHystrixDashboard</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">IndexHystrixDashboardApplication</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="n">8070</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">eurekaServerPort</span> <span class="o">=</span> <span class="n">8761</span><span class="o">;</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">NetUtil</span><span class="o">.</span><span class="na">isUsableLocalPort</span><span class="o">(</span><span class="n">eurekaServerPort</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">&#34;检查到端口%d未启用， 判断 eureka 服务器没有启动，本服务无法使用，故退出%n&#34;</span><span class="o">,</span> <span class="n">eurekaServerPort</span><span class="o">);</span>
            <span class="n">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(!</span><span class="n">NetUtil</span><span class="o">.</span><span class="na">isUsableLocalPort</span><span class="o">(</span><span class="n">port</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">&#34;端口%d被占用了，无法启动%n&#34;</span><span class="o">,</span> <span class="n">port</span><span class="o">);</span>
            <span class="n">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">new</span> <span class="n">SpringApplicationBuilder</span><span class="o">(</span><span class="n">IndexHystrixDashboardApplication</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                <span class="o">.</span><span class="na">properties</span><span class="o">(</span><span class="s">&#34;server.port=&#34;</span> <span class="o">+</span> <span class="n">port</span><span class="o">)</span>
                <span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><h3 id="applicationyml-9">application.yml</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yml" data-lang="yml"><span class="k">spring</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">application</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">name</span><span class="p">:</span><span class="w"> </span>index-hystrix-dashboard<span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h2 id="212-断路器聚合监控">2.12 断路器聚合监控</h2>
<h3 id="module-10">module</h3>
<p>新建一个module，命名为 index-turbine，修改pom.xml为</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-xml" data-lang="xml"><span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>

<span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0&#34;</span> <span class="na">xmlns:xsi=</span><span class="s">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
         <span class="na">xsi:schemaLocation=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&#34;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>

    <span class="nt">&lt;parent&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>trendParentProject<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>cn.how2j.trend<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/parent&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>cn.how2j.trend<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>index-turbine<span class="nt">&lt;/artifactId&gt;</span>

    <span class="nt">&lt;dependencies&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-web<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-actuator<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-hystrix<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-hystrix-dashboard<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-turbine<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>

    <span class="nt">&lt;/dependencies&gt;</span>
<span class="nt">&lt;/project&gt;</span>

</code></pre></td></tr></table>
</div>
</div><h3 id="indexturbineapplication">IndexTurbineApplication</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">cn.how2j.trend</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">cn.hutool.core.util.NetUtil</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.autoconfigure.SpringBootApplication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.builder.SpringApplicationBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cloud.netflix.turbine.EnableTurbine</span><span class="o">;</span>

<span class="cm">/**
</span><span class="cm"> * @author qqlin
</span><span class="cm"> * @date 2020-6-16 12:29
</span><span class="cm"> */</span>
<span class="nd">@SpringBootApplication</span>
<span class="nd">@EnableTurbine</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">IndexTurbineApplication</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="n">8080</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">eurekaServerPort</span> <span class="o">=</span> <span class="n">8761</span><span class="o">;</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">NetUtil</span><span class="o">.</span><span class="na">isUsableLocalPort</span><span class="o">(</span><span class="n">eurekaServerPort</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">&#34;检查到端口%d未启用，判断eureka服务器没有启动， 本服务无法使用，故提出%n&#34;</span><span class="o">,</span> <span class="n">eurekaServerPort</span><span class="o">);</span>
            <span class="n">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(!</span><span class="n">NetUtil</span><span class="o">.</span><span class="na">isUsableLocalPort</span><span class="o">(</span><span class="n">port</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">&#34;端口%d被占用了，无法启动%n&#34;</span><span class="o">,</span> <span class="n">port</span><span class="o">);</span>
            <span class="n">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">new</span> <span class="n">SpringApplicationBuilder</span><span class="o">(</span><span class="n">IndexTurbineApplication</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                <span class="o">.</span><span class="na">properties</span><span class="o">(</span><span class="s">&#34;server.port=&#34;</span> <span class="o">+</span> <span class="n">port</span><span class="o">)</span>
                <span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><h3 id="applicationyml-10">application.yml</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yml" data-lang="yml"><span class="k">spring</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">application</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">name</span><span class="p">:</span><span class="w"> </span>index-turbine<span class="w">
</span><span class="w">
</span><span class="w"></span><span class="k">turbine</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">aggregator</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">cluster-config</span><span class="p">:</span><span class="w"> </span>default<span class="w">
</span><span class="w">  </span><span class="k">app-config</span><span class="p">:</span><span class="w"> </span>trend-trading-backtest-service<span class="w"> </span><span class="c"># 配置eureka中的serviceId列表，表明监控哪些服务</span><span class="w">
</span><span class="w">  </span><span class="k">cluster-name-expression</span><span class="p">:</span><span class="w"> </span>new<span class="w"> </span>String(<span class="s2">&#34;default&#34;</span>)<span class="w">
</span><span class="w">
</span><span class="w"></span><span class="k">eureka</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">client</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">service-url</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="k">defaultZone</span><span class="p">:</span><span class="w"> </span>http<span class="p">:</span>//localhost<span class="p">:</span><span class="m">8761</span>/eureka/<span class="w">
</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h2 id="213-运行整个项目">2.13 运行整个项目</h2>
<p><img src="https://stepimagewm.how2j.cn/9883.png" alt="拓扑图点亮    "></p>
<ol>
<li>
<p>eureka-server 开启注册中心</p>
<p>http://localhost:8761/</p>
</li>
<li>
<p>third-part-index-data-project  第三方数据服务</p>
<p>http://127.0.0.1:8090/indexes/codes.json</p>
</li>
<li>
<p>index-gather-store-service 数据采集服务</p>
<p>http://127.0.0.1:8001/getCodes</p>
</li>
<li>
<p>IndexConfigServerApplication 配置服务器</p>
</li>
<li>
<p>IndexCodesApplication 指数代码服务</p>
<p>http://127.0.0.1:8011/codes</p>
</li>
<li>
<p>index-data-service 指数数据服务</p>
<p>http://127.0.0.1:8021/data/000300</p>
</li>
<li>
<p>TrendTradingBackTestServiceApplication 模拟回测服务</p>
</li>
<li>
<p>TrendTradingBackTestViewApplication 模拟回测视图</p>
</li>
<li>
<p>IndexZuulServiceApplication 网关服务</p>
<p>http://127.0.0.1:8031/api-codes/</p>
<p>http://127.0.0.1:8031/api-backtest/</p>
<p>http://127.0.0.1:8031/api-view/</p>
</li>
<li>
<p>java -jar zipkin-server-2.10.1-exec.jar 链路追踪服务（第三方jar包<a href="https://how2j.cn/frontdownload?bean.id=2153">zipkin-server-2.10.1-exec.jar</a>）
java -jar zipkin-server-2.10.1-exec.jar &ndash;zipkin.collector.rabbitmq.addresses=localhost</p>
<p>http://127.0.0.1:8031/api-view/</p>
<p>http://localhost:9411/zipkin/dependency/</p>
</li>
<li>
<p>分布式配置-消息总线 BUS</p>
<p>然后访问地址：</p>
<p>http://127.0.0.1:8031/api-view/</p>
<p>修改github的仓库https://github.com/daniel1n/trendConfig/respo 里面的配置信息</p>
<p>然后运行 FreshConfigUtil类 刷新。</p>
<p>拉到最下面，可以看到这个版权信息刷新了。</p>
</li>
<li>
<p>断路器监控 IndexHystrixDashboardApplication</p>
<p>然后访问地址：</p>
<p>http://localhost:8070/hystrix</p>
<p>输入参数：</p>
<p>http://localhost:8051/actuator/hystrix.stream</p>
</li>
<li>
<p>断路器聚合监控 IndexTurbineApplication</p>
<p>运行 AccessService 类</p>
<p>然后访问地址：</p>
<p>http://localhost:8070/hystrix</p>
<p>输入参数：</p>
<p>http://localhost:8080/turbine.stream</p>
</li>
</ol>
<h1 id="三-总结">三、 总结</h1>
<h2 id="分布式和集群的优缺点">分布式和集群的优缺点</h2>
<p>分布式和集群的优点：</p>
<ol>
<li>分而治之；单个服务功能内聚，复杂性低；方便团队的拆分和管理；</li>
<li>单独部署，独立开发；</li>
<li>增量扩展容易，比如数据微服务不够用了，那么新增一个就可以缓解一定程度的性能压力</li>
<li>各种监控，方便监管</li>
</ol>
<p>分布式和集群的缺点：</p>
<ol>
<li>开发难度大；垮服务的调用通常是不同的机器，甚至是不同的机房，开发人员需要处理超时、网络异常等问题。</li>
<li>效率相对低，团队依赖强，一个服务的版本延迟会拖慢整个应用的开发周期。</li>
<li>分布式部署费心费力，维护成本高</li>
</ol>
<h2 id="微服务的端口">微服务的端口</h2>
<p>微服务的子模块</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-xml" data-lang="xml">	<span class="c">&lt;!--微服务架构下的子项目--&gt;</span>
    <span class="nt">&lt;modules&gt;</span>
        <span class="nt">&lt;module&gt;</span>eureka-server<span class="nt">&lt;/module&gt;</span>
        <span class="nt">&lt;module&gt;</span>third-part-index-data-project<span class="nt">&lt;/module&gt;</span>
        <span class="nt">&lt;module&gt;</span>index-gather-store-service<span class="nt">&lt;/module&gt;</span>
        <span class="nt">&lt;module&gt;</span>index-codes-service<span class="nt">&lt;/module&gt;</span>
        <span class="nt">&lt;module&gt;</span>index-data-service<span class="nt">&lt;/module&gt;</span>
        <span class="nt">&lt;module&gt;</span>index-zuul-service<span class="nt">&lt;/module&gt;</span>
        <span class="nt">&lt;module&gt;</span>trend-trading-backtest-service<span class="nt">&lt;/module&gt;</span>
        <span class="nt">&lt;module&gt;</span>trend-trading-backtest-view<span class="nt">&lt;/module&gt;</span>
        <span class="nt">&lt;module&gt;</span>index-config-server<span class="nt">&lt;/module&gt;</span>
        <span class="nt">&lt;module&gt;</span>index-hystrix-dashboard<span class="nt">&lt;/module&gt;</span>
        <span class="nt">&lt;module&gt;</span>index-turbine<span class="nt">&lt;/module&gt;</span>
    <span class="nt">&lt;/modules&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p>微服务的端口</p>
<blockquote>
<p>eureka-server											 8761</p>
<p>third-part-index-data-project			 8090</p>
<p>index-gather-store-service				  8001</p>
<p>index-codes-service								8011,8012,8013</p>
<p>index-data-service								  8021,8022,8023</p>
<p>index-zuul-service									8031</p>
<p>trend-trading-backtest-view			   8041,8042,8043</p>
<p>trend-trading-backtest-service		  8051,8052,8053</p>
<p>index-config-server					           8060</p>
<p>index-hystrix-dashboard				      8070</p>
<p>index-turbine						                 8080</p>
</blockquote>
<p>第三方工具：</p>
<blockquote>
<p>redis									 6379</p>
<p>zipkin								  9411</p>
<p>rabbitmq							5672</p>
</blockquote>
<h2 id="技术总结">技术总结</h2>
<ol>
<li>Java
Java基础 和 Java中级 的大部分内容</li>
<li>前端
html, CSS, Javascript, JSON, AJAX, JQuery ,Bootstrap, Vue.js ，chartjs</li>
<li>框架部分
spring springmvc springboot</li>
<li>中间件
redis</li>
<li>开发工具
Intellij IDEA,Maven</li>
<li>分布式
SpringCloud</li>
</ol>
<h2 id="个人总结">个人总结</h2>
<ol>
<li>做完整个项目后，大致了解到分布式和集群的项目，是如何开发搭建的</li>
<li>知道如何使用springcloud的相关组件</li>
<li>还可以引入其他关键技术，进而完善整个项目的功能</li>
</ol>

    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/spring-framework/">Spring Framework</a>
          <a href="/tags/springmvc/">SpringMVC</a>
          <a href="/tags/springboot/">springboot</a>
          <a href="/tags/springcloud/">springcloud</a>
          </div>
      <nav class="post-nav">
        
        <a class="next" href="/post/16.springboot2.0-spring-data-jpa-findbyidfindone%E5%92%8Coptionalt%E7%9A%84%E4%BD%BF%E7%94%A8/">
            <span class="next-text nav-default">SpringBoot2.0 (Spring-Data-Jpa) findById(findOne())和Optional&lt;T&gt;的使用</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:492332435@qq.com" class="iconfont icon-email" title="email"></a>
      <a href="https://github.com/daniel1n" class="iconfont icon-github" title="github"></a>
  <a href="https://daniel1n.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv"> site pv: <span id="busuanzi_value_site_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> </span>
      <span class="division">|</span>
    <span id="busuanzi_container_site_uv"> site uv: <span id="busuanzi_value_site_uv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> </span>
  </div>

  <span class="copyright-year">
    &copy; 
    2020
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Daniel1n</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.d7b7ada643c9c1a983026e177f141f7363b4640d619caf01d8831a6718cd44ea.js"></script>








</body>
</html>
